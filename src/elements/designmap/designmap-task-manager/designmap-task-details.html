<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../../plastic/plastic-custom-scroll.html?20170615">
<link rel="import" href="../../plastic/plastic-textarea.html?20170615">
<link rel="import" href="./designmap-assignee.html?20170615">
<link rel="import" href="../designmap-ui/designmap-date-picker.html?20170615">
<link rel="import" href="../designmap-ui/designmap-file-uploader.html?20170615">
<link rel="import" href="../designmap-accesses/designmap-users-select.html?20170615">
<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="./deaignmap-task-service.html?20170615">
<!-- Redux -->
<link rel="import" href="../../../redux/redux-store.html?20170615">
<link rel="import" href="../../../redux/actions/combine-actions.html?20170615">
<link rel="import" href="../../../redux/actions/files-actions.html?20170615">
<link rel="import" href="../../../redux/actions/user-actions.html?20170615">
<link rel="import" href="../../../redux/actions/tasks-actions.html?20170615">
<link rel="import" href="../../../redux/actions/comments-action.html?20170615">

<dom-module id="designmap-task-details">
    <template>
        <style>
            :host {
                margin-top: 33px;
                flex: 1;
                box-sizing: border-box;
                position: relative;
                background: var(--white-color);
                display: flex;
                flex-direction: column;
                overflow: hidden;

                --details-color: var(--gray-saturated-color);

                --details-incomplete: var(--incomplete);
                --details-inprogress: var(--inprogress);
                --details-completed: var(--completed);
                --details-expired: var(--expired);
            }

            *[hidden] {
                display: none !important;
            }

            plastic-custom-scroll {
                flex: 11;
            }

            /** DETAILS **/
            .details {
                width: 100%;
                height: 100%;
            }

            .details .header {
                height: 60px;
                display: flex;
            }

            .details .header > .title {
                width: 50%;
            }

            .details .content {
                display: flex;
            }

            .details .content .left {
                flex: 1;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .details .content .center {
                flex: 11;
                align-items: flex-start;
            }

            /** PANEL **/
            .panel {
                flex: 1;
                display: flex;
                justify-content: flex-end;
                align-items: flex-start;
            }

            .panel designmap-circle-button, designmap-assignee {
                width: 60px;
                height: 60px;
                --designmap-circle-button-circle-mixin: {
                    stroke-width: 1px;
                    stroke: var(--details-color) !important;
                };
            }

            designmap-assignee {
                margin-top: 3px;
                margin-left: 5px;
                --iron-icon-stroke-color: var(--gray-color);
                --iron-icon-fill-color: var(--gray-color);
            }

            /** TYPE COLORS **/

            designmap-assignee {
                --designmap-assignee-assigned-mixin: {
                    width: 45px;
                    height: 45px;
                    margin: 7px 0 5px 5px;
                    border: 2px solid var(--white-color);
                }
            }

            .panel .panel-icon {
                padding: 18px;
            }

            .panel-icon.remove {
                width: 25px;
                height: 25px;
                padding: 17px !important;
            }

            /** CUSTOM SCROLL **/
            :host {
                --plastic-custom-scroll-bar-mixin: {
                    margin-left: -10px;
                };
                --plastic-custom-scroll-bar-hover-mixin: {
                    margin-left: -12px;
                };
                --plastic-custom-scroll-bar-grabbed-mixin: {
                    margin-left: -12px;
                };
            }

            /** DATE PICKER **/
            :host {
                --paper-date-picker: {
                    margin-top: 0px !important;
                    padding: 0;
                }
            }

            /** FILE ATTACH **/

            /** Paper Dialog **/
            paper-dialog#addFileForm {
                color: #fff;
                z-index: 103 !important;
            }

            paper-dialog#addFileForm .content .message {
                padding: 10px;
                font-size: 16px;
            }

            /** ATTACHED FILE LIST **/
            .files {
                padding: 10px 0;
                font-family: 'Open Sans';
                font-weight: 300;
                display: flex;
                margin-top: 9px;
            }

            .files .wrapper {
                margin-top: 1px;
            }

            .remove-file iron-icon {
                width: 18px;
                height: 18px;
                margin-left: 3px;
                position: relative;
                bottom: 1px;
            }

            .files-title {
                font-size: 18px;
            }

            .file {
                font-size: 14px;
            }

            .file-name {
                color: var(--gray-darkend-color);
            }

            .file-name, .remove-file {
                display: inline-block;
                cursor: pointer;
            }

            /** ASSIGNED **/
            .assignee {
                display: flex;
                align-items: center;
            }

            /** BREAD CRUMBS **/
            .breadcrumbs {
                display: block;
                color: var(--gray-darkend-color);
                padding-left: 64px;
                font-weight: 100;
            }

            .crumb {
                display: inline-block;
                vertical-align: middle;
                margin-left: 3px;
            }

            .crumb .title {
                cursor: pointer;
                display: inline-block;
                vertical-align: middle;
                font-size: 17px;
            }

            .crumb .title.selected {
                border-radius: 40px;
                background: var(--blue-color);
                color: var(--white-color);
                padding: 5px 14px;
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            paper-dialog {
                z-index: 2001;
                background: var(--blue-darkest-color) !important;
            }

            paper-dialog .dialog-content {
                color: var(--white-color);
            }

            paper-dialog .dialog-content .name {
                text-align: center;
                font-size: 22px;
                font-family: "Open Sans";
                font-weight: 700;
                padding: 10px 0;
                color: #fff;
            }

            paper-dialog .dialog-content .circle {
                width: 75px;
                height: 75px;
                background: #fff;
                border-radius: 50%;
                display: block;
                margin: 10px auto;
            }

            paper-dialog .dialog-content .circle .folder-wrapper {
                height: 30px;
                width: 50px;
                padding: 24px 13px;
            }

            paper-dialog .dialog-content .circle .folder-wrapper .label {
                height: 2px;
                width: 18px;
                background: #6EBAF9;
            }

            paper-dialog .dialog-content .circle .folder-wrapper .folder {
                height: 28px;
                width: 50px;
                background: #8ECCFF;
            }

            paper-dialog .dialog-content .circle .ext {
                color: #6EBAF9;
                text-align: center;
                font-size: 22px;
                text-transform: uppercase;
                padding: 29px 0;
            }

            paper-dialog .dialog-content .info {
                padding: 10px;
                text-align: center;
            }

            paper-dialog .dialog-content button {
                margin-left: 20px;
            }

            paper-dialog .dialog-content button:first-child {
                margin-left: 0px;
            }

            /** CONFIRMS **/
            paper-dialog .content {
                max-width: 320px;
                margin: 0 !important;
                color: var(--white-color);
                padding: 20px;
                font-size: 16px;
                text-align: center;
                background: #69b3f2;
            }

            paper-dialog .content button {
                display: inline-block;
                width: 150px;
            }

            /** DATE POPUP **/
            #date-button {
                position: relative;
            }

            #date-button:hover .date-popup {
                display: block;
                animation: appearance .3s forwards .3s;
                transition: opacity .3s 1s
            }

            .date-popup {
                z-index: 120;
                opacity: 0;
                display: none;
                position: absolute;
                padding: 20px;
                background: var(--primary-color);
                color: var(--white-color);
                top: 70px;
                width: 76px;
                margin-left: -25px;
                border-radius: 5px;
                transition: opacity .2s
            }

            /** TRI **/
            .triangle {
                position: absolute;
                left: 50%;
                margin-left: -10px;
                top: -10px;
                width: 0;
                height: 0;
                border-style: solid;
                border-width: 0 10px 10px 10px;
                border-color: transparent transparent var(--primary-color) transparent;
            }

            .panel-mobile {
                position: relative;
            }

            .mobile-panel-icon {
                width: 64px;
                height: 64px;
                padding: 0;
            }

            .mobile-panel-icon {
                --iron-icon-components-mixin: {
                    stroke: #69b3f2;
                    stroke-width: 6;
                }
            }

            designmap-context-menu .menu {
                margin: 0;
                padding: 0;
                list-style: none;
                width: 200px;
            }

            designmap-context-menu .menu li {
                padding: 10px;
                text-align: center;
                cursor: pointer;
                font-size: 14px;
                transition: background .2s ease-out;
                color: #fff;
            }

            designmap-context-menu .menu li:hover {
                background: var(--blue-darkest-color);
                transition: background .2s ease-in;
            }

            designmap-context-menu .menu li.disabled {
                opacity: 0.3;
            }

            #datePickerDialog paper-button {
                color: var(--white-color);
            }

            /** SUB TASK **/
            designmap-task-list {
                display: block;
                margin-top: 0px;
                --designmap-task-list-add-task-wrapper-mixin: {
                    padding: 0 65px;
                };
                --designmap-task-list-status-button-mixin: {
                    margin-left: 0px;
                };
                --designmap-task-list-list-mixin: {
                    padding-left: 10px;
                };
                --designmap-task-list-title-mixin: {
                    margin-left: 6px;
                };
                --designmap-task-list-add-input-mixin: {
                    margin-top: 0px;
                    margin-left: 0px;
                }
            }

            /** INPUTS **/

            .pure-input {
                font-family: var(--font-family);
                font-weight: 100;
                font-size: 34px;
                color: var(--gray-darky-color);
                border: none;
                outline: none;
                margin-top: 10px;
                width: 100%;
            }

            .pure-textarea {
                margin-bottom: 5px;
                --plastic-textarea-mixin: {
                    margin-left: 67px;
                    font-family: var(--font-family);
                    color: var(--gray-darky-color);
                    max-width: calc(100% - 90px);
                    font-weight: 100;
                    font-size: 18px;
                }
            }

            /** STATUSES **/
            .details.completed .pure-input {
                color: var(--details-completed)
            }

            .details.expired .pure-input {
                color: var(--details-expired)
            }

            .details.incomplete .pure-input {
                color: var(--details-incomplete)
            }

            .details.in_progress .pure-input {
                color: var(--details-inprogress)
            }

            #datePickerDialog paper-button {
                color: var(--white-color);
            }

            .paper-clip {
                width: 40px;
                height: 40px;
            }

            @keyframes appearance {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            designmap-assignee.mobile {
                --designmap-assignee-assigned-mixin: {
                    width: 40px;
                    height: 40px;
                };
                --designmap-assignee-empty-mixin: {
                    width: 60px;
                    height: 60px;
                    position: relative;
                    right: 13px;
                    bottom: 12px;
                }
            }

            .hidden-lg {
                display: none;
            }

            /** Comments **/
            .comments {
                position: relative;
                flex: 1;
                border-top: 1px dashed var(--gray-darkend-color);
                min-height: 60px;
                display: flex;
                padding: 10px 0 0 20px;
            }

            .field {
                width: 100%;
            }

            .comments .add-comment {
                margin-left: 15px;
                width: calc(100% - 40px);
                --plastic-textarea-mixin: {
                    font-family: var(--font-family);
                    color: var(--gray-darky-color);
                    font-weight: 100;
                    font-size: 16px;
                }
            }

            .comment-arrow {
                position: absolute;
                left: 100%;
                margin-left: -40px;
                top: 7px;
                cursor: pointer;
            }

            .comment-arrow iron-icon {
                --iron-icon-stroke-color: var(--gray-super-dark);
                --iron-icon-fill-color: var(--gray-super-dark);
            }

            .comments-list {
                margin: 20px 0 0 0;
                padding: 0 0 0 20px;
                list-style: none;
                color: var(--gray-darkend-color);
            }

            .comments-list li {
                padding: 5px 0;
                display: flex;

            }

            .comments-list li designmap-avatar-projector {
                min-width: 30px;
            }

            .comments-list li .text {
                margin-left: 10px;
                padding-right: 20px;

            }

            .comments-list li .text .content {
                white-space: pre-line;
                position: relative;
            }

            .comments-list li .text .content .comment-arrow {
                top: -25px;
                margin-left: -25px;
            }

            .comments-list .panel {
                margin-right: 15px;
            }

            .comments-list .panel .like {
                display: inline-block;
                cursor: pointer;
            }

            .comments-list .panel iron-icon {
                cursor: pointer;
            }

            .comments-list .panel .heart {
                width: 14px;
                height: 14px;
            }

            .comments-list .panel .likesCount {
                font-size: 10px;
            }

            .more {
                position: relative;
                top: 2px;
                --iron-icon-components-mixin: {
                    stroke-width: 4px;
                    r: 3px;
                };
            }

            .reply {
                width: 16px;
                height: 16px;
                margin-right: 5px;
                position: relative;
                top: 5px;
            }

            .comment-edit {
                border: none;
                font-size: 16px;
                padding: 0;
                width: 100%;
                color: var(--gray-darkend-color);
                resize: none;
                font-weight: 100;
                outline: none;
                line-height: 24px;
                font-family: 'Open Sans', 'Noto', sans-serif;
            }

            /** INVOCATION **/
            .invocation {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 9999;
                width: 230px;
                color: var(--gray-darkend-color);
            }

            designmap-users-select {
                height: 0;
            }

            /** MENU DROPDOWN **/
            designmap-dropdown {
                z-index: 1001;
                --designmap-dropdown-triangle-mixin: {
                    margin-left: 32px;
                };
                --designmap-dropdown-triangle-border-mixin: {
                    border-color: transparent transparent var(--gray-color) transparent;
                    margin-left: 30px;
                    top: -12px;
                }
            }

            designmap-dropdown .menu {
                margin: 0;
                padding: 0;
                list-style: none;
                color: var(--gray-darky-hovered-color);
                text-align: center;
                font-size: 12px;
                font-weight: 100;
            }

            designmap-dropdown .menu li {
                padding: 6px 0;
                cursor: pointer;
                transition: .2s background;
            }

            designmap-dropdown .menu li:hover {
                background: var(--gray-lightern-color);
                transition: .2s background;
            }

            @media (min-width: 320px) and (max-width: 768px) {
                .hidden-xs {
                    display: none;
                }

                .hidden-lg {
                    display: block;
                }

                designmap-assignee {
                    width: 42px;
                    height: 42px;
                    margin-left: 18px;
                    margin-top: 14px;
                }

                .pure-input {
                    margin-left: 5px;
                    max-width: calc(100% - 10px);
                }

                .pure-textarea {
                }

                iron-icon.more-icon {
                    width: 50px;
                    height: 50px;
                    padding: 13px !important;
                }

                paper-dialog {
                    max-width: 300px !important;
                    max-height: 475px !important;
                    top: 52px !important;
                }
            }

        </style>
        <plastic-custom-scroll id="scroller" fit small-bar max-height="[[maxHeight]]">
            <div class$="details [[computeAssigneeStatus(task)]]" hidden$="{{!computeSelected(task)}}">
                <div class="content">
                    <div class="left">
                        <designmap-assignee id="assignee" horizontal-offset="-165" vertical-offset="65"
                                            class$="[[computeAssigneeStatus(task)]] [[_isMobileClass(MQ)]]"
                                            disabled="[[!canUpdateTask(task)]]" task="[[task]]"
                                            assignee="[[task.assignee]]" on-assign="selectAssignee"
                                            on-remove="removeAssignee"></designmap-assignee>
                    </div>
                    <div class="center" id="center">
                        <!-- TITLE -->
                        <input id="title" is="iron-input"
                               on-blur="saveTitle"
                               class="pure-input"
                               placeholder="[[translate('Enter title',language,i18Loaded)]]"
                               value="[[task.name]]"/>
                        <!-- FILES -->
                        <!--<div class="files" hidden$="[[!tasksFiles.length]]">
                            <iron-icon class="paper-clip" icon="designmap:paper-clip"></iron-icon>
                            <div class="wrapper">
                                <template is="dom-repeat" items="[[tasksFiles]]" as="file">
                                    <div class="file">
                                        <a class="file-name" href="[[file.data.url]]" target="_blank">[[cutFileName(file)]]</a>
                                        <div class="remove-file" on-click="openRemoveFileConfirm">
                                            <iron-icon icon="designmap-task-manager:remove"></iron-icon>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>-->
                        <!-- FILES -->
                    </div>
                    <div class="panel">
                        <designmap-circle-button id="date-button" class="hidden-xs" hidden$="[[!canUpdateTask(task)]]"
                                                 on-click="openDatePicker">
                            <iron-icon class="panel-icon" icon="designmap-task-manager:date"></iron-icon>
                            <div class="date-popup">
                                [[formatDate(date)]]
                                <div class="triangle"></div>
                            </div>
                        </designmap-circle-button>
                        <designmap-circle-button class="hidden-xs"
                                                 hidden$="[[!canUpdateTask(task)]]"
                                                 on-click="openAddFileForm">
                            <iron-icon class="panel-icon" icon="designmap-task-manager:attach_file"></iron-icon>
                        </designmap-circle-button>
                        <designmap-circle-button class="hidden-xs"
                                                 hidden$="[[!canUpdateTask(task)]]"
                                                 on-click="openRemoveTaskConfirm">
                            <iron-icon class="panel-icon remove" icon="designmap-task-manager:remove"></iron-icon>
                        </designmap-circle-button>

                        <iron-icon on-click="openContextMenu" class="panel-icon hidden-lg more-icon"
                                   icon="designmap-workspace:more"></iron-icon>
                        <!-- Mobile Context menu -->
                        <designmap-context-menu id="contextMenu" previous width="150">
                            <ul class="menu">
                                <li on-click="openDatePicker">
                                    <i18-n msgid="Due date">Due date</i18-n>
                                </li>
                                <li on-click="openAddFileForm">
                                    <i18-n msgid="Upload file">Upload file</i18-n>
                                </li>
                                <li on-click="openRemoveTaskConfirm">
                                    <i18-n msgid="Remove">Remove</i18-n>
                                </li>
                            </ul>
                        </designmap-context-menu>
                    </div>
                </div>
                <div class="second-line">
                    <!-- DESC -->
                    <plastic-textarea id="desc" class="pure-textarea"
                                      on-change="_descChange"
                                      on-blur="saveDesc" value="[[task.description]]"
                                      placeholder="[[translate('Enter description',language,i18Loaded)]]"></plastic-textarea>
                </div>
                <div class="third-line">
                    <!-- BREADCRUMBS -->
                    <div class="breadcrumbs hidden-xs" hidden$="[[!breadcrumbs.length]]">
                        <template is="dom-repeat" items="[[breadcrumbs]]" as="crumb">
                            <div class="crumb" title="[[crumb.title]]">
                                <div class$="title [[calculateSelectedCrumb(breadcrumbs.length,index)]]"
                                     on-click="goToParent">[[crumb.title]]
                                </div>
                                <iron-icon hidden$="[[hideLine(breadcrumbs.length,index)]]" class="arrow"
                                           icon="designmap:arrow"></iron-icon>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- SUB TASKS -->
                <div class="sub-tasks">
                    <designmap-task-list id="list" placeholder="Add subtask" cannot-add="[[!canUpdateTask(task)]]"
                                         parent="[[task._id]]" no-scroll></designmap-task-list>
                </div>
                <!-- Comments list -->
                <ul class="comments-list">
                    <template is="dom-repeat" items="[[_getComments(task._id,comments.*)]]" as="comment">
                        <li>
                            <designmap-avatar-projector user="[[comment.owner]]"></designmap-avatar-projector>
                            <div class="text">
                                <div class="head">
                                    <strong>[[computeOwnerName(comment.owner)]]</strong>
                                    &nbsp;
                                    (
                                    <small>[[_getDate(comment.created)]]</small>
                                    )
                                </div>
                                <div class="content">
                                    <template is="dom-if" if="[[!comment.edit]]">
                                        <div class="comment-text">[[comment.text]]</div>
                                    </template>
                                    <template is="dom-if" if="[[comment.edit]]">
                                        <textarea on-blur="_saveComment" value="[[comment.text]]"
                                                  class="comment-edit"></textarea>
                                        <div class="comment-arrow" on-tap="_saveComment">
                                            <iron-icon icon="icons:arrow-forward"></iron-icon>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="panel">
                                <iron-icon on-tap="_reply" hidden$="[[_hideForMySelf(user,comment)]]" class="reply"
                                           icon="icons:reply"></iron-icon>
                                <div class="like" on-tap="_like">
                                    <iron-icon class="heart"
                                               icon="icons:favorite-border"></iron-icon>
                                    <span class="likesCount">[[_computeLikesCount(comment.likes.length)]]</span>
                                </div>
                                <iron-icon on-tap="_openDropdown" class="more"
                                           icon="designmap-workspace:more"></iron-icon>
                            </div>
                        </li>
                    </template>
                </ul>
                <!-- Comments list Dropdown-->
                <designmap-dropdown id="dropdown" class="bound" vertical-offset="30" horizontal-offset="-100" previous
                                    tri-border>
                    <ul class="menu">
                        <li on-tap="_editComment">
                            <i18-n class="bound" msgid="Edit">Edit</i18-n>
                        </li>
                        <li on-tap="_removeComment">
                            <i18-n class="bound" msgid="Remove">Remove</i18-n>
                        </li>
                    </ul>
                </designmap-dropdown>
            </div>
        </plastic-custom-scroll>
        <!-- Invoked -->
        <div class="invoked" hidden$="[[!invokedUsers.length]]">
                                <span id="invoked-count" class="invoked-count">
                                    [[invokedUsers.length]]
                                </span>
            <paper-tooltip grayder for="invoked-count">[[_getInvokedUsersList(invokedUsers)]]</paper-tooltip>
            <span>
                                    <i18-n msgid="persons">persons</i18-n>
                                </span>
            <span>
                                     <i18-n msgid="will be notified">will be notified</i18-n>
                                </span>
        </div>
        <div id="comments" class="comments">
            <designmap-avatar-projector user="[[user]]"></designmap-avatar-projector>
            <div class="field">
                <plastic-textarea id="commentTextarea" on-change="_commentChange" class="add-comment"
                                  placeholder="[[translate('Add a comment',language,i18Loaded)]]"></plastic-textarea>
            </div>
            <div class="comment-arrow" hidden$="[[!commentText]]" on-tap="_postComment">
                <iron-icon icon="icons:arrow-forward"></iron-icon>
            </div>
            <!-- Invocation dropdown -->
            <div id="invocationDropDown" class="invocation">
                <designmap-users-select id="select" on-close="_closeInvocationDropDown" on-selected="userSelect"
                                        dishonred options="[[projectUsers]]" search="{{search}}"
                                        limit="5"></designmap-users-select>
        </div>

        </div>
        <!-- Date Picker -->
        <paper-dialog id="datePickerDialog"
                      entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-date-picker id="datePicker" locale="[[language]]" min-date="April 1, 1990"
                                   max-date="April 1, 2030" force-narrow id="picker"
                                   date="{{date}}"></designmap-date-picker>
            <div class="buttons">
                <paper-button dialog-dismiss>
                    <i18-n msgid="Cancel">Cancel</i18-n>
                </paper-button>
                <paper-button dialog-confirm>
                    <i18-n msgid="Select" on-tap="saveDate">Select</i18-n>
                </paper-button>
            </div>
        </paper-dialog>
        <!-- Confirm -->
        <designmap-confirm id="removeFileConfirm" animation-on="[[user.config.animationOn]]"
                           message="AreYouSureThatYouWannaRemoveFile" on-continue="removeFile"
                           on-suspend="suspendRemoving"></designmap-confirm>
        <!-- Confirm -->
        <designmap-confirm id="removeTaskConfirm" animation-on="[[user.config.animationOn]]"
                           message="AreYouSureThatYouWannaRemoveTask" on-continue="removeTask"
                           on-suspend="suspendRemoving"></designmap-confirm>
    </template>
    <script>
        const offset = 230;
        const INVOCATION_REGEXP = /(^@([\w\S]*)$| @([\w\S]*)$|\n@([\w\S\s]*)$)/;
        Polymer({
            is: 'designmap-task-details',
            behaviors: [ReduxBehavior,
                Polymer.IronResizableBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapTaskService,
                Polymer.DesignMapFsService,
                Polymer.CombineActions(Polymer.TasksActions, Polymer.FilesActions, Polymer.CommentsActions)],
            properties: {
                /**
                 * Task data
                 */
                task: {
                    type: Object,
                    value: null,
                    observer: 'taskChanged'
                },
                /**
                 * Date
                 */
                date: {
                    type: Date,
                    notify: true
                },
                /**
                 * User language
                 */
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                /**
                 * i18Loaded
                 */
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                /**
                 * All files of project bound
                 * to current project
                 */
                files: {
                    type: Array,
                    statePath: 'files',
                    observer: 'filesChanged'
                },
                /**
                 * Files of current task
                 */
                /*tasksFiles: {
                 type: Array,
                 value: []
                 },*/
                /**
                 * Breadcrumbs
                 */
                breadcrumbs: {
                    type: Array,
                    value: []
                },
                /**
                 * Designmap user
                 */
                user: {
                    type: Object,
                    statePath: 'user'
                },
                /**
                 * Role of current user
                 */
                role: {
                    type: Object,
                    statePath: 'role'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projectId: {
                    type: Object,
                    statePath: 'projectId'
                },
                wrapper: {
                    type: Object,
                    value: function () {
                        return this.$.wrapper
                    }
                },
                maxHeight: {
                    type: Number,
                    value: function () {
                        return window.innerHeight - offset;
                    }
                },
                MQ: {
                    type: String,
                    statePath: 'MQ'
                },
                comments: {
                    type: Array,
                    statePath: 'comments'
                },
                projectUsers: {
                    type: Array,
                    statePath: function (state) {
                        return state.projectUsers.filter(function (user) {
                            if (!this.user) return true;
                            return user._id !== this.user._id;
                        }.bind(this));
                    }
                },
                invokedUsers: {
                    type: Array,
                    value: []
                }
            },
            listeners: {
                'iron-resize': 'onIronResize'
            },
            ready: function () {
                this.notifier = document.querySelector('designmap-notifier');
                this.manager = document.querySelector('designmap-task-manager');
                if (this.MQ == 'sm') this.$.assignee.classList.add('mobile');
                this.INVOCATION_REGEXP = /(^@([\w\S]*)$| @([\w\S]*)$|\n@([\w\S]*)$)/;
                this.SYMBOL_REGEXP = /[ ]*/;
            },
            _isMobileClass: function (MQ) {
                this.async(function () {
                    this.updateStyles();
                });
                return MQ == 'sm' ? 'mobile' : 'desktop';
            },
            attached: function () {
                this.$.scroller.calculate();
                this.async(function () {
                    this.onIronResize();
                    this.$.scroller.calculate();
                }, 500);
            },
            /**
             * When task was changed we have to
             * change some additional data
             * @param task - new task
             */
            taskChanged: function (task) {
                //this.tasksFiles = this.getTasksFiles();
                if (this.$.datePicker && this.task && this.task.expired) this.date = new Date(this.task.expired);
                this.set('breadcrumbs', []);
                this.calculateBreadCrumbs();
            },
            /**
             * Breadcrumbs will be calculated
             * using parent path of all tasks before
             * basic
             */
            calculateBreadCrumbs: function () {
                if (!this.task) return;
                var task = this.task;
                while (task.parent) {
                    task = this.findTaskById(task.parent);
                    this.unshift('breadcrumbs', {id: task._id, title: task.name});
                }
                if (this.breadcrumbs.length) this.push('breadcrumbs', {id: this.task._id, title: this.task.name});
            },
            /**
             * When project's files was changed -
             * update tasks files
             */
            filesChanged: function () {
                this.tasksFiles = this.getTasksFiles();
            },
            /**
             * Save title
             * @param e
             */
            saveTitle: function (e) {
                if (!this.canUpdateTask(this.task)) {
                    this.$.title.value = this.task.name;
                    return this.showErrorMessage('You do not have access to make it');
                }
                if (!this.$.title.value) {
                    this.$.title.value = this.task.name;
                    return this.showErrorMessage('Task title should be not empty');
                }
                if (!this.validate(this.$.title.value)) {
                    this.$.title.value = this.task.name;
                    return this.showErrorMessage('Task title should be unique');
                }
                this.dispatch('$updateTask', this.task._id, {name: this.$.title.value})
            },
            /**
             * Validate name of future task
             * @returns {boolean}
             */
            validate: function (title) {
                var found = null;
                if (this.task.name == title) return true;
                this.findTaskOneLevel(this.task.path).forEach(function (task) {
                    if (task.name == title) found = task;
                }.bind(this));
                return !found;
            },
            /**
             * Save description
             * @param e
             */
            saveDesc: function (e) {
                var val = this.$.desc.$.textarea.value;
                if (!this.canUpdateTask(this.task)) {
                    this.$.desc.$.textarea.value = this.task.description;
                    return this.showErrorMessage('You do not have access to make it');
                }
                this.dispatch('$updateTask', this.task._id, {description: val}).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot save description');
                    //this.showMessage('Description has been saved!');
                }.bind(this));
            },
            /**
             * Save date
             * @param e
             */
            saveDate: function (e) {
                if (this.$.contextMenu) this.$.contextMenu.close();
                this.dispatch('$updateTask', this.task._id, {expired: this.$.datePicker.dateFormat(this.date)});
            },
            /**
             * Select new assignee to current task
             * @param e
             */
            selectAssignee: function (e) {
                if (!e.detail || !e.detail._id) return;
                if (!this.canUpdateTask(e.detail.task)) return this.showErrorMessage('You do not have access to change status of this task.');
                this.dispatch('$updateTask', this.task._id, {assignee: e.detail._id});
                // Notify but do not do this if for itseld
                if (e.detail._id == this.user._id) return;
                this.sendNotification(e.detail.task, e.detail._id);
            },
            /**
             * Send notification
             */
            sendNotification: function (task, assigneeID) {
                var pth = this.getFullPath(task);
                this.notifier = this.notifier || document.querySelector('designmap-app').$.notifier;
                this.notifier.create({
                    sender: this.user._id,
                    recipient: assigneeID,
                    type: 'new-assignee',
                    text: {
                        message: 'You was assigned to task', replacement: {"#TASK#": task.name},
                        info: {
                            xlink: this.getAppUrl() + this.project._id + '/task-manager' + pth,
                            project: this.project.name
                        }
                    }
                });
            },
            /**
             * Remove assignee of curren task
             * @param e
             */
            removeAssignee: function (e) {
                if (!e.detail || !e.detail.task) return;
                this.dispatch('$updateTask', e.detail.task._id, {assignee: null});
            },
            /**
             * Remove task
             * @param e
             */
            removeTask: function (e) {
                var task = Object.assign({}, this.task);
                this.dispatch('$removeTask', this.task._id).then(function () {
                    if (task.parent) return this.fire('select-task', this.findTaskById(task.parent));
                    if (this.MQ != 'sm') {
                        this.fire('reset');
                    }
                }.bind(this));
                if (this.$.removeTaskConfirm) this.$.removeTaskConfirm.close();

                if (this.MQ != 'sm') {
                    if (task.parent) return this.fire('select-task', this.findTaskById(task.parent));
                    return this.fire('reset');
                }
                this.fire('mobile-go-back');
            },
            /**
             * Download file
             * @param e
             */
            downloadFile: function (e) {
                this.quickUpload(e.model.file.data.url);
            },
            /**
             * Remove file
             * @param e
             */
            removeFile: function () {
                this.dispatch('removeFile', this.fileToRemove._id).then(function (response) {
                    this.showMessage('File was removed successfuly.');
                }.bind(this));
                this.$.removeFileConfirm.close();

            },
            /**
             * Change status of current task
             */
            /* changeStatus: function(){
             if(this.isExpired(this.task.expired)) return;
             var status = STATUSES[STATUSES.indexOf(this.task.status)+1] || STATUSES[0];
             this.dispatch('updateTask', this.task._id,{status:status});
             },*/
            /**
             * Redirect parent task
             * @param e
             */
            goToParent: function (e) {
                this.fire('select-task', this.findTaskById(e.model.crumb.id))
            },
            computeSelected: function (task) {
                return !!(task && task._id);
            },
            /**
             * Compute icon
             * @param type - task status
             * @param expired - task expired time
             * @returns {*}
             */
            computeIcon: function (type, expired) {
                var diff = moment.duration(moment(expired || moment()).diff(moment()));
                if (diff._milliseconds < 0) return 'designmap-task-manager:expired';
                return 'designmap-task-manager:' + type;
            },
            /**
             * Checking of expired date
             * @param expired - expired date
             * @returns {boolean}
             */
            isExpired: function (expired, status) {
                var diff = moment.duration(moment(expired).diff(moment()));
                return diff._milliseconds < 0 && status != 'completed';
            },
            /**
             * Open date picker
             */
            openDatePicker: function () {
                this.$.datePickerDialog.open();
                this.async(function () {
                    this.$.datePicker.$.calendar._resizeHandler();
                }, 0);
            },
            /**
             * Attach file form
             */
            openAddFileForm: function () {

            },
            /**
             * Files of current task
             * @returns {*}
             */
            getTasksFiles: function () {
                return this.files && this.task ? this.files.filter(function (file) {
                        return file.task == this.task._id;
                    }.bind(this)) : [];
            },
            hideLine: function (length, index) {
                return (length - 1) == index;
            },
            calculateSelectedCrumb: function (length, index) {
                return (length - 1) == index ? 'selected' : '';
            },
            focusInput: function () {
                this.$.list.$$('#addTask').focus();
            },
            openRemoveFileConfirm: function (e) {
                this.$.contextMenu.close();
                this.fileToRemove = e.model.file;
                this.$.removeFileConfirm.toggle();
            },
            openRemoveTaskConfirm: function (e) {
                this.$.contextMenu.close();
                this.$.removeTaskConfirm.toggle();
            },
            suspendRemoving: function () {
                this.$.removeFileConfirm.close();
                this.$.removeTaskConfirm.close();
            },
            openContextMenu: function (e) {
                if (!this.canUpdateTask(this.task)) return;
                this.$.contextMenu.toggle(e);
            },
            computeAssigneeStatus: function (task) {
                return task ? this.isExpired(task.expired, task.status) ? 'expired' : task.status : '';
            },
            onIronResize: function () {
                //this.$.center.style.width = this.$.center.getBoundingClientRect().width - 250 + 'px';
                this.async(function () {
                    this.maxHeight = window.innerHeight - offset;
                    this.$.scroller.calculate();
                });
            },
            _descChange: function () {
                this.maxHeight = this.maxHeight = window.innerHeight - offset;
                this.$.scroller.calculate();
            },
            _commentChange: function (e) {
                // Notify users
                this._invocation(e.detail);
                // Work further
                const textarea = e.detail.target;
                this.commentText = textarea.value;
                const bound = textarea.getBoundingClientRect();
                if (bound.height > 60) {
                    return this.async(function () {
                        this.$.comments.style.minHeight = bound.height + 10 + 'px';
                        this.maxHeight = window.innerHeight - (230 + bound.height - 55);
                    }, 0);
                }
                this.async(function () {
                    this.$.comments.style.minHeight = 45 + 'px';
                    this.maxHeight = window.innerHeight - offset;
                }, 0);
            },
            _postComment: function () {
                if (!this.commentText.trim()) return false;
                const comment = {
                    text: this.commentText,
                    owner: this.user,
                    task: this.task._id,
                    project: this.projectId
                };
                this.dispatch('addComment', comment);
                this.textAreaValue = '';
            },
            _getComments: function (id) {
                return this.comments.filter(function (comment) {
                    return comment.task == id;
                });
            },
            _hideForMySelf: function (user, comment) {
                return user && user._id == comment.owner._id;
            },
            _computeLikesCount: function (length) {
                return length ? '+' + length : '';
            },
            _like: function (e) {
                let comment = e.model.comment;

                comment.likes = comment.likes || [];
                const isThereUser = comment.likes.indexOf(this.user._id) != -1;
                const userLikesIndex = comment.likes.indexOf(this.user._id);
                isThereUser ? comment.likes.splice(userLikesIndex, 1) : comment.likes.push(this.user._id);
                this.dispatch('updateComment', comment._id, comment);
            },
            _openDropdown: function (e) {
                this.commentNode = e.target.parentNode.previousElementSibling;
                this.lastComment = e.model.comment;
                this.canUpdateAndRemove = this._canUserManageComment(this.task, e.model.comment);

                this.$.dropdown.target = e.target;
                this.$.dropdown.open();
            },

            _canUserManageComment(task, comment){
                return (comment.owner._id === this.user._id);
            },

            _removeComment(){
                this.$.dropdown.close();
                if (!this.lastComment) return this.showErrorMessage('Something went wrong!');
                this.dispatch('removeComment', this.lastComment._id);
            },

            _editComment: function () {
                let comment = Object.assign({}, this.lastComment);
                const commentTextBound = this.commentNode.querySelector('.comment-text').getBoundingClientRect();
                comment.edit = true;
                this.dispatch('_updateComment', comment._id, comment);
                this.$.dropdown.close();
                // Dims of textarea
                this.async(function () {
                    const textarea = this.commentNode.querySelector('.comment-edit');
                    textarea.style.height = commentTextBound.height + 'px';
                    textarea.focus();
                }.bind(this), 5);
            },

            _saveComment: function () {
                let comment = Object.assign({}, this.lastComment);
                const textarea = this.commentNode.querySelector('.comment-edit');
                comment.edit = false;
                comment.text = textarea.value;
                this.dispatch('updateComment', comment._id, comment);
            },

            _getDate: function (date) {
                moment.locale(this.language);
                return moment(date).format('MM-DD-YYYY HH:mm:ss');
            },

            _invocation: function (e) {
                this.async(this.resolveInvokedUsers);
                const value = e.target.value;
                if (!this.INVOCATION_REGEXP.test(value)) {
                    this.$.invocationDropDown.style.display = 'none';
                    this.$.invocationDropDown.classList.remove('opened');
                    return this.$.select.$.dropdown.close();
                }
                const matches = value.match(this.INVOCATION_REGEXP);
                tempSearch = matches[1];
                this.search = matches[2] || matches[3] || matches[4] || "";
                const textarea = e.target;
                this.async(function(){
                    const cords = window.getCaretCoordinates(textarea, textarea.selectionEnd);
                    this.$.invocationDropDown.style.display = 'block';
                    this.$.invocationDropDown.classList.add('opened');
                    this.$.invocationDropDown.style.left = cords.left + 65 + 'px';
                    this.$.invocationDropDown.style.top = cords.top - 45 + 'px';
                    this.$.select.openDropdown();
                    this.async(function(){
                        const bound = this.$.select.$.dropdown.getBoundingClientRect();
                        this.$.select.$.dropdown.style.marginTop = -bound.height + "px";
                    },5);
                }.bind(this),10)
            },

            resolveInvokedUsers: function () {
                const users = [];
                this.projectUsers.forEach(function (user) {
                    const regExpStr = user.profile && user.profile.name ? '@' + user.profile.name : "\\+" + user.local.email;
                    const regExp = new RegExp(regExpStr, 'i');
                    if (regExp.test(this.commentText)) users.push(user);
                }.bind(this));
                this.set('invokedUsers', users);
            },

            _getInvokedUsersList: function () {
                return this.invokedUsers.map(function (user) {
                    return user.profile && user.profile.name ? user.profile.name : user.local.email;
                }).join('; ');
            },

            _closeInvocationDropDown: function () {
                this.$.invocationDropDown.style.display = 'none';
            },

            userSelect: function (e) {
                this.$.select.$.dropdown.close();
                const user = e.detail;
                if(!user) return;
                if (this.user.local.email == user.local.email) return this.showErrorMessage('You cannot notify yourself');
                const replacement = user.profile&&user.profile.name?'@'+user.profile.name+' ':"+" + user.local.email + " ";
                let value = this.$.commentTextarea.$.textarea.value;
                this.$.commentTextarea.$.textarea.value = value.replace(new RegExp(tempSearch.replace(this.SYMBOL_REGEXP, '') + "$", 'i'), replacement);
                this.$.commentTextarea.$.textarea.focus();
                this.commentText =  this.$.commentTextarea.$.textarea.value;
                this.resolveInvokedUsers();

            },
        })
    </script>
</dom-module>
