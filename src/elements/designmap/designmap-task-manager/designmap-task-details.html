<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="../../plastic/plastic-custom-scroll.html">
<link rel="import" href="../../plastic/plastic-textarea.html">
<link rel="import" href="../../plastic/plastic-html.html">

<link rel="import" href="./designmap-assignee.html">
<link rel="import" href="./designmap-task-manager-labels.html">
<link rel="import" href="./designmap-task-estimate.html">
<link rel="import" href="./designmap-task-comments.html">
<link rel="import" href="./designmap-task-info.html">
<link rel="import" href="./designmap-task-menu.html">
<link rel="import" href="./designmap-task-comment-list.html">

<link rel="import" href="../../../styles/tooltip-shared-styles.html">

<link rel="import" href="./deaignmap-task-service.html">
<link rel="import" href="./designmap-task-track-time-service.html">
<link rel="import" href="./designmap-task-notify-service.html">

<link rel="import" href="../../../redux/redux-store.html">
<link rel="import" href="../../../redux/actions/combine-actions.html">
<link rel="import" href="../../../redux/actions/files-actions.html">
<link rel="import" href="../../../redux/actions/user-actions.html">
<link rel="import" href="../../../redux/actions/tasks-actions.html">
<link rel="import" href="../../../redux/actions/comments-action.html">

<dom-module id="designmap-task-details">
    <template>
        <style include="tooltip-shared-styles">
            :host {
                box-sizing: border-box;
                position: relative;
                background: var(--white-color);

                display: flex;
                flex-direction: column;
                flex-grow: 1;
                overflow: hidden;

                --details-color: var(--gray-saturated-color);

                --details-incomplete: var(--incomplete);
                --details-inprogress: var(--inprogress);
                --details-completed: var(--completed);
                --details-expired: var(--expired);

                --plastic-custom-scroll-bar-mixin: {
                    margin-left: -10px;
                };
                --plastic-custom-scroll-bar-hover-mixin: {
                    margin-left: -12px;
                };
                --plastic-custom-scroll-bar-grabbed-mixin: {
                    margin-left: -12px;
                };
            }

            *[hidden] {
                display: none !important;
            }

            /** DETAILS **/
            .details {
                width: 100%;
            }

            #scroller {
                flex: 2;
                overflow: auto;
                display: block;
            }

            /** Panel **/

            .details .panel {
                display: flex;
            }

            .details .panel .left {
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .details .panel .center {
                display: flex;
                align-items: center;
                flex: 11;
                max-width: calc(100% - 125px);
            }

            .panel .right designmap-circle-button, designmap-assignee {
                width: 55px;
                height: 55px;
                --designmap-circle-button-circle-mixin: {
                    stroke-width: 1px;
                    stroke: var(--details-color) !important;
                };
            }

            /** Assignee **/
            designmap-assignee {
                width: 60px;
                height: 60px;
                margin-left: 10px;
                --iron-icon-stroke-color: var(--gray-color);
                --iron-icon-fill-color: var(--gray-color);
                --designmap-assignee-assigned-mixin: {
                    width: 45px;
                    height: 45px;
                    margin: 5px 0 5px 5px;
                    border: 2px solid var(--white-color);
                };
            }

            /** Title -input **/

            .task-title-input, .task-title {
                font-family: var(--font-family);
                font-weight: 300;
                font-size: 34px;
                color: var(--gray-darky-color);
                border: none;
                outline: none;
                width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .task-title-input.edit {
                position: relative;
                top: 1px;
                border-bottom: 1px solid var(--gray-saturate-color);
            }

            .task-title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .title-edit-arrow {
                width: 50px;
                height: 50px;
                position: relative;
                top: 2px;
                --iron-icon-fill-color: var(--gray-saturate-color);
            }

            /** PANEL **/
            .panel .right {
                flex: 1;
                display: flex;
                justify-content: flex-end;
                align-items: flex-start;
                margin-top: 3px;
            }

            .panel-icon.remove {
                width: 25px !important;
                height: 25px !important;
                padding: 15px !important;
            }

            .grid {
                display: flex;
                justify-content: space-between;
            }
            .grid .left {
                flex: 2;
            }
            .grid .right {
                flex: 1;
                max-width: 175px;
            }

            designmap-task-menu {
                margin-top: 10px;
            }

            /** STATUSES **/
            .details.completed .task-title-input, .details.completed .task-title {
                color: var(--details-completed)
            }
            .details.completed .task-title-input.edit {
                border-bottom: 2px solid var(--details-completed);
            }
            .details.completed .title-edit-arrow {
                --iron-icon-fill-color: var(--details-completed);
            }

            .details.expired .task-title-input, .details.expired .task-title {
                color: var(--details-expired)
            }
            .details.expired .task-title-input.edit {
                border-bottom: 2px solid var(--details-expired);
            }
            .details.expired .title-edit-arrow {
                --iron-icon-fill-color: var(--details-expired);
            }

            .details.incomplete .task-title-input, .details.incomplete .task-title {
                color: var(--details-incomplete)
            }
            .details.incomplete .task-title-input.edit {
                border-bottom: 2px solid var(--details-incomplete);
            }
            .details.incomplete .title-edit-arrow {
                --iron-icon-fill-color: var(--details-incomplete);
            }

            .details.in_progress .task-title-input, .details.in_progress .task-title {
                color: var(--details-inprogress)
            }
            .details.in_progress .task-title-input.edit {
                border-bottom: 2px solid var(--details-inprogress);
            }
            .details.in_progress .title-edit-arrow {
                --iron-icon-fill-color: var(--details-inprogress);
            }

            designmap-task-info {
                margin-top: 15px;
            }

            /** Description **/

            .description {
                margin-top: 19px;
                display: flex;
                padding-bottom: 1px;
            }

            .desc-textarea {
                flex:1;
                --plastic-textarea-mixin: {
                    margin-left: 25px;
                    font-family: var(--font-family);
                    color: var(--gray-darky-color);
                    max-width: calc(100% - 40px);
                    font-weight: 300;
                    font-size: 18px;
                    padding: 5px ;
                    height: 25px;
                };
            }
            .desc-textarea.edit {
                margin-top: 2px;
                --plastic-textarea-mixin: {
                    margin-left: 24px;
                    font-family: var(--font-family);
                    color: var(--gray-darky-color);
                    max-width: calc(100% - 40px);
                    font-weight: 300;
                    font-size: 18px;
                    padding: 5px ;
                    height: 25px;
                    border: 1px solid var(--gray-color);
                };

            }

            .desc-arrow iron-icon{
                border: 1px solid var(--gray-color);
                padding: 5px;
                cursor: pointer;
                margin-top: 2px;
            }
            .desc-arrow iron-icon:hover {
                background: var(--gray-lightern-color);
            }

            .task-desc {
                width: 100%;
                margin-left: 25px;
                font-family: var(--font-family);
                color: var(--gray-saturated-color);
                max-width: calc(100% - 40px);
                font-weight: 300;
                font-size: 18px;
                padding: 5px;
                --plastic-html-mixin: {
                    cursor: text;
                    color: var(--gray-saturated-color);
                }
            }

            /** SUB TASK **/
            designmap-task-list {
                display: block;
                margin-top: 13px;
                border-top: 1px solid var(--gray-color);
                --designmap-task-list-add-task-wrapper-mixin: {
                    padding: 0 20px 0 30px;
                    margin-top: 5px;
                };
                --designmap-task-list-not-found-mixin: {
                    margin: 10px 17px;
                };
                --designmap-task-list-status-button-mixin: {
                    margin-left: 0;
                };
                --designmap-task-list-list-mixin: {
                    padding-left: 15px;
                };
                --designmap-task-list-title-mixin: {
                    margin-left: 0;
                };
                --designmap-task-list-add-input-mixin: {
                    margin-top: 0;
                    margin-left: 0;
                };
                --designmap-tasl-list-filters: {

                };
                --designmap-tasl-list-filters-first-child: {
                    margin-left: 32px;
                }
            }

            plastic-custom-scroll {
                --plastic-custom-scroll-content-mixin:{
                    max-height: 100%;
                };
            }

            .mid {
                margin-top: 10px;
            }

            .attaches {
                padding-top: 13px;
                border-top: 1px solid var(--gray-color);
            }

            .attaches .attach-icon {
                margin-left: 20px;
                vertical-align: top;
            }

            .attaches designmap-task-file-list {
                display: inline-block;
                cursor: pointer;
                width: 100%;
            }


            @media (min-width: 320px) and (max-width: 768px) {
                .grid {
                    flex-direction: column;
                }
                .grid .right {
                    max-width: 100%;
                }
                .task-desc {
                    margin-left: 15px;
                }
                .desc-textarea.edit {
                    margin-top: -1px;
                    --plastic-textarea-mixin: {
                        margin-left: 24px;
                        font-family: var(--font-family);
                        color: var(--gray-darky-color);
                        max-width: calc(100% - 40px);
                        font-weight: 300;
                        font-size: 18px;
                        padding: 5px ;
                        height: 25px;
                        border: 1px solid var(--gray-color);
                    };
                }
                .desc-arrow {
                    margin-right: 15px;
                }
                designmap-task-list {
                    padding-bottom: 10px;
                }


                /** DETAILS **/
                .details {
                    width: 100%;
                    height: 100%;
                }
                .hide-on-mobile {
                    display: none !important;
                }
            }

        </style>
        <plastic-custom-scroll id="scroller" fit small-bar>
            <div id="details" class$="details [[_computeAssigneeStatus(task)]] [[_computeFollowersCls(followers)]] [[_computeInvokedClass(invokedUsers)]]" >
            <!-- Panel -->
            <div class="panel">
                <div class="left">
                    <designmap-assignee id="assignee" horizontal-offset="-165" vertical-offset="65"
                                        class$="[[_computeAssigneeStatus(task)]] [[_isMobileClass(MQ)]]"
                                        task="[[task]]"
                                        disabled="[[!canRemoveTask(task)]]"
                                        assignee="[[task.assignee]]" on-assign="_selectAssignee"
                                        on-remove="_removeAssignee"></designmap-assignee>
                    <!-- Hint -->
                    <designmap-hint id="assigneeHint"
                                    previous
                                    have-skip
                                    tri-left
                                    name="assginee"
                                    vertical-offset="20"
                                    horizontal-offset="70">
                        <div class="title">
                            <i18-n msgid="Assignee">Assignee</i18-n>
                        </div>
                        <div class="desc">
                            <i18-n msgid="assigneeHintDesc">assigneeHintDesc</i18-n>
                        </div>
                    </designmap-hint>
                    <!-- Hint -->
                    <paper-tooltip for="assignee" position="right">
                        <i18-n msgid="Assign responsible">Assign responsible</i18-n>
                    </paper-tooltip>
                </div>
                <div class="center" id="center">
                    <input id="title" is="iron-input"
                           on-focus="titleEdit"
                           on-blur="saveTitle"
                           class$="task-title-input [[_isEditCls(titleEditMode)]]"
                           placeholder="[[translate('Enter title',language,i18Loaded)]]"
                           hidden$="[[!canRemoveTask(task)]]"
                           value="[[task.name]]"/>
                    <div hidden$="[[canRemoveTask(task)]]" title="[[task.name]]" class="task-title">[[task.name]]</div>
                    <paper-icon-button class="title-edit-arrow" hidden$="[[!titleEditMode]]" icon="arrow-forward"></paper-icon-button>
                    <iron-a11y-keys keys="enter" on-keys-pressed="titleFocusOut"></iron-a11y-keys>
                </div>
                <div class="right">
                    <designmap-circle-button class="hide-on-mobile"
                                             id="moveButton"
                                             on-click="openMoveExplorer">
                        <iron-icon class="panel-icon" icon="designmap-task-manager:move"></iron-icon>
                    </designmap-circle-button>
                    <paper-tooltip for="moveButton" position="left">
                        <i18-n msgid="Move this task">Move this task</i18-n>
                    </paper-tooltip>

                    <designmap-circle-button class="hidden-xs"
                                             id="removeButton"
                                             on-click="removeTask">
                        <iron-icon class="panel-icon remove" icon="designmap-task-manager:remove"></iron-icon>
                    </designmap-circle-button>
                    <paper-tooltip for="removeButton" position="left">
                        <i18-n msgid="Archive task">Archive task</i18-n>
                    </paper-tooltip>
                </div>
            </div>
                <div class="grid">
                    <div class="left">
                        <designmap-task-info id="info" task="[[task]]" project-users="[[projectUsers]]"></designmap-task-info>
                        <!-- Description -->
                        <div class="description">
                            <iron-a11y-keys id="a11ySaveDesc" keys="enter"
                                            on-keys-pressed="descFocusOut"></iron-a11y-keys>
                            <plastic-textarea id="desc"
                                              class$="desc-textarea [[_descEditModeCls(descEditMode)]]"
                                              value="[[task.description]]"
                                              rows="1"
                                              on-focus="descEditModeOn"
                                              on-focusout="saveDesc"
                                              on-input="saveTempDesc"
                                              hidden$="[[!descEditMode]]"
                                              placeholder="[[translate('Enter description',language,i18Loaded)]]"></plastic-textarea>
                            <div hidden$="[[descEditMode]]" on-tap="_tryToEdit" id="plasticDesc" class="task-desc">
                                <plastic-html  msg="[[_generateDesc(task.description)]]"></plastic-html>
                            </div>
                            <div hidden$="[[!descEditMode]]" class="desc-arrow">
                                <iron-icon icon="icons:arrow-forward"></iron-icon>
                            </div>
                        </div>
                    </div>
                    <div class="right">
                        <designmap-task-menu language="[[language]]" i-18-loaded="[[i18Loaded]]" spent-time="[[spentTime]]" project-users="[[projectUsers]]" user="[[user]]" task="[[task]]" project="[[project]]"></designmap-task-menu>
                        <!-- Hint -->
                        <designmap-hint id="actionsHint"
                                        previous
                                        have-skip
                                        tri-right
                                        name="actions"
                                        vertical-offset="0"
                                        horizontal-offset="-300">
                            <div class="title">
                                <i18-n msgid="Task actions">Task actions</i18-n>
                            </div>
                            <div class="desc">
                                <i18-n msgid="taskActionsDesc">taskActionsDesc</i18-n>
                            </div>
                        </designmap-hint>
                        <!-- Hint -->
                    </div>
                </div>
                <div class="mid">
                    <!-- Attaches -->
                    <div class="attaches">
                        <designmap-task-file-list user="[[user]]" project="[[project]]" project-id="[[project._id]]" task="[[task]]"></designmap-task-file-list>
                    </div>
                    <!-- Task list -->
                    <designmap-task-list id="list"
                                         placeholder="Add subtask"
                                         parent="[[task._id]]"
                                         small-add-task
                                         no-scroll="true"></designmap-task-list>
                    <!-- Hint -->
                    <designmap-hint id="subtasksHint"
                                    previous
                                    have-skip
                                    name="subtasks"
                                    tri-bottom
                                    vertical-offset="-280"
                                    horizontal-offset="20">
                        <div class="title">
                            <i18-n msgid="Subtasks">Subtasks</i18-n>
                        </div>
                        <div class="desc">
                            <i18-n msgid="subtasksHintDesc">subtasksHintDesc</i18-n>
                        </div>
                    </designmap-hint>
                    <!-- Hint -->
                    <!-- Comment list -->
                    <designmap-task-comment-list  project-id="[[projectId]]" user="[[user]]" task="[[task]]" comments="[[comments]]"></designmap-task-comment-list>
                </div>
            <designmap-confirm id="completeTaskConfirm"
                               message="YouHaveUncompletedTasks" on-continue="changeStatus"
                               on-suspend="suspendComplete"></designmap-confirm>
        </div>
        </plastic-custom-scroll>
        <!--comments-->
        <div class="comments">
            <designmap-task-comments
                    id="comments"
                    project-users="[[projectUsersWithOutMe]]"
                    language="[[language]]"
                    followers="{{followers}}"
                    invoked-users="{{invokedUsers}}"
                    i-18-loaded="[[i18Loaded]]"
                    project-id="[[projectId]]"
                    project="[[project]]"
                    task="[[task]]"
                    user="[[user]]"></designmap-task-comments>
        </div>

        <!-- Tasks explorer -->
        <paper-dialog class="explorer-dialog" id="tasksExplorerDialog"
                      entry-animation="scale-up-animation" exit-animation="scale-down-animation">
            <designmap-tasks-explorer id="taskExplorer" button-text="[[buttonText]]" on-select-element="changeButtonText" selected="{{selectedTasks}}" current-task-id="{{currentTaskId}}"
                                      no-upload
                                      select-root
                                      on-task="_moveTasks"></designmap-tasks-explorer>
        </paper-dialog>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-details',
            behaviors: [
                ReduxBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapTaskService,
                Polymer.DesignmapTaskTrackTimeService,
                Polymer.DesignMapTaskNotifyService,
                Polymer.DesignMapFsService,
                Polymer.CombineActions(Polymer.TasksActions, Polymer.FilesActions, Polymer.CommentsActions)],
            properties: {
                task: {
                    type: Object,
                    value: null,
                    observer: '_taskChanged'
                },
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projectId: {
                    type: Object,
                    statePath: 'projectId'
                },
                projectUsers: {
                    type: Array,
                    statePath: 'projectUsers'
                },
                projectUsersWithOutMe: {
                    type: Array,
                    computed: '_computeProjectUsersWithOutMe(projectUsers)'
                },
                titleEditMode: {
                    type: Boolean,
                    value: false
                },
                descEditMode: {
                    type: Boolean,
                    value: false
                },
                comments: {
                    type: Array,
                    statePath: 'comments'
                },
                followers: {
                    type: Array,
                    value: []
                },
                invokedUsers: {
                    type: Array,
                    value: []
                },
                selectedTasks: {
                    type: Array,
                    value: []
                }
            },
            listeners: {
                'change-status': '_chngStatus',
                'change-label': 'changeLabel',
                'estimate-task': 'estimateTask',
                'track-time': 'trackTime',
                'edit-time': 'editTime',
                'request-time': 'requestTime',
                'clear-time': 'clearTime',
                'save-date': 'saveDate',
                'attach-files': 'attachFiles',
                'attach-tasks': 'attachTasks',
                'remove-file': 'removeFile',
                'remove-task-attach': 'removeTaskAttach',
                'remove-comment': 'removeComment',
                'edit-comment': 'editComment',
                'like-comment': 'likeComment',
                'reply-comment': 'replyComment',
                'quote-task-comment': 'quoteTaskComment',
                'set-temp-comment': 'setTempComment',
                'scroll-on-top': 'scrollOnTop',
                'send-estimation-request': 'sendEstimationRequest',
                'send-time-change-request': 'sendTimeChangeRequest',
                'toggle-dependency': 'toggleDependency'
            },
            observers: [
                '_watchRun(task.time.run)',
                '_descChange(task.description)'
            ],
            saveTitle: function (e) {
                if (!this.canUpdateTask(this.task)) {
                    this.rollbackTitle();
                    return this.showErrorMessage('You do not have access to make it');
                }
                if (!this.$.title.value.trim()) {
                    this.rollbackTitle();
                    return this.showErrorMessage('Task title should be not empty');
                }
                if (/[\#\?\\\%\/\+\:]/.test(this.$.title.value)) {
                    this.rollbackTitle();
                    return this.showErrorMessage('You cannot use special symbols in task name');
                }
                if (!this.validate(this.$.title.value)) {
                    this.rollbackTitle();
                    return this.showErrorMessage('Task title should be unique');
                }
                this.titleEditMode = false;
                this.dispatch('updateTask', this.task._id, {name: this.$.title.value}).then(function (response) {
                    if (!response.success) return;
                    this.showMessage('Task title was updated successful!');
                }.bind(this));
            },

            rollbackTitle: function () {
                this.$.title.value = this.task.name;
            },

            validate: function (title) {
                let found = null;
                if (this.task.name == title) return true;
                this.findTaskOneLevel(this.task.path).forEach(function (task) {
                    if (task.name == title) found = task;
                }.bind(this));
                return !found;
            },

            _computeAssigneeStatus: function (task) {
                return task ? this.isExpired(task.expired, task.status) ? 'expired' : task.status : '';
            },

            titleEdit: function(){
                this.async(this.updateStyles);
                this.titleEditMode = true;
            },

            titleEditOff: function(){
                this.titleEditMode = false;
            },

            _isEditCls: function(titleEditMode){
                return titleEditMode?'edit':'';
            },

            _selectAssignee: function (e) {
                if (!e.detail || !e.detail._id) return;
                if (!this.canUpdateTask(e.detail.task)) return this.showErrorMessage('canUpdateTask');

                this.dispatch('updateTask', this.task._id, {assignee: e.detail._id});
                // Notify but do not do this if for itself
                if (e.detail._id == this.user._id) return;
                const taskId = e.detail.task._id;
                // Wait because you can change assignee
                this.async(function(){
                    const task = this.findTaskById(taskId);
                    this.sendAssigneeNotification(task,task.assignee);
                },60000);
            },

            _removeAssignee: function (e) {
                if (!e.detail || !e.detail.task) return;
                this.dispatch('updateTask', e.detail.task._id, {assignee: null});
            },

            _chngStatus: function(e){
                const status = e.detail;
                this.tempStatus = status;
                if(status=='completed' && this.checkDependencies(this.task)) return this.showErrorMessage('You cannot complete task until dependencies would be completed');
                if(status=='completed' && this.checkNotCompletedChildren(this.task)) return this.$.completeTaskConfirm.open();
                this.changeStatus(e);
            },

            suspendComplete: function(){
                this.$.completeTaskConfirm.close();
            },

            changeStatus: function(e){
                if (!this.canUpdateTask(this.task)) return this.showErrorMessage('Only project or task or assignee can change task status');
                const status = e && typeof e.detail=='string' ? e.detail : this.tempStatus;
                //if (this.isExpired(this.task.expired)) return;
                const data = {status: status};
                if(status=='completed') data.completed = new Date();
                this.dispatch('updateTask', this.task._id, data);
                this.async(function(){
                    this.updateStyles();
                    this.$.list.updateStyles();
                });
                // Notify
                this.sendTaskStatusNotification(this.task);
                this.$.completeTaskConfirm.close();
            },

            changeLabel: function(e){
                if(e.detail.sourceEvent || !this.task) return;
                this.dispatch('updateTask', this.task._id, {label:e.detail}).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot cahnge label');
                }.bind(this));
            },

            estimateTask: function(e){
                this.task.grade = this.task.grade || {};
                this.task.grade[this.user._id] = e.detail;
                this.dispatch('updateTask', this.task._id, this.task).then(function (response) {
                    if (!response.success) return;
                    this.showMessage('Task was estimated successful!');
                }.bind(this));
            },

            saveDate: function(e){
                this.dispatch('updateTask', this.task._id, {expired: e.detail});
            },

            attachFiles: function(e){
                const selected = e.detail;
                selected.forEach(function (file) {
                    if (this.task.files.indexOf(file._id) != -1) return;
                    this.task.files.push(file._id);
                }.bind(this));
                this.dispatch('updateTask', this.task._id, this.task).then(function (response) {
                    if (!response.success) return;
                    this.showMessage('File was attached successful!');
                }.bind(this));
            },

            attachTasks: function(e){
                const selected = e.detail;
                selected.forEach(function (task) {
                    if (this.task.tasks.indexOf(task._id) != -1) return;
                    this.task.tasks.push(task._id);
                }.bind(this));
                this.dispatch('updateTask', this.task._id, this.task).then(function (response) {
                    if (!response.success) return;
                    this.showMessage('Task was attached successful!');
                }.bind(this));
            },

            removeFile: function (e) {
                const file = e.detail;
                this.task.files.splice(this.task.files.indexOf(file._id), 1);
                this.task.dependencies.splice(this.task.dependencies.indexOf(file._id), 1);
                this.dispatch('updateTask', this.task._id, this.task);
            },

            removeTaskAttach: function (e) {
                const task = e.detail;
                this.task.tasks.splice(this.task.tasks.indexOf(task._id), 1);
                this.task.dependencies.splice(this.task.dependencies.indexOf(task._id), 1);
                this.dispatch('updateTask', this.task._id, this.task);
            },

            descEditModeOn: function(e){
                /*const target = e.path ? e.path[0] : e.target;
                if(target.tagName.toLowerCase()=='a') return;*/
                this.descEditMode = true;
            },

            descEditModeOff: function(e){
                console.log(e,1);
                this.descEditMode = false;
            },

            _descEditModeCls: function(descEditMode){
                this.async(this.updateStyles);
                return descEditMode?'edit':'';
            },

            _tryToEdit: function(e){
                if(!this.canRemoveTask(this.task)) return;
                const target = e.path ? e.path[0] : e.target;
                if(target.tagName.toLowerCase()=='a') return;

                this.descEditMode = true;
                this.$.desc.refit();
                this.async(function(){this.$.desc.focus();},10);
            },

            saveDesc: function (e) {
                const val = this.$.desc.$.textarea.value;
                if (!this.canUpdateTask(this.task)) {
                    this.$.desc.$.textarea.value = this.task.description;
                    return this.showErrorMessage('You do not have access to make it');
                }
                this.descEditMode = false;
                this.dispatch('updateTask', this.task._id, {description: val}).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot save description');
                    this.showMessage('Description has been saved!');
                }.bind(this));

            },

            _generateDesc: function(desc){
                return this.commentTextProcess(desc) || (this.canUpdateTask(this.task) ? this.translate('Enter description') : this.translate('There is no description') )
            },

            saveTempDesc: function(v){
                localStorage.setItem('synecto:desc:temp',this.$.desc.value);
            },

            _descChange: function(){
                const tempDesc = localStorage.getItem('synecto:desc:temp');
                if(this.descEditMode && tempDesc) {
                    this.set('task.description',tempDesc);
                    localStorage.setItem('synecto:desc:temp','');
                }
            },

            likeComment: function(e){
                let comment = e.detail;

                comment.likes = comment.likes || [];
                const isThereUser = comment.likes.indexOf(this.user._id) != -1;
                const userLikesIndex = comment.likes.indexOf(this.user._id);
                isThereUser ? comment.likes.splice(userLikesIndex, 1) : comment.likes.push(this.user._id);
                this.dispatch('updateComment', comment._id, comment);
            },

            removeComment(e){
                this.dispatch('removeComment', e.detail);
            },

            editComment: function(e){
                this.$.comments.edit = e.detail._id;
                this.$.comments.commentText = e.detail.text;
            },

            _computeFollowersCls: function(followers){
                this.async(this.updateStyles);
                return followers.length ? 'followers' : '';
            },

            _computeInvokedClass: function(invoked){
                this.async(this.updateStyles);
                return invoked.length ? 'invoked' : '';
            },

            scrollOnTop: function(){
                this.$.scroller.setScroll(this.$.scroller.$.content.scrollHeight + 200);
            },

            replyComment: function(e){
                const comment = e.detail;
                this.$.comments.reply(comment);
            },

            quoteTaskComment: function(e){
                const text = e.detail;
                this.$.comments.quoteText(text);
            },

            setTempComment: function(e){
                this.$.comments.setTempComment(e.detail);
            },

            sendEstimationRequest: function(e){
                this.sendTaskEstimationRequestNotification(e.detail);
                this.showMessage('Estimation request has been sent.')
            },

            sendTimeChangeRequest: function(e){
                this.sendTaskTimeChangeRequestNotification(e.detail);
            },

            removeTask: function(){
                const id = this.task._id;
                this.fire('reset');
                this.dispatch('$updateTask', id, {removed: true,removedBy:{user:this.user._id,date:new Date()}}).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot archive task');
                    this.fire('apply-sort-list');
                    this.showUndoMessage('Task has been archived.');
                }.bind(this));
            },

            _taskChanged: function(){
                this.async(function(){
                    this.$.scroller.calculate();
                },100);
            },

            titleFocusOut: function(){
                this.$.title.blur();
            },

            descFocusOut: function(e){
                if(Polymer.shiftIsPressed) return false;
                this.$.desc.blur();
            },

            toggleDependency: function(e){
                const element = e.detail;
                this.task.dependencies = this.task.dependencies || [];
                const index = this.task.dependencies.indexOf(element._id);
                index==-1? this.task.dependencies.push(element._id) : this.task.dependencies.splice(index,1);
                this.dispatch('updateTask', this.task._id, this.task).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot set dependency');
                    this.showMessage(index==-1?'Now element "#ELEMENT#" is dependency for "#TASK#" task':'"#ELEMENT#" is no more dependency for "#TASK#" task',{'#ELEMENT#':element.name||element.data.name,'#TASK#':this.task.name});
                }.bind(this));
            },

            openMoveExplorer: function(){
                this.$.taskExplorer.currentTaskId = null;
                this.$.taskExplorer.selected = [null];
                this.$.tasksExplorerDialog.open();
            },

            changeButtonText: function(e){
                const task = this.findTaskById(e.detail._id || e.detail);
                if(!task) return this.buttonText = this.replaceExpressions(this.translate('Move into'),{"#NAME#":this.translate('root')});
                this.buttonText = this.replaceExpressions(this.translate('Move into'),{"#NAME#":task.name});
            },

            _moveTasks: function(e){
                const tsk = e.detail[0];
                const toTaskId = tsk?tsk._id?tsk._id:tsk:tsk;
                const tasks = this.moveManyMode ? this.moveSelectedTasks : [this.task];
                tasks.forEach(function(task){
                    if(toTaskId==task._id) return this.showErrorMessage('Cannot move in itself');
                    if(toTaskId==task.parent) return this.showErrorMessage('Already here');
                    this.$.tasksExplorerDialog.close();
                    this.dispatch('updateTask', task._id, {parent:toTaskId}).then(function(response){
                        if(!response.success) return this.manageErrorResponse(response);
                        const toTask = this.findTaskById(toTaskId);
                        if(!this.moveManyMode) this.showMessage('Task was moved',{'#TASK#':this.task.name,"#TO#":toTask?toTask.name:this.translate('root')});
                        this.moveManyMode = true;
                    }.bind(this)).catch(this.manageErrorResponse.bind(this));
                },this);
                if(this.moveManyMode ) {
                    this.async(function(){this.fire('clear-list-selected');},0);
                    this.showMessage('All tasks are moved successfully!')
                }
            }
        })
    </script>
</dom-module>
