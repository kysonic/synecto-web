<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../../plastic/plastic-custom-scroll.html">
<link rel="import" href="../../plastic/plastic-textarea.html">
<link rel="import" href="../../plastic/plastic-html.html">
<link rel="import" href="./designmap-assignee.html">
<link rel="import" href="./designmap-task-manager-labels.html">
<link rel="import" href="../designmap-ui/designmap-date-picker.html">
<link rel="import" href="../designmap-fs/designmap-file-uploader.html">
<link rel="import" href="../designmap-ui/designmap-invk-textarea.html">
<link rel="import" href="../designmap-ui/designmap-followers.html">
<link rel="import" href="../designmap-accesses/designmap-users-select.html">
<link rel="import" href="../designmap-fs/designmap-fs-explorer.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="./designmap-task-estimate.html">
<link rel="import" href="./designmap-task-comments.html">
<link rel="import" href="./designmap-task-info.html">
<link rel="import" href="./designmap-task-menu.html">

<link rel="import" href="../../../styles/tooltip-shared-styles.html">

<link rel="import" href="./deaignmap-task-service.html">
<link rel="import" href="./designmap-task-track-time-service.html">
<link rel="import" href="../designmap-tutorial/designmap-hint-service.html">

<link rel="import" href="../../../redux/redux-store.html">
<link rel="import" href="../../../redux/actions/combine-actions.html">
<link rel="import" href="../../../redux/actions/files-actions.html">
<link rel="import" href="../../../redux/actions/user-actions.html">
<link rel="import" href="../../../redux/actions/tasks-actions.html">
<link rel="import" href="../../../redux/actions/comments-action.html">

<dom-module id="designmap-task-details">
    <template>
        <style include="tooltip-shared-styles">
            :host {
                flex: 1;
                box-sizing: border-box;
                position: relative;
                background: var(--white-color);
                display: flex;
                flex-direction: column;
                overflow: hidden;

                --details-color: var(--gray-saturated-color);

                --details-incomplete: var(--incomplete);
                --details-inprogress: var(--inprogress);
                --details-completed: var(--completed);
                --details-expired: var(--expired);
            }

            *[hidden] {
                display: none !important;
            }

            /** DETAILS **/
            .details {
                width: 100%;
                height: 100%;
            }

            /** Panel **/

            .details .panel {
                display: flex;
            }

            .details .panel .left {
                flex: 1;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .details .panel .center {
                flex: 11;
                display: flex;
                align-items: center;
            }

            .panel .right designmap-circle-button, designmap-assignee {
                width: 55px;
                height: 55px;
                --designmap-circle-button-circle-mixin: {
                    stroke-width: 1px;
                    stroke: var(--details-color) !important;
                };
            }

            /** Assignee **/
            designmap-assignee {
                width: 60px;
                height: 60px;
                margin-left: 10px;
                --iron-icon-stroke-color: var(--gray-color);
                --iron-icon-fill-color: var(--gray-color);
                --designmap-assignee-assigned-mixin: {
                    width: 45px;
                    height: 45px;
                    margin: 5px 0 5px 5px;
                    border: 2px solid var(--white-color);
                };
            }

            /** Title -input **/

            .task-title-input, .task-title {
                font-family: var(--font-family);
                font-weight: 100;
                font-size: 34px;
                color: var(--gray-darky-color);
                border: none;
                outline: none;
                width: 100%;
            }

            .task-title-input.edit {
                border-bottom: 1px solid var(--gray-saturate-color);
            }

            .task-title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .title-edit-arrow {
                width: 50px;
                height: 50px;
                position: relative;
                top: 2px;
                --iron-icon-fill-color: var(--gray-saturate-color);
            }

            /** PANEL **/
            .panel .right {
                flex: 1;
                display: flex;
                justify-content: flex-end;
                align-items: flex-start;
                margin-top: 3px;
            }

            .panel-icon.remove {
                width: 25px !important;
                height: 25px !important;
                padding: 15px !important;
            }

            .grid {
                display: flex;
                justify-content: space-between;
            }
            .grid .left {
                flex: 2;
            }
            .grid .right {
                flex: 1;
                max-width: 175px;
            }

            /** STATUSES **/
            .details.completed .task-title-input, .details.completed .task-title {
                color: var(--details-completed)
            }
            .details.completed .task-title-input.edit {
                border-bottom: 2px solid var(--details-completed);
            }
            .details.completed .title-edit-arrow {
                --iron-icon-fill-color: var(--details-completed);
            }

            .details.expired .task-title-input, .details.expired .task-title {
                color: var(--details-expired)
            }
            .details.expired .task-title-input.edit {
                border-bottom: 2px solid var(--details-expired);
            }
            .details.expired .title-edit-arrow {
                --iron-icon-fill-color: var(--details-expired);
            }

            .details.incomplete .task-title-input, .details.incomplete .task-title {
                color: var(--details-incomplete)
            }
            .details.incomplete .task-title-input.edit {
                border-bottom: 2px solid var(--details-incomplete);
            }
            .details.incomplete .title-edit-arrow {
                --iron-icon-fill-color: var(--details-incomplete);
            }

            .details.in_progress .task-title-input, .details.in_progress .task-title {
                color: var(--details-inprogress)
            }
            .details.in_progress .task-title-input.edit {
                border-bottom: 2px solid var(--details-inprogress);
            }
            .details.in_progress .title-edit-arrow {
                --iron-icon-fill-color: var(--details-inprogress);
            }

            designmap-task-info {
                margin-top: 5px;
            }

        </style>
        <div id="details" class$="details [[_computeAssigneeStatus(task)]]" >
            <!-- Panel -->
            <div class="panel">
                <div class="left">
                    <designmap-assignee id="assignee" horizontal-offset="-165" vertical-offset="65"
                                        class$="[[_computeAssigneeStatus(task)]] [[_isMobileClass(MQ)]]"
                                        task="[[task]]"
                                        disabled="[[!canRemoveTask(task)]]"
                                        assignee="[[task.assignee]]" on-assign="_selectAssignee"
                                        on-remove="_removeAssignee"></designmap-assignee>
                    <!-- Hint -->
                    <designmap-hint id="assigneeHint" tri-left previous name="assignee" vertical-offset="20"
                                    horizontal-offset="70">
                        <div class="title">
                            <i18-n msgid="Assign responsible">Assign responsible</i18-n>
                        </div>
                        <div class="desc">
                            <i18-n msgid="assigneeMsg">assigneeMsg</i18-n>
                        </div>
                    </designmap-hint>
                    <!-- Hint-->
                    <paper-tooltip for="assignee" position="right">
                        <i18-n msgid="Assign responsible">Assign responsible</i18-n>
                    </paper-tooltip>
                </div>
                <div class="center" id="center">
                    <input id="title" is="iron-input"
                           on-focus="titleEdit"
                           class$="task-title-input [[_isEditCls(titleEditMode)]]"
                           placeholder="[[translate('Enter title',language,i18Loaded)]]"
                           hidden$="[[!canRemoveTask(task)]]"
                           value="[[task.name]]"/>
                    <div hidden$="[[canRemoveTask(task)]]" class="task-title">[[task.name]]</div>
                    <paper-icon-button class="title-edit-arrow" hidden$="[[!titleEditMode]]" icon="arrow-forward" on-click="saveTitle"></paper-icon-button>
                    <iron-a11y-keys keys="enter" on-keys-pressed="saveTitle"></iron-a11y-keys>
                </div>
                <div class="right">
                    <designmap-circle-button class="hidden-xs"
                                             id="removeButton"
                                             hidden$="[[!canRemoveTask(task)]]"
                                             on-click="openRemoveTaskConfirm">
                        <iron-icon class="panel-icon remove" icon="designmap-task-manager:remove"></iron-icon>
                    </designmap-circle-button>
                    <paper-tooltip for="removeButton" position="left">
                        <i18-n msgid="Archive task">Archive task</i18-n>
                    </paper-tooltip>
                </div>
            </div>
            <!-- Panel -->
            <div class="grid">
                <div class="left">
                    <designmap-task-info task="[[task]]" project-users="[[projectUsers]]"></designmap-task-info>
                    <!-- Desc-->
                    <!-- Subtasks -->
                    <!-- Comment-list-->
                    <!-- History ?! -->
                </div>
                <div class="right">
                    <designmap-task-menu spent-time="[[spentTime]]" project-users="[[projectUsers]]" user="[[user]]" task="[[task]]" project="[[project]]"></designmap-task-menu>
                </div>
            </div>
        </div>
        <!--comments-->
        <div class="comments">
            <designmap-task-comments
                    project-users="[[projectUsersWithOutMe]]"
                    language="[[language]]"
                    i-18-loaded="[[i18Loaded]]"
                    project-id="[[projectId]]"
                    task="[[task]]"
                    user="[[user]]"></designmap-task-comments>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-details',
            behaviors: [
                ReduxBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapTaskService,
                Polymer.DesignmapTaskTrackTimeService,
                Polymer.DesignMapFsService,
                Polymer.CombineActions(Polymer.TasksActions, Polymer.FilesActions, Polymer.CommentsActions)],
            properties: {
                task: {
                    type: Object,
                    value: null
                },
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projectId: {
                    type: Object,
                    statePath: 'projectId'
                },
                projectUsers: {
                    type: Array,
                    statePath: 'projectUsers'
                },
                projectUsersWithOutMe: {
                    type: Array,
                    computed: '_computeProjectUsersWithOutMe(projectUsers)'
                },
                titleEditMode: {
                    type: Boolean,
                    value: false
                },
                spentTime: {
                    type: Number,
                    value: 0
                }

            },
            listeners: {
                'change-status': 'changeStatus',
                'change-label': 'changeLabel',
                'estimate-task': 'estimateTask',
                'track-time': 'trackTime',
                'save-date': 'saveDate'
            },
            observers: [
                '_watchRun(task.time.run)'
            ],
            saveTitle: function (e) {
                if (!this.canUpdateTask(this.task)) {
                    this.rollbackTitle();
                    return this.showErrorMessage('You do not have access to make it');
                }
                if (!this.$.title.value.trim()) {
                    this.rollbackTitle();
                    return this.showErrorMessage('Task title should be not empty');
                }
                if (!this.validate(this.$.title.value)) {
                    this.rollbackTitle();
                    return this.showErrorMessage('Task title should be unique');
                }
                this.titleEditMode = false;
                this.dispatch('updateTask', this.task._id, {name: this.$.title.value}).then(function (response) {
                    if (!response.success) return;
                    if (e.type == 'keys-pressed') this.showMessage('Task title was updated successful!');
                }.bind(this));
            },

            rollbackTitle: function () {
                this.$.title.value = this.task.name;
            },

            validate: function (title) {
                let found = null;
                if (this.task.name == title) return true;
                this.findTaskOneLevel(this.task.path).forEach(function (task) {
                    if (task.name == title) found = task;
                }.bind(this));
                return !found;
            },

            _computeAssigneeStatus: function (task) {
                return task ? this.isExpired(task.expired, task.status) ? 'expired' : task.status : '';
            },

            titleEdit: function(){
                this.async(this.updateStyles);
                this.titleEditMode = true;
            },

            _isEditCls: function(titleEditMode){
                return titleEditMode?'edit':'';
            },

            _selectAssignee: function (e) {
                if (!e.detail || !e.detail._id) return;
                if (!this.canUpdateTask(e.detail.task)) return this.showErrorMessage('canUpdateTask');

                this.dispatch('updateTask', this.task._id, {assignee: e.detail._id});
                // Notify but do not do this if for itself
                if (e.detail._id == this.user._id) return;
                //this.sendAssigneeNotification(e.detail.task, e.detail._id);
            },

            _removeAssignee: function (e) {
                if (!e.detail || !e.detail.task) return;
                this.dispatch('updateTask', e.detail.task._id, {assignee: null});
            },

            changeStatus: function(e){
                const status = e.detail;
                if (!this.canUpdateTask(this.task)) return this.showErrorMessage('Only project or task or assignee can change task status');
                //if (this.isExpired(this.task.expired)) return;
                const data = {status: status};
                if(status=='completed') data.completed = new Date();
                this.dispatch('updateTask', this.task._id, data);
                this.async(this.updateStyles);
                // Notify
                //this.sendTaskStatusNotification(this.task);
            },

            changeLabel: function(e){
                if(e.detail.sourceEvent || !this.task) return;
                this.dispatch('updateTask', this.task._id, {label:e.detail}).then(function (response) {
                    if (!response.success) return this.showErrorMessage('Cannot cahnge label');
                }.bind(this));
            },

            estimateTask: function(e){
                this.task.grade = this.task.grade || {};
                this.task.grade[this.user._id] = e.detail;
                this.dispatch('updateTask', this.task._id, this.task).then(function (response) {
                    if (!response.success) return;
                    this.showMessage('Task was estimated successful!');
                }.bind(this));
            },

            saveDate: function(e){
                this.dispatch('updateTask', this.task._id, {expired: e.detail});
            },
        })
    </script>
</dom-module>
