<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../designmap-ui/designmap-dashboard.html">
<link rel="import" href="../designmap-ui/designmap-search-filter.html">
<link rel="import" href="../designmap-icons/designmap-task-manager.html">
<link rel="import" href="../designmap-icons/designmap-workspace-icons.html">
<link rel="import" href="./designmap-task-list.html">
<link rel="import" href="./designmap-task-details.html">
<link rel="import" href="./designmap-tasks-overview.html">
<link rel="import" href="../designmap-ui/designmap-stub.html">
<link rel="import" href="../designmap-tutorial/designmap-hint.html">
<!-- Redux -->
<link rel="import" href="../../../redux/redux-store.html">
<link rel="import" href="../../../redux/actions/combine-actions.html">
<link rel="import" href="../../../redux/actions/files-actions.html">
<link rel="import" href="../../../redux/actions/project-actions.html">
<link rel="import" href="../../../redux/actions/user-actions.html">
<link rel="import" href="../../../redux/actions/tasks-actions.html">
<link rel="import" href="../../../redux/actions/comments-action.html">
<!-- Services -->
<link rel="import" href="./deaignmap-task-service.html">
<link rel="import" href="../designmap-tutorial/designmap-hint-service.html">
<link rel="import" href="../../../behaviors/designmap-socket-behavior.html">
<!-- Styles -->
<link rel="import" href="../../../styles/loading-shared-styles.html">

<dom-module id="designmap-task-manager">
    <template>
        <style include="loading-shared-styles"></style>
        <style>
            :host {
                --title-color: var(--blue-darky-color);
                --taskmanager-color: var(--gray-saturated-color);
                --breadcrumbs-text-color: var(--blue-color);
                --breadcrumbs-selected-color: var(--blue-darky-color);

                --designmap-dashboard-title-mixin: {
                    display: inline-block;
                    flex: none;
                    margin-left: 25px;
                }
            }

            *[hidden] {
                display: none !important;
            }


            :host > .wrapper > .content {
                display: flex;
                height: calc(100vh - 130px);
            }

            .dashboard {
                width: 100%;
                height: 45px;
                background: var(--white-color);
                position: relative;
            }

            .left > .title {
                font-size: 26px;
                font-weight: 100;
                display: inline-block;
                cursor: pointer;
                white-space: nowrap;
                vertical-align: middle;
                color: var(--title-color);
                margin-left: 23px;
            }

            .arrow-back {
                border-radius: 50%;
                margin-left: 18px;
                cursor: pointer;
                transition: background .2s ease-in;
            }

            .arrow-back:hover {
                background: var(--gray-lightern-color);
                transition: background .2s ease-in;
            }

            .arrow-back iron-icon {
                width: 50px;
                height: 50px;
                transform: rotate(223deg);
                --iron-icon-components-mixin: {
                    stroke: var(--primary-color) !important;
                    stroke-width: 2px !important;
                }
            }

            .no-task {
                width: 100%;
                height: 100%;
            }

            .loading, .error {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .error {
                color: red;
            }

            designmap-task-details.no-task{
                display: none;
            }

            /** List and Details **/
            designmap-task-list {
                flex: 1;
            }
            designmap-task-details {
                flex: 1;
            }

            /** Breadcrumbs **/

            .title {
                display: inline-block;
            }

            .breadcrumbs {
                display: inline-block;
            }

            .crumb {
                display: inline-block;
                margin-left: 25px;
                font-weight: 100;
                flex: 1;
                position: relative;
            }
            .crumb .title{
                cursor: pointer;
                display: inline-block;
                vertical-align: middle;
                font-size: 17px !important;
                padding: 3px 10px;
                position: relative;
                top: 3px;
                white-space: nowrap;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                color: var(--breadcrumbs-selected-color);
            }
            .crumb .title.selected {
                border-radius: 3px;
                background: var(--breadcrumbs-selected-color);
                color: var(--white-color);
            }

            .crumb .line {
                position: absolute;
                top: 4px;
                margin-left: -27px;
                width: 30px;
                height: 30px;
                left: 0;
                --iron-icon-components-mixin: {
                    stroke-width: 1px;
                    stroke: var(--white-color);
                    fill: var(--blue-darkest-color);
                };
            }

            .title.arrowmq {
                margin-left: 5px !important;
            }

            .dashborad {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .right {
                float: right;
                margin-right: 20px;
                min-width: 230px;
            }

            designmap-search-filter {
                min-width: 230px;
            }

            .cancel-search {
                display: inline-block;
                width: 24px;
                height: 24px;
                padding: 2px;
                position: relative;
                top: 5px;

                --iron-icon-components-mixin: {
                    fill: var(--blue-darkest-color) !important;
                    stroke: var(--blue-darkest-color) !important;
                };
            }

            designmap-tasks-overview {
                min-width: 400px;
                border-left: 1px solid var(--gray-color);
            }

            @media (min-width: 320px) and (max-width: 768px) {

                :host > .wrapper > .content {
                    display: flex;
                    height: calc(100vh - 180px);
                }

                .hidden-xs {
                    display: none;
                }
                designmap-task-list.no-task {
                    display: block;
                }
                designmap-task-details.selected-task {
                    display: flex;
                }
                designmap-task-list.selected-task, designmap-task-details.no-task{
                    display: none;
                }
                designmap-task-details {
                    margin-top: 0px;
                }
                designmap-tasks-overview {
                    display: none;
                }
            }


        </style>
        <div class="wrapper">
            <designmap-dashboard class="dashborad" hidden$="[[projectError]]" back="[[_showBack(selectedTask,MQ)]]" on-go-back="_arrowBackAction" >
                <div class="left">
                    <div class="title" >
                        [[project.name]]
                    </div>
                    <div class="breadcrumbs hidden-xs">
                        <div class="crumb">
                            <div class="title" on-click="goOnTop"><i18-n msgid="Tasks">Tasks</i18-n></div>
                            <iron-icon class="line" icon="icons:chevron-left"></iron-icon>
                        </div>
                        <template is="dom-repeat" items="[[breadcrumbs]]" as="crumb">
                            <div class$="crumb [[calculateSelectedCrumb(breadcrumbs.length,index)]]" title="[[crumb.title]]"  hidden$="[[!breadcrumbs.length]]">
                                <div class$="title [[calculateSelectedCrumb(breadcrumbs.length,index)]]" on-click="goToParent">[[crumb.title]]</div>
                                <iron-icon class="line" icon="icons:chevron-left"></iron-icon>
                            </div>
                        </template>
                    </div>
                    <div class="breadcrumbs search" hidden$="[[!searchMode]]">
                        <div class="crumb">
                            <div class="title" ><i18-n msgid="Tasks">Tasks</i18-n></div>
                            <iron-icon class="line" icon="icons:chevron-left"></iron-icon>
                        </div>
                        <div class="crumb">
                            <div class="title"><i18-n msgid="Search">Search</i18-n></div>
                            <iron-icon class="line" icon="icons:chevron-left"></iron-icon>
                        </div>
                        <paper-icon-button class="cancel-search" on-click="cancelSearch" icon="icons:close"></paper-icon-button>
                    </div>
                </div>
                <div class="right">
                    <designmap-search-filter id="searchFilter" label="[[translate('Search...',language,i18Loaded)]]" items="[[filterItems]]"></designmap-search-filter>
                </div>
            </designmap-dashboard>
            <div class$="content [[mode]]">
                <designmap-task-list class$="[[_isThereSelectedTaskClass(selectedTask)]]" hidden$="[[!computeListState(tasks.length)]]" id="list"
                                     selected="{{selectedTask}}" can-be-null parent="[[selectedTask.parent]]" cannot-add="[[searchMode]]" search-mode="[[searchMode]]"  selecting></designmap-task-list>
                <designmap-task-details class$="[[_isThereSelectedTaskClass(selectedTask)]]" hidden$="[[!computeDetailsState(tasks.length,selectedTask)]]"
                                        id="details" task="[[selectedTask]]" search-mode="[[searchMode]]"></designmap-task-details>
                <designmap-tasks-overview hidden$="[[!computeOverviewState(tasks.length,selectedTask)]]"></designmap-tasks-overview>
                <div class="no-task" hidden$="[[!computeNoTasksState(tasks.length,loading,error)]]">
                    <designmap-stub id="slothStub" value="{{taskName}}" on-action="addTask"
                                    image="designmap-workspace-stub:sloth" message="You do not have tasks yet"
                                    input-text="Add task" input-error="AddTaskError"></designmap-stub>
                    <!-- Hint -->
                    <designmap-hint id="addTaskHint" target="[[addTaskStubBlock]]" name="addTask" vertical-offset="20"
                                    horizontal-offset="-20">
                        <div class="title">
                            <i18-n msgid="Add a task">Add a task</i18-n>
                        </div>
                        <div class="desc">
                            <i18-n msgid="addTaskMsg">addTaskMsg</i18-n>
                        </div>
                    </designmap-hint>
                </div>
               <div id="projectLoading" hidden$="[[!loadingState(loading,error)]]" class="loading-overlay">
                    <div class="uil-reload-css">
                        <div></div>
                    </div>
                </div>
                <div class="error" hidden$="[[!errorState(loading,error)]]">
                    <designmap-stub image="designmap-workspace-stub:error" message="[[error]]"
                                    error></designmap-stub>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-manager',
            behaviors: [
                ReduxBehavior,
                Polymer.IronResizableBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapHintService,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapTaskService,
                Polymer.DesignmapSocketBehavior,
                Polymer.CombineActions(Polymer.ProjectActions, Polymer.UserActions, Polymer.TasksActions, Polymer.FilesActions, Polymer.CommentsActions)
            ],
            properties: {
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    value: false
                },
                isAuth: {
                    type: Boolean,
                    computed: '_computedAuth(user)',
                    observer: '_isAuthChanged'
                },
                taskName: {
                    type: String,
                    value: ''
                },
                mode: {
                    type: String,
                    value: 'list'
                },
                selectedTask: {
                    type: Object,
                    value: null,
                    observer: '_selectedTaskChanged'
                },
                tasks: {
                    type: Array,
                    statePath: 'tasks',
                    observer: 'tasksChanged'
                },
                projectId: {
                    type: String,
                    statePath: 'projectId'
                },
                project: {
                    type: Object,
                    statePath: "project"
                },
                path: {
                    type: String,
                    statePath: "path",
                    observer: "_pathChanged"
                },
                readyState: {
                    type: Boolean,
                    statePath: "ready",
                    observer: "_readyStateChaged"
                },
                loading: {
                    type: Boolean,
                    value: false
                },
                error: {
                    type: String,
                    value: ''
                },
                MQ: {
                    type: String,
                    statePath: 'MQ'
                },
                addTaskStubBlock: {
                    type: Object,
                    value: function () {
                        return this.$.slothStub.$.icon
                    }
                },
                breadcrumbs: {
                    type: Array,
                    value: []
                },
                maxBreadcrumbs: {
                    type: Number,
                    value: 7
                },
                filterItems: {
                    type: Array,
                    computed: '_computeFilterItems(project,language,i18Loaded,project.*)'
                },
                searchMode: {
                    type: Boolean,
                    value: false
                }
            },
            listeners: {
                'select-task': 'selectTask',
                'search': 'search',
                'task-normalize-positions': 'normalizePositions',
                'focus-input': 'focusInput',
                'reset': 'findDefaultTask',
                'mobile-go-back':'mobileGoBack',
                'cancel-search':'cancelSearch'
            },
            /**
             * Create new task on level 1.
             */
            addTask: function () {
                if (!this.taskName) return;
                if (!this.validate()) return this.showErrorMessage('Task title is wrong!');
                this.dispatch('addTask', {
                    _id: this.generateUid(),
                    name: this.taskName,
                    path: null,
                    parent: null,
                    owner: this.user._id,
                    status: 'incomplete',
                    created: moment(),
                    expired: null
                }).then(function (response) {
                    this.showMessage('Task was added successfully.');
                    this.selectTask({detail: response.task});
                    //Hints
                    this.doneHint('addTask','tm',function(){
                        this.$.list.overviewTaskHintTarget = this.$.list.$$('*[data-task-id="'+response.task._id+'"]');
                    }.bind(this));
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
                this.taskName = '';
            },
            validate: function () {
                return !/[\#\?\\\%\/\:]/.test(this.taskName);
            },
            changeMode: function () {
                this.mode = this.mode == 'list' ? 'details' : 'list';
            },
            computeRightIcon: function (mode) {
                return mode != 'list' ? 'designmap40:task' : 'designmap-notify:new-task';
            },
            computeListState: function (length) {
                return !!length;
            },
            computeDetailsState: function (length, selectedTask) {
                return !!length && selectedTask;
            },
            computeOverviewState: function (length, selectedTask) {
                return length && !selectedTask;
            },
            computeNoTasksState: function (length, loading, error) {
                return !length && !loading && !error;
            },
            loadingState: function (loading, error) {
                return !!loading && !error;
            },
            errorState: function (loading, error) {
                return !loading && !!error;
            },
            _computeProjectState: function (state) {
                return state;
            },
            _computeBackUrl: function (projectId) {
                return '/' + (projectId || '');
            },
            _arrowBackAction: function(){
                //if(this.MQ!=='sm') return page.redirect('/' + (this.projectId || ''));
                if(this.MQ=='sm') this.mobileGoBack();
            },
            selectTask: function (e) {
                if(this.selectedTask && this.selectedTask.parent!=e.detail.parent) this.$.list.limit = this.$.list.defaultLimit;
                if(this.selectedTask && this.selectedTask.parent==e.detail.parent) this.$.details.$.list.limit = this.$.list.defaultLimit;
                this.cancelSearch();
                page.redirect('/' + this.projectId + '/task-manager' + this.getFullPath(e.detail));
            },
            focusInput: function () {
                this.$.details.focusInput();
            },
            _computedAuth: function (user) {
                return !!user;
            },
            _pathChanged: function (path) {
                //if (path == '/' && !this.selectedTask && !this.isMobile()) return this.findDefaultTask();
                const task = this.findTaskByPath(path);
                if(!task) return;
                this.selectedTask = task;
                //this.$.list.resetFilter();
            },
            _readyStateChaged: function(){
                this._pathChanged(this.path);
            },
            findDefaultTask: function () {
                // Last on first level
                const firstLevelTasks = this.tasks.filter(function (task) {
                    return task.parent == null;
                }.bind(this));
                const task = firstLevelTasks[firstLevelTasks.length - 1];
                if (!task) return page.redirect('/' + this.projectId + '/task-manager/');
                page.redirect('/' + this.projectId + '/task-manager' + this.getFullPath(task));
            },
            mobileGoBack: function(){
                if(this.MQ!='sm') return;
                // Mobile>>> If we are inside
                if(this.selectedTask && this.selectedTask.parent) {
                    var task = this.findTaskById(this.selectedTask.parent);
                    return page.redirect('/'+this.projectId+'/task-manager/'+this.getFullPath(task));
                }
                // If task doesn't have parent
                if(this.selectedTask && !this.selectedTask.parent) {
                    this.selectedTask = false
                    return page.redirect('/'+this.projectId+'/task-manager/');
                }
                // If we are on list
                return page.redirect('/' + (this.projectId || ''));
            },
            /**
             * Re-render task-details
             * after any changes
             */
            tasksChanged: function(){
                if(!this.selectedTask) return;
                const task = Object.assign({},this.findTaskById(this.selectedTask._id));
                this.selectedTask = task;
            },
            _isThereSelectedTaskClass: function(selectedTask){
                return !!selectedTask ? 'selected-task' : 'no-task';
            },
            _computedAuth: function(user) {
                return !!user;
            },
            _isAuthChanged: function (isAuth) {
                if (!isAuth) return;
                // Start FileSystem tutorial
                if(this.tasks && this.tasks.length) return;
                const MQ = ReduxStore.getState().MQ;
                /*if(this.user && this.user.system && this.user.system.tutorials && this.user.system.tutorials.tm && MQ!='sm') {
                    const user = Object.assign({},this.user);
                    const tutorial = document.querySelector('designmap-app').$.tmTutorial;
                    user.system.tutorials.tm = true;
                    this.dispatch('userUpdate',user);
                    this.async(function(){tutorial.start();},1000);
                }*/
            },
            /**
             * Breadcrumbs will be calculated
             * using parent path of all tasks before
             * basic
             */
            calculateBreadCrumbs: function () {
                if (!this.selectedTask) return;
                var task = this.selectedTask;
                this.unshift('breadcrumbs', {id: task._id, title: task.name});
                while (task.parent) {
                    task = this.findTaskById(task.parent);
                    this.unshift('breadcrumbs', {id: task._id, title: task.name});
                }
                if (this.breadcrumbs.length > this.maxBreadcrumbs) {
                    this.set('breadcrumbs', this.breadcrumbs.slice(this.breadcrumbs.length - this.maxBreadcrumbs, this.breadcrumbs.length))
                    //this.push('breadcrumbs', {id: this.selectedTask._id, title: this.selectedTask.name});
                }
            },
            _selectedTaskChanged: function(){
                this.set('breadcrumbs', []);
                this.calculateBreadCrumbs();
            },
            /**
             * Redirect parent task
             * @param e
             */
            goToParent: function (e) {
                var task = this.findTaskById(e.model.crumb.id);
                this.selectTask({detail:task})
            },
            /**
             * Redirect parent task
             * @param e
             */
            goOnTop: function (e) {
                var task = this.findTaskById(this.breadcrumbs[0].id);
                this.selectTask({detail:task})
            },
            calculateSelectedCrumb: function (length, index) {
                return (length - 1) == index ? 'selected' : '';
            },
            _showBack: function(selectedTask,MQ){
                return selectedTask && MQ=='sm';
            },
            _titleCls: function(selectedTask,MQ){
                return selectedTask && MQ=='sm' ? 'arrowmq' : '';
            },
            normalizePositions: function(){
                this.$.list.normalizePositions();
            },

            _computeFilterItems: function(project,lng,loaded,splices) {
                const users = project ? project.users.concat([project.ownerData]) : [];
                const userOpts = [
                    {
                        value: 'all',
                        label: 'Any'
                    }
                ].concat(users.map(function(user){
                    return {
                        value: user._id,
                        label: this.computeOwnerName(user)
                    }
                }.bind(this)));
                const labels = project&&project.settings&&project.settings.taskManager?project.settings.taskManager.labels:[];
                const data = [
                    {
                        name:'owner',
                        type: 'select',
                        default: 'all',
                        options: userOpts
                    },
                    {
                        name:'assignee',
                        type: 'select',
                        default: 'all',
                        options: userOpts
                    },
                    {
                        name:'status',
                        type: 'select',
                        default: 'all',
                        options: [
                            {
                                value: 'all',
                                label: this.translate('Any')
                            },
                            {
                                value:'incomplete',
                                label: this.translate('incomplete')
                            },
                            {
                                value:'in_progress',
                                label: this.translate('in_progress')
                            },
                            {
                                value:'completed',
                                label: this.translate('completed')
                            }
                        ]
                    }
                ];
                if(labels.length) data.push({
                    name:'label',
                    type: 'select',
                    default: 'all',
                    options: [{
                        value: 'all',
                        label: 'Any'
                    }].concat(labels.map(function(label){
                        return {
                            value: label.label,
                            label: label.label
                        }
                    }))
                });

                return data
            },

            search: function(e){
                this.searchMode = true;
                this.selectedTask = null;
                this.async(function(){
                    this.$.list.search(e.detail);
                })
            },

            cancelSearch: function() {
                this.searchMode = false;
                this.$.searchFilter.empty();
                page.redirect('/'+this.projectId+'/task-manager/');
            }
        })
    </script>
</dom-module>
