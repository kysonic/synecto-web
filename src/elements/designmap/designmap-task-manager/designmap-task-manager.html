<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../designmap-ui/designmap-dashboard.html?20170615">
<link rel="import" href="../designmap-icons/designmap-task-manager.html?20170615">
<link rel="import" href="../designmap-icons/designmap-workspace-icons.html?20170615">
<link rel="import" href="./designmap-task-list.html?20170615">
<link rel="import" href="./designmap-task-details.html?20170615">
<link rel="import" href="../designmap-ui/designmap-stub.html?20170615">
<link rel="import" href="../designmap-tutorial/designmap-hint.html?20170615">
<!-- Redux -->
<link rel="import" href="../../../redux/redux-store.html?20170615">
<link rel="import" href="../../../redux/actions/combine-actions.html?20170615">
<link rel="import" href="../../../redux/actions/files-actions.html?20170615">
<link rel="import" href="../../../redux/actions/project-actions.html?20170615">
<link rel="import" href="../../../redux/actions/user-actions.html?20170615">
<link rel="import" href="../../../redux/actions/tasks-actions.html?20170615">
<link rel="import" href="../../../redux/actions/comments-action.html?20170615">
<!-- Services -->
<link rel="import" href="./deaignmap-task-service.html?20170615">
<link rel="import" href="../../../behaviors/designmap-socket-behavior.html?20170615">
<!-- Styles -->
<link rel="import" href="../../../styles/loading-shared-styles.html?20170615">

<dom-module id="designmap-task-manager">
    <template>
        <style include="loading-shared-styles"></style>
        <style>
            :host {
                --title-color: var(--blue-darky-color);
                --taskmanager-color: var(--gray-saturated-color);
            }

            *[hidden] {
                display: none !important;
            }

            :host > .wrapper > .content {
                display: flex;
                height: calc(100vh - 120px);
            }

            .dashboard {
                width: 100%;
                height: 45px;
                display: flex;
                align-items: center;
                background: var(--white-color);
                position: relative;
            }

            .dashboard .title {
                font-size: 26px;
                font-weight: 100;
                display: inline-block;
                flex: 1;
                cursor: pointer;
                white-space: nowrap;
                color: var(--title-color);
                margin-left: 5px;
            }

            .arrow-back {
                border-radius: 50%;
                margin-left: 18px;
                cursor: pointer;
                transition: background .2s ease-in;
            }

            .arrow-back:hover {
                background: var(--gray-lightern-color);
                transition: background .2s ease-in;
            }

            .arrow-back iron-icon {
                width: 50px;
                height: 50px;
                transform: rotate(223deg);
                --iron-icon-components-mixin: {
                    stroke: var(--primary-color) !important;
                    stroke-width: 2px !important;
                }
            }

            .no-task {
                width: 100%;
                height: 100%;
            }

            .loading, .error {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .error {
                color: red;
            }

            designmap-task-details.no-task{
                display: none;
            }

            @media (min-width: 320px) and (max-width: 768px) {
                .hidden-xs {
                    display: none;
                }
                designmap-task-list.no-task, designmap-task-details.selected-task {
                    display: block;
                }
                designmap-task-list.selected-task, designmap-task-details.no-task{
                    display: none;
                }
                designmap-task-details {
                    margin-top: 0px;
                }
            }


        </style>
        <div class="wrapper">
            <designmap-dashboard hidden$="[[projectError]]" back on-go-back="_arrowBackAction">
                <div class="title">
                    <i18-n msgid="Task manager">Task manager</i18-n>
                    <i18-n class="hidden-xs" msgid="of project">of project</i18-n>
                    <span class="hidden-xs">&laquo;[[project.name]]&raquo;</span>
                </div>
            </designmap-dashboard>
            <div class$="content [[mode]]">
                <designmap-task-list class$="[[_isThereSelectedTaskClass(selectedTask)]]" hidden$="[[!computeMainState(tasks.length)]]" id="list"
                                     selected="{{selectedTask}}" filter selecting></designmap-task-list>
                <designmap-task-details class$="[[_isThereSelectedTaskClass(selectedTask)]]" hidden$="[[!computeMainState(tasks.length)]]"
                                        id="details" task="[[selectedTask]]"></designmap-task-details>
                <div class="no-task" hidden$="[[!computeNoTasksState(tasks.length,loading,error)]]">
                    <designmap-stub id="slothStub" value="{{taskName}}" on-action="addTask"
                                    image="designmap-workspace-stub:sloth" message="You do not have tasks yet"
                                    input-text="Add task" input-error="AddTaskError"></designmap-stub>
                    <!-- Hint -->
                    <designmap-hint id="addTaskHint" target="[[addTaskStubBlock]]" name="addTask" vertical-offset="20"
                                    horizontal-offset="-20">
                        <div class="title">
                            <i18-n msgid="Add a task">Add a task</i18-n>
                        </div>
                        <div class="desc">
                            <i18-n msgid="addTaskMsg">addTaskMsg</i18-n>
                        </div>
                    </designmap-hint>
                </div>
               <div id="projectLoading" hidden$="[[!loadingState(loading,error)]]" class="loading-overlay">
                    <div class="uil-reload-css">
                        <div></div>
                    </div>
                </div>
                <div class="error" hidden$="[[!errorState(loading,error)]]">
                    <designmap-stub image="designmap-workspace-stub:error" message="[[error]]"
                                    error></designmap-stub>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-manager',
            behaviors: [
                ReduxBehavior,
                Polymer.IronResizableBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapTaskService,
                Polymer.DesignmapSocketBehavior,
                Polymer.CombineActions(Polymer.ProjectActions, Polymer.TasksActions, Polymer.FilesActions, Polymer.CommentsActions)
            ],
            properties: {
                /**
                 * Language
                 */
                language: {
                    type: String,
                    statePath: 'language'
                },
                user: {
                    type: Object,
                    statePath: 'user'
                },
                isAuth: {
                    type: Boolean,
                    computed: '_computedAuth(user)',
                    observer: '_isAuthChanged'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                taskName: {
                    type: String,
                    value: ''
                },
                mode: {
                    type: String,
                    value: 'list'
                },
                selectedTask: {
                    type: Object,
                    value: null
                },
                projectLoading: {
                    type: Boolean,
                    computed: "_computeProjectState(project.loading)"
                },
                projectError: {
                    type: Boolean,
                    computed: "_computeProjectState(project.error)"
                },
                tasks: {
                    type: Array,
                    statePath: 'tasks',
                    observer: 'tasksChanged'
                },
                projectId: {
                    type: String,
                    statePath: 'projectId'
                },
                project: {
                    type: Object,
                    statePath: "project"
                },
                path: {
                    type: String,
                    statePath: "path",
                    observer: "_pathChanged"
                },
                loading: {
                    type: Boolean,
                    value: false
                },
                error: {
                    type: String,
                    value: ''
                },
                MQ: {
                    type: String,
                    statePath: 'MQ'
                },
                addTaskStubBlock: {
                    type: Object,
                    value: function () {
                        return this.$.slothStub.$.icon
                    }
                }
            },
            listeners: {
                'select-task': 'selectTask',
                'focus-input': 'focusInput',
                'reset': 'findDefaultTask',
                'mobile-go-back':'mobileGoBack'
            },
            /**
             * Create new task on level 1.
             */
            addTask: function () {
                if (!this.taskName) return;
                if (!this.validate()) return this.showErrorMessage('Task title is wrong!');
                this.dispatch('addTask', {
                    _id: this.generateUid(),
                    name: this.taskName,
                    path: null,
                    parent: null,
                    owner: this.user._id,
                    status: 'incomplete',
                    created: moment(),
                    expired: moment().day(10)
                }).then(function (response) {
                    this.showMessage('Task was added successfully.');
                    this.selectTask({detail: response.task});
                    //Hints
                    const tutorial = document.querySelector('designmap-app').$.tmTutorial;
                    if(tutorial && tutorial.isRunning=='addTask') {
                        tutorial.close();
                        this.async(function(){
                            this.$.list.overviewTaskHintTarget = this.$.list.$$('*[data-task-id="'+response.task._id+'"]');
                            tutorial.thumbUp();
                            this.async(function(){tutorial.next();},500);
                        },100);
                    }
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
                this.taskName = '';
            },
            validate: function () {
                return !/[\#\?\\\%\/\:]/.test(this.taskName);
            },
            changeMode: function () {
                this.mode = this.mode == 'list' ? 'details' : 'list';
            },
            computeRightIcon: function (mode) {
                return mode != 'list' ? 'designmap40:task' : 'designmap-notify:new-task';
            },
            computeMainState: function (length) {
                return !!length;
            },
            computeNoTasksState: function (length, loading, error) {
                return !length && !loading && !error;
            },
            loadingState: function (loading, error) {
                return !!loading && !error;
            },
            errorState: function (loading, error) {
                return !loading && !!error;
            },
            _computeProjectState: function (state) {
                return state;
            },
            _computeBackUrl: function (projectId) {
                return '/' + (projectId || '');
            },
            _arrowBackAction: function(){
                if(this.MQ!=='sm') return page.redirect('/' + (this.projectId || ''));
                this.mobileGoBack();
            },
            selectTask: function (e) {
                page.redirect('/' + this.projectId + '/task-manager' + this.getFullPath(e.detail));
            },
            focusInput: function () {
                this.$.details.focusInput();
            },
            _computedAuth: function (user) {
                return !!user;
            },
            /**
             * Get all project data
             */
            getProjectData: function () {

            },
            _pathChanged: function (path) {
                if (path == '/' && !this.selectedTask && this.MQ!=='sm') return this.findDefaultTask();
                const task = this.findTaskByPath(path);
                if (!task) return;
                this.selectedTask = task;
                this.$.list.resetFilter();
            },
            findDefaultTask: function () {
                // Last on first level
                const firstLevelTasks = this.tasks.filter(function (task) {
                    return task.parent == null;
                }.bind(this));
                const task = firstLevelTasks[firstLevelTasks.length - 1];
                if (!task) return page.redirect('/' + this.projectId + '/task-manager/');
                page.redirect('/' + this.projectId + '/task-manager' + this.getFullPath(task));
            },
            mobileGoBack: function(){
                if(this.MQ!='sm') return;
                // Mobile>>> If we are inside
                if(this.selectedTask && this.selectedTask.parent) {
                    var task = this.findTaskById(this.selectedTask.parent);
                    return page.redirect('/'+this.projectId+'/task-manager/'+this.getFullPath(task));
                }
                // If task doesn't have parent
                if(this.selectedTask && !this.selectedTask.parent) {
                    this.selectedTask = false
                    return page.redirect('/'+this.projectId+'/task-manager/');
                }
                // If we are on list
                return page.redirect('/' + (this.projectId || ''));
            },
            /**
             * Re-render task-details
             * after any changes
             */
            tasksChanged: function(){
                if(!this.selectedTask) return;
                const task = Object.assign({},this.findTaskById(this.selectedTask._id));
                this.selectedTask = task;
            },
            _isThereSelectedTaskClass: function(selectedTask){
                return !!selectedTask ? 'selected-task' : 'no-task';
            },
            _computedAuth: function(user) {
                return !!user;
            },
            _isAuthChanged: function (isAuth) {
                if (!isAuth) return;
                // Start FileSystem tutorial
                if(this.tasks.length) return;
                if(this.user && this.user.system && this.user.system.tutorials && !this.user.system.tutorials.tm && this.MQ!='sm') {
                    const user = Object.assign({},this.user);
                    const tutorial = document.querySelector('designmap-app').$.tmTutorial;
                    /*user.system.tutorials.tm = true;
                    this.dispatch('userUpdate',user);*/
                    this.async(function(){tutorial.start();},1000);
                }
            }
        })
    </script>
</dom-module>
