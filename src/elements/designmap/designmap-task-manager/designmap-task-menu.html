<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="./designmap-task-manager-labels.html">


<dom-module id="designmap-task-menu">
    <template>
        <style>
            :host {
                display: block;
                padding-right: 10px;
            }
            *[hidden] {
                display: none !important;
            }
            ul.menu {
                margin: 0;
                padding: 0;
                list-style: none;
                color: var(--gray-darkend-color);
            }
            li.item {
                cursor: pointer;
                display: flex;
                align-items: center;
                padding: 10px 5px;
                transition: .2s background ease-in;
            }
            li.item:hover {
                background: var(--gray-lightern-color);
                transition: .2s background ease-in;
            }
            li.item[disabled] {
                opacity: 0.6;
            }
            .item-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-left: 5px;
            }

            designmap-task-manager-labels {
                display: inline-block;
                margin-left: 5px;
                max-width: calc(100% - 29px);
            }

        </style>
        <ul class="menu">
            <li id="complete" disabled$="[[_isCompleted(task)]]" class="item" on-tap="_completeTask">
                <iron-icon icon="designmap-task-menu:finish"></iron-icon>
                <i18-n class="item-text" msgid="complete a task">complete a task</i18-n>
            </li>
            <paper-tooltip for="complete">
                <i18-n msgid="Complete task">Complete task</i18-n>
            </paper-tooltip>
            <li id="labelsItem"
                on-mouseover="_showLabelsSettings"
                on-mouseleave="_hideLabelsSettings"
                class="item"
                hidden$="[[_hideLabels(user,project,labels)]]">
                <iron-icon icon="designmap-task-menu:label"></iron-icon>
                <designmap-task-manager-labels label="[[task.label]]" on-change="_labelChanged" id="labels"></designmap-task-manager-labels>
            </li>
            <li class="item">
                <iron-icon icon="designmap-task-menu:difficulty"></iron-icon>
                <i18-n class="item-text" msgid="difficulty">difficulty</i18-n>
            </li>
            <li class="item">
                <iron-icon icon="designmap-task-menu:date"></iron-icon>
                <span class="item-text">[[_computeTimeLeft(task)]]</span>
            </li>
            <li class="item">
                <iron-icon icon="designmap-task-menu:track"></iron-icon>
                <span class="item-text">[[_computeTime(task.time,spentTime)]]</span>
            </li>
            <li class="item">
                <iron-icon icon="designmap-task-menu:attach"></iron-icon>
                <span class="item-text">
                    <span class="attach-file"><i18-n msgid="attach">attach</i18-n></span>
                </span>
            </li>
        </ul>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-menu',
            behaviors: [
                Polymer.DesignMapMessagesBehavior
            ],
            properties: {
                task: {
                    type: Object,
                    value:{}
                },
                spentTime: {
                    type: Number,
                    value: 0
                }
            },

            listeners: {
                'settings-dropdown-close':'settingsDropdonwClose'
            },

            _computeTimeLeft: function (task) {
                if(task && task.status=='completed') return this.translate('completed');
                if (task && !task.expired) return this.translate('due date');
                const diff = moment.duration(moment(task?task.expired:0).diff(moment()));
                if (diff._milliseconds < 0) return this.translate('expired');
                return (diff.asDays() > 1 ? (Math.round(diff.asDays()) + ' ' + this.translate('days')) : Math.round(diff.asHours()) + ' ' + this.translate('hours'));
            },

            _computeTime: function (time, spentTime) {
                if (!time) return '00:00';
                if (spentTime) return this._buildTimeString(spentTime);
                return (time.spent ? this._buildTimeString(time.spent) : '00:00');
            },

            _buildTimeString: function (spent) {
                const sec_num = parseInt(spent / 1000, 10);
                const hours = Math.floor(sec_num / 3600) % 24;
                const minutes = Math.floor(sec_num / 60) % 60;
                const seconds = sec_num % 60;
                return [hours, minutes, seconds]
                    .map(v => v < 10 ? "0" + v : v)
                    .filter((v, i) => v !== "00" || i > 0)
                    .join(":")
            },

            _completeTask: function () {
                this.fire('change-status','completed');
            },

            _isCompleted: function(task){
                if(!task) return false;
                return task.status=='completed';
            },

            _showLabelsSettings: function(){
                this.$.labels.classList.add('show-settings');
            },

            _hideLabelsSettings: function(){
                if(this.$.labels.$.settingsDropdown.opened) return;
                this.$.labels.classList.remove('show-settings');
            },

            settingsDropdonwClose: function(){
                this.$.labels.classList.remove('show-settings');
            },

            _labelChanged: function(){

            }
        })
    </script>
</dom-module>
