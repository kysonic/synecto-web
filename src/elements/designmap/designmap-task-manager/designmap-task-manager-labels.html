<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="../../reworked/paper-color-picker/paper-color-picker.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../plastic/plastic-select.html">
<link rel="import" href="../designmap-ui/designmap-dropdown.html">
<link rel="import" href="../designmap-fs/designmap-fs-service.html">

<dom-module id="designmap-task-manager-labels">
    <template>
        <style>
            :host {
                display: inline-block;
                color: var(--gray-darkend-color);
                text-transform: lowercase;
                vertical-align: middle;
                position: relative;
                /** PAPER_INPUT **/
                --paper-input-container-color: var(--gray-darkend-color);
                --paper-input-container-focus-color: var(--gray-darkend-color);
                --paper-input-container-input: {
                    color: var(--gray-darkend-color);
                    font-family: var(--font-family);
                    font-size: 16px;
                    font-weight: 300 !important;
                };
                --paper-input-container-label: {
                    font-size: 16px;
                    font-weight: 300 !important;
                };
                --paper-input-container-label-floating: {
                    font-weight: 300 !important;
                };
                --paper-input-container-invalid-color: var(--error-color);
            }
            #dropdown {
                --designmap-dropdown-triangle-mixin: {
                    left: 100%;
                    margin-left: -60px;
                };
                --designmap-dropdown-triangle-border-mixin: {
                    left: 100%;
                    margin-left: -60px;
                }
            }
            *[hidden] {
                display: none !important;
            }
            .label {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
            }
            .gear-button {
                position: absolute;
                opacity: 0;
                left: 0;
                @applay(--designmap-task-manager-labels-gear-button-mixin)
            }
            :host(.show-settings) .gear-button{
                opacity: 1;
                left: -68px;
                top: -8px;
                transition: .2s opacity,.2s left;
            }
            /** Dropdown **/
            .label-editor {
                padding: 20px;
            }
            .add-field {
                width: 100%;
            }
            .add-field paper-input {
                display: inline-block;
                width: calc(100% - 85px);
                margin-left: 10px;
            }
            .add-field .add-icon {
                display: inline-block;
            }
            .color {
                display: inline-block;
                width: 20px;
                height: 20px;
                vertical-align: middle;
                border: 1px solid var(--gray-color);
                position: relative;
                top: 2px;
            }
            .select {
                display: inline-block;
                width: auto;
            }
            .labels .label > * {
                display: inline-block;
                vertical-align: middle;
                text-transform: none;
            }
            .labels .label .name {
                max-width: 145px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .labels .label iron-icon {
                width: 20px;
                height: 20px;
            }
        </style>
        <div class="label" on-tap="openDropdown">[[_computeLabel(label)]]</div>
        <paper-icon-button class="gear-button" hidden$="[[!_isProjectOwner(project,user)]]" icon="icons:settings" on-tap="openSettingsDropdown"></paper-icon-button>
        <designmap-dropdown id="dropdown" tri-border vertical-offset="20" horizontal-offset="-150">
            <ul class="labels">
                <template is="dom-repeat" items="[[labels]]" as="label">
                    <li class="label">
                        <div class="color" style$="[[_getColorStyle(label.color)]]"></div>
                        <div class="name" title="[[label.label]]">[[label.label]]</div>
                    </li>
                </template>
            </ul>
        </designmap-dropdown>
        <!-- Dropdown -->
        <designmap-dropdown id="settingsDropdown" on-close="settingsDropdownClose" tri-border vertical-offset="20" horizontal-offset="-183">
            <div class="label-editor">
                <div class="labels">
                    <template is="dom-repeat" items="[[labels]]" as="label">
                        <div class="label">
                            <div class="color" style$="[[_getColorStyle(label.color)]]"></div>
                            <div class="name" title="[[label.label]]">[[label.label]]</div>
                            <iron-icon on-click="edit" icon="icons:create"></iron-icon>
                            <iron-icon on-click="removeLabel" icon="icons:close"></iron-icon>
                        </div>
                    </template>
                </div>
                <form id="form" is="iron-form" class="add-field">
                    <div class="color" on-click="openColorPicker" style$="[[_getColorStyle(color,color.*)]]"></div>
                    <paper-input id="label" auto-validate required label="[[translate('Add new label',language,i18Loaded)]]"></paper-input>
                    <paper-color-picker color="{{color}}" immediateColor="[[immediateColor]]" id="colorPicker"></paper-color-picker>
                    <paper-icon-button on-click="addLabel" class="add-icon" icon="[[_computeIcon(editMode)]]"></paper-icon-button>
                </form>
            </div>
        </designmap-dropdown>
    </template>
    <script>
        Polymer({
            is: 'designmap-task-manager-labels',
            behaviors: [
                ReduxBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapFsService,
                Polymer.CombineActions(Polymer.ProjectActions)
            ],
            properties: {
                project: {
                    type: Object,
                    statePath:'project'
                },
                label: {
                    type: String
                },
                projects: {
                    type: Array,
                    statePath:'projects'
                },
                user: {
                    type: Object,
                    statePath:'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    value: false
                },
                labels: {
                    type: Array,
                    computed: '_computeLabels(project.settings.taskManager.labels)'
                },
                color: {
                    type: Object,
                    value: {
                        red: 100,
                        green: 226,
                        blue: 233,
                        alpha: 1
                    }
                },
                immediateColor: {
                    type: Object,
                    value: {
                        red: 100,
                        green: 226,
                        blue: 233,
                        alpha: 1
                    }
                },
                editMode: {
                    type: Boolean,
                    value: false
                }
            },
            _computeLabels: function(labels){
                return labels || [];
            },
            _getLabels: function(labels){
                return labels.map(function(label){
                    return {
                        value: label.label,
                        label: label.label
                    }
                });
            },
            openDropdown: function(){
                this.$.dropdown.toggle();
            },
            openSettingsDropdown: function(){
                if(!this._isProjectOwner()) return false;
                this.$.settingsDropdown.toggle();
            },
            _isProjectOwner: function(){
                if(!this.project || !this.user) return false;
                return this.project.owner==this.user._id;
            },
            openColorPicker: function(){
                this.$.colorPicker.open();
            },
            _getColorStyle: function(color) {
                return 'background:rgb('+color.red+','+color.green+','+color.blue+');';
            },
            addLabel: function(){
                if(this.editMode) return this.editLabel();
                if(!this.$.form.validate()) return this.showErrorMessage('Some of form fields is not valid');
                const label = {
                    label: this.$.label.value,
                    color: this.color
                };
                this.$.label.value = '';
                this.$.label.invalid = false;
                this.project.settings = this.project.settings || {taskManager:{labels:[]}};
                if(this.project.settings.taskManager && !Array.isArray(this.project.settings.taskManager.labels)) this.project.settings.taskManager.labels = [];
                this.project.settings.taskManager.labels.push(label);
                // Upd
                this._updateProject(this.project);
            },
            editLabel: function(){
                if(!this.$.form.validate()) return this.showErrorMessage('Some of form fields is not valid');
                const label = {
                    label: this.$.label.value,
                    color: this.color
                };
                this.$.label.value = '';
                this.$.label.invalid = false;
                const labels = this.project.settings.taskManager.labels;
                labels[labels.indexOf(this.editedLabel)] = label;
                this.editMode = false;
                // Upd
                this._updateProject(this.project);
            },
            removeLabel: function(e){
                const labels = this.project.settings.taskManager.labels;
                labels.splice(labels.indexOf(e.model.label),1);
                // Upd
                this._updateProject(this.project);
            },
            _updateProject: function(project) {
                this.dispatch('updateProject',this.project._id,this.project).then(function(response){
                    if(!response.success) return;
                    // Update
                    this.set('project.settings.taskManager.labels',response.project.settings.taskManager.labels);
                    this.async( this.$.dropdown.refit);
                }.bind(this));
            },
            _computeIcon: function (editMode) {
                return !editMode ? 'icons:add' : 'icons:check';
            },
            edit: function(e){
                this.$.label.value = e.model.label.label;
                this.color = e.model.label.color;
                this.editMode = true;
                this.editedLabel = e.model.label;
                this.$.label.focus();
            },
            _computeLabel: function(label){
                if(!label || !this.labels[label]) return this.translate('select label...');
                return label;
            },
            settingsDropdownClose: function () {
                this.fire('settings-dropdown-close');
            }
        })
    </script>
</dom-module>
