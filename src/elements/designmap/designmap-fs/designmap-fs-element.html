<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">
<link rel="import" href="./designmap-fs-service.html">

<dom-module is="designmap-fs-element">
    <template>
        <style >
            :host {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                display: block;
                flex: 0 1 calc(100% / 5);
                height: 230px;
                box-sizing: border-box;

                --fs-element-selected-color: var(--gray-lightern-color);
                --fs-element-text: var(--gray-darky-color);
                --fs-folder-color: var(--gray-lighty-color);
                --fs-folder-line-color: var(--gray-saturate-color);

                --iron-image-width: 100%;
                --iron-image-height: 100%;
            }

            .element {
                max-width: 250px;
                min-width: 230px;
                height: 160px;
                position: relative;
                padding: 20px 20px 45px 20px;
            }

            :host(.selected) .element {
                background: var(--fs-element-selected-color);
                transition: background .1s ease-in;
            }

            .element:first-child, .element.dropzone.alone {
                margin-left: 0;
            }

            .element:hover .overlay {
                display: block;
            }

            .element .content {
                background: var(--fs-folder-color);
                cursor: pointer;
                position: relative;
                overflow: hidden;
                display: flex;
                align-items: center;
                width: 100%;
                height: 100%;
            }

            .element .content.file {
                background: url('/images/svg/three-dots-gray.svg') no-repeat center, repeating-linear-gradient(-45deg, var(--fs-folder-color), var(--fs-folder-line-color) 5px, rgba(256, 256, 256, 0.3) 5px, rgba(256, 256, 256, 0.3) 10px);
            }

            .type {
                color: #c4c4c4;
                text-align: center;
            }


            .element .label {
                width: 45%;
                height: 8px;
                display: block;
                background: var(--fs-folder-line-color);
            }

            .element .label.file {
                opacity: 0;
            }

            .element .name {
                color: var(--fs-element-text);
                font-size: 16px;
                font-family: 'Open Sans Light', 'Open Sans', sans-serif;
                font-weight: 100;
                margin-top: 10px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            .context-content {
                background: var(--blue-darkest-color);
            }

            .overlay {
                display: none;
                position: absolute;
                top: 0;
                bottom:0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.05);
            }
            .overlay iron-icon {
                cursor: pointer;
                position: absolute;
                left: 100%;
                margin-left: -34px;
                top: 100%;
                margin-top: -34px;
                border-radius: 50%;
                --iron-icon-stroke-color: var(--gray-darkend-color);
                --iron-icon-fill-color: var(--white-color);
                transition: .2s background;
            }
            .overlay iron-icon:hover {
                background: rgba(0,0,0,0.2);
                transition: .2s background;
            }

        </style>
        <!-- Element's markup -->
        <div class="element" id="element">
            <div class$="label [[item.type]]"></div>
            <div class$="content [[item.type]]" on-click="selectElement" on-contextmenu="openContextMenu" data-hint$="[[item.type]]" data-id$="[[item._id]]">
                <template is="dom-if" if="[[shouldViewImage(item)]]">
                    <iron-image class$="[[item.orientation]]" src="[[computeImageSource(item)]]" />
                </template>
                <div class="overlay">
                    <iron-icon on-click="openContextMenu" icon="icons:more-vert"></iron-icon>
                </div>
            </div>
            <div class="name">[[getElementName(item)]]</div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-fs-element',
            behaviors: [
                Polymer.DesignMapWebAnimationBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapFsService,
                ReduxBehavior
            ],
            canBeDisplayedExt: [".jpg", ".png", ".gif", ".ttf", ".rif", ".bmp", ".jpg", ".hdr", ".ppm", ".pbm",".psd",".eps",".ai"],
            properties: {
                /**
                 * Element's data
                 */
                item: {
                    type: Object,
                    value: {}
                },
                /**
                 * Element's data
                 */
                index: {
                    type: Number
                },
                /**
                 * Current folder id
                 */
                currentFolderId: {
                    type: String,
                    notify: true
                },
                /**
                 * App language
                 */
                user: {
                    type: String,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                /**
                 * Language was loaded
                 */
                i18Loaded: {
                    type: String,
                    statePath: 'i18Loaded'
                },
                /**
                 * Trash mode
                 */
                trashMode: {
                    type: Boolean,
                    value: false
                },
                /**
                 * ACL representation
                 */
                acl: {
                    type: Array
                },
                /**
                 * User's role
                 */
                role: {
                    type: String
                }
            },
            /**
             * Compute selected state for folder
             */
            computeSelectedClass: function (selected) {
                return selected ? 'selected' : '';
            },
            /**
             * Is there necessity to show image?
             */
            shouldViewImage: function (element) {
                return element.type == 'file' && (this.canBeDisplayedExt.indexOf('.' + this.getExtensionWithoutDot(element.data.name).toLowerCase()) != -1 || element.data.preview);
            },
            /**
             * Defines url for file
             * @param trash
             * @returns {*}
             */
            computeImageSource: function (element) {
                if (element.type != 'file') return '';
                return element.preview ? element.preview.url : element.data.url.replace('#SERVER#', Designmap.config.apiURL);
            },
            /**
             * Get extension of the file without dot
             */
            getExtensionWithoutDot: function (name) {
                if (!name) return null;
                var splitter = name.split('.');
                var ext = splitter[splitter.length - 1];
                return ext;
            },
            /**
             * Open context menu
             */
            openContextMenu: function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.fire('open-element-context-menu',{e: e, item: this.item});
            },
            /**
             * Select element
             */
            selectElement: function (e) {
                this.fire('select-element', {e: e, item: this.item});
            }
        })
    </script>
</dom-module>
