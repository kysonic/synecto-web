<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- Components -->
<link rel="import" href="./designmap-fs-element.html?v=12345?20170615">
<link rel="import" href="../designmap-ui/designmap-hidden-panel.html?20170615">
<link rel="import" href="../designmap-ui/designmap-file-uploader.html?20170615">
<link rel="import" href="../../plastic/plastic-custom-scroll.html?20170615">

<!-- Redux -->
<link rel="import" href="../../../redux/actions/folders-actions.html?20170615">
<link rel="import" href="../../../redux/actions/files-actions.html?20170615">
<!-- Services -->
<link rel="import" href="./designmap-fs-service.html?20170615">

<dom-module id="designmap-fs-elements">
    <template>
        <style include="context-menu-shared-styles">
            :host {

                display: block;
                position: relative;
                border: 2px dashed transparent;
                resize: both;
                width: calc(100% - 24px);
                height: calc(100% - 14px);

                --designmap-hidden-panel: {
                    height: var(--header-height);
                    background: var(--blue-color);
                    z-index: 99;
                };
                --plastic-custom-scroll-content-mixin: {
                    display: flex;
                    padding: 0;
                    width: auto;
                    justify-content: space-between;
                    flex-wrap: wrap;
                    max-height: calc(100vh - 160px);
                };
                --plastic-custom-scroll-content-after-mixin: {
                    content: "";
                    flex: auto;
                };
                --plastic-custom-scroll-bar-mixin: {
                    margin-left: -3px;
                };
                --plastic-custom-scroll-bar-hover-mixin: {
                    margin-left: -5px;
                };
                --plastic-custom-scroll-bar-grabbed-mixin: {
                    margin-left: -5px;
                };
                --designmap-circle-button-content-icon-mixin: {
                    padding: 40px;
                };
                --designmap-circle-button-circle-mixin: {
                    stroke: #fff !important;
                    stroke-width: 1px;
                }
            }

            :host(.dragged) .cloud{
                display: flex;
            }

            /** ELEMENTS **/
            plastic-custom-scroll {
                width: 100%;
            }


            /** WHITE SPACE **/
            .white-space {
                display: flex;
                width: 100%;
                height: 100%;
                align-items: center;
                justify-content: center;
            }

            .white-space .wrapper {
                width: 245px;
                height: 270px;
            }

            .white-space .wrapper iron-icon {
                width: 200px;
                height: 100%;
                position: relative;
                left: 42px;
            }

            .white-space .wrapper .text {
                font-weight: 100;
                text-align: center;
                color: var(--gray-saturated-color);
            }

            .white-space .wrapper .text a {
                color: var(--blue-darkest-color);
            }

            .elements {
                position: relative;
            }
            .cloud {
                display: none;
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left:0;
                pointer-events: none;
                align-items: center;
                justify-content: center;
            }
            .cloud iron-icon {
                --iron-icon-width: 240px;
                --iron-icon-height: 230px;
                --iron-icon-fill-color: var(--gray-color);
                --iron-icon-stroke-color: var(--gray-color);
            }
            @media (min-width: 320px) and (max-width: 540px) {
                .elements {
                    left: 10px;
                }
            }
        </style>
        <!-- Elements -->
        <template is="dom-if" if="[[elements.length]]">
            <div id="elementsWrapper" class="elements" hidden$="[[!elements.length]]">
                <plastic-custom-scroll id="fsElementsCustomScroll" fit small-bar>
                    <template id="elementsRepeater" is="dom-repeat" items="[[elements]]"
                              sort="[[elementsSort(sortWay)]]">
                        <designmap-fs-element item="[[item]]"
                                              id="element-[[index]]"
                                              type$="[[item.type]]"
                                              index="[[index]]"
                                              class$="[[_computeElementClass(item.cutted)]]"
                                              trash-mode="[[trashMode]]"
                                              data-element-id$="[[item._id]]"
                                              on-dblclick="applyAction"></designmap-fs-element>
                    </template>
                </plastic-custom-scroll>
            </div>
            <!-- Context menu -->
            <designmap-context-menu id="contextMenu" previous open-top="true">
                <ul class="menu">
                    <template is="dom-if" if="[[!trashMode]]">
                        <li on-click="applyAction">
                            <i18-n msgid="Open">Open</i18-n>
                        </li>
                        <template is="dom-if" if="[[isFolder(currentElement.type)]]">
                            <!--<li on-click="openAddFolderContext">
                                <i18-n msgid="AddSubFolder">AddSubFolder</i18-n>
                            </li>
                            &lt;!&ndash; Add folder &ndash;&gt;
                            <designmap-context-menu darker id="addFolderContext" previous>
                                <div class="context-content">
                                    <iron-a11y-keys id="a11yAddFolder" keys="enter"
                                                    on-keys-pressed="addFolderFromMenu"></iron-a11y-keys>
                                    <paper-input label="[[translate('Folder Name',language,i18Loaded)]]" auto-validate
                                                 pattern="[\w\dа-яА-ЯёЁ -]+"
                                                 error-message="[[translate('FolderNameError',language,i18Loaded)]]"
                                                 id="addFolder"></paper-input>
                                    <div class="button-container">
                                        <button is="designmap-round-button" on-click="addFolderFromMenu">
                                            <iron-icon icon="icons:arrow-forward"></iron-icon>
                                        </button>
                                    </div>
                                </div>
                            </designmap-context-menu>-->
                            <li on-click="openRenameFolderContext">
                                <i18-n msgid="Rename">Rename</i18-n>
                            </li>
                            <!-- Rename Folder -->
                            <designmap-context-menu bound darker id="renameFolderContext" previous>
                                <div class="context-content">
                                    <iron-a11y-keys id="a11yAddFolder" keys="ctrl+enter meta+enter"
                                                    on-keys-pressed="renameFolder"></iron-a11y-keys>
                                    <paper-input label="[[translate('Folder Name',language,i18Loaded)]]" auto-validate
                                                 pattern="[\w\dа-яА-ЯёЁ -]+"
                                                 error-message="[[translate('FolderNameError',language,i18Loaded)]]"
                                                 id="renameFolder"></paper-input>
                                    <div class="button-container">
                                        <button is="designmap-round-button" on-click="renameFolder">
                                            <iron-icon icon="icons:arrow-forward"></iron-icon>
                                        </button>
                                    </div>
                                </div>
                            </designmap-context-menu>
                            <!-- Open file uploader -->
                            <!--<li on-click="openFileUploader">
                                <i18-n msgid="Add file">Add file</i18-n>
                            </li>-->
                        </template>
                        <template is="dom-if" if="[[isFile(currentElement.type)]]">
                            <li on-click="download">
                                <i18-n msgid="Download">Download</i18-n>
                            </li>
                            <li on-click="openRenameFileContext">
                                <i18-n msgid="Rename">Rename</i18-n>
                            </li>
                            <!-- Rename Folder -->
                            <designmap-context-menu bound darker id="renameFileContext" previous>
                                <div class="context-content">
                                    <iron-a11y-keys id="a11yAddFolder" keys="ctrl+enter meta+enter"
                                                    on-keys-pressed="renameFile"></iron-a11y-keys>
                                    <paper-input label="[[translate('File name',language,i18Loaded)]]"
                                                 id="renameFile"></paper-input>
                                    <div class="button-container">
                                        <button is="designmap-round-button" on-click="renameFile">
                                            <iron-icon icon="icons:arrow-forward"></iron-icon>
                                        </button>
                                    </div>
                                </div>
                            </designmap-context-menu>
                        </template>
                    </template>
                    <template is="dom-if" if="[[trashMode]]">
                        <li on-click="restoreElement">
                            <i18-n msgid="Restore">Restore</i18-n>
                        </li>
                    </template>
                    <li on-click="cutElement">
                        <i18-n msgid="Cut">Cut</i18-n>
                    </li>
                    <li on-click="openInformation">
                        <i18-n msgid="Information">Information</i18-n>
                    </li>
                    <li hidden$="[[!_canRemove(user.role,trashMode)]]" on-click="removeElement">
                        <i18-n msgid="Remove">Remove</i18-n>
                    </li>
                </ul>
            </designmap-context-menu>
            <!-- Context menu -->
        </template>
        <template is="dom-if" if="[[!elements.length]]">
            <div class="white-space">
                <div class="wrapper">
                    <div class="text" hidden$="[[trashMode]]">
                        <i18-n msgid="Drag files here"></i18-n>
                        <a href="#" on-click="openContextMenu">
                            <i18-n msgid="create"></i18-n>
                        </a>
                        <i18-n msgid="new folder"></i18-n>
                    </div>
                    <div class="text" hidden$="[[!trashMode]]">
                        <i18-n msgid="Trash bin is empty..."></i18-n>
                    </div>
                    <iron-icon icon="[[computeWhiteSpaceIcon(trashMode)]]"></iron-icon>
                    <!--<div class="text" hidden$="[[!trashMode]]">
                      <i18-n msgid="Your elements has been recycled"></i18-n>
                    </div>-->
                </div>
            </div>
        </template>
        <!-- Associated components -->
        <designmap-hidden-panel target="[[bodyNode]]" position="top"
                                cancel-auto-closing
                                opened="[[computeHiddenPanelState(selected.length)]]">
            <div class="select-panel-content">
                <designmap-circle-button class="cancel-selecting" on-click="cleanSelected">
                    <iron-icon icon="designmap:add" style="transform: rotate(45deg)"></iron-icon>
                </designmap-circle-button>
                <div class="selected">
                    [[selected.length]]
                    <i18-n msgid="selected">selected</i18-n>
                </div>
                <div class="button-set">
                    <button is="designmap-button" class="no-unselect" hidden="[[!trashMode]]"
                            on-click="restoreSelectedElements" thin>
                        <i18-n msgid="Restore">Restore</i18-n>
                    </button>
                    <button is="designmap-button" class="no-unselect" on-click="removeSelectedElements" thin>
                        <i18-n msgid="Remove">Remove</i18-n>
                    </button>
                </div>
            </div>
        </designmap-hidden-panel>
        <!-- Confirms -->
        <designmap-confirm id="removingSelectedConfirm" message="AreYouSureThatYouWannaDeleteSelectedObjects"
                           on-continue="removeSelectedElementsIrretrievably"
                           on-suspend="suspendRemoving"></designmap-confirm>
        <designmap-confirm id="removingConfirm" message="AreYouSureThatYouWannaDeleteObject"
                           on-continue="removeElementIrretrievably" on-suspend="suspendRemoving"></designmap-confirm>
        <!-- Uploader -->
        <designmap-file-uploader id="uploader" parent="folder" _id="[[currentFolderId]]"
                                 files="[[getFiles(elements)]]" allowed-extension='[[allowedExtensions]]'></designmap-file-uploader>
        <!-- Hints -->
        <designmap-hint id="openContextMenuHint" target="[[hintFolderTarget]]" name="openContextMenu" vertical-offset="200" horizontal-offset="0">
            <div class="title"><i18-n msgid="Rename folder">Rename folder</i18-n></div>
            <div class="desc"><i18-n msgid="renameFolderMsg">renameFolderMsg</i18-n></div>
        </designmap-hint>
        <designmap-hint id="openFileHint" hide-got-it target="[[hintFileTarget]]" name="openFile" vertical-offset="200" horizontal-offset="0">
            <div class="title"><i18-n msgid="Open DesignMap Gallery">Open DesignMap Gallery</i18-n></div>
            <div class="desc"><i18-n msgid="openGalleryMsg">openGalleryMsg</i18-n></div>
        </designmap-hint>
        <div class="cloud">
            <iron-icon icon="cloud-upload"></iron-icon>
        </div>
        <designmap-confirm id="restoreConfirm" message="ElementIsRemovedDoYouWantToResroreIt" on-continue="restoreElement" on-suspend="closeRestoreConfirm"></designmap-confirm>
    </template>
    <script>
        Polymer({
            is: 'designmap-fs-elements',
            colors: ['#82a5c4', '#82c4b9', '#82c48c', '#b5c482', '#cccc85', '#ddab91', '#d6a971', '#cc8f8f', '#b695c5'],
            persistColors: ['#82a5c4', '#82c4b9', '#82c48c', '#b5c482', '#cccc85', '#ddab91', '#d6a971', '#cc8f8f', '#b695c5'],
            behaviors: [
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapFsService,
                ReduxBehavior,
                Polymer.CombineActions(Polymer.FoldersActions,Polymer.FilesActions)
            ],
            properties: {
                /**
                 * Current folder ID from top
                 */
                currentFolderId: {
                    type: String,
                    notify: true
                },
                projectId: {
                   type: 'projectId',
                   statePath: 'projectId'
                },
                /**
                 * Allowed exts to upload
                 */
                allowedExtensions: {
                    type: Array,
                    value: [".jpg", ".png", ".gif", ".ttf", ".rif", ".bmp", ".jpg", ".hdr", ".ppm", ".pbm",".ai",".psd",".eps",".doc", ".docx", ".ppt", ".pptx", ".xls", ".xlsx"]
                },
                /**
                 * Selected elements
                 */
                selected: {
                    type: Array,
                    value: []
                },
                cutted: {
                    type: Object,
                    value: null
                },
                /**
                 * Trash mode
                 */
                trashMode: {
                    type: Boolean,
                    value: false
                },
                /**
                 * Define sort funciton
                 */
                sortWay: {
                    type: String,
                    value: 'name'
                },
                bodyNode: {
                    type: Object,
                    value: function () {
                        return document.body;
                    }
                },
                currentElement: {
                  type: Object
                },
                /**
                 * Elements
                 */
                elements: {
                    type: Array,
                    value: [],
                    statePath: function (state) {
                        return this._countElements(state);
                    }
                },
                hintTarget: {
                    type: Object,
                    value: null
                },
                hintFileTarget: {
                    type: Object,
                    value: null
                },
                user: {
                    type: Object,
                    statePath: 'user'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                }
            },
            listeners: {
                'open-element-context-menu': 'openElementContextMenu',
                'select-element': 'selectElement',
                'apply-action':'applyAction'
            },
            observers: [
                'selectedChanged(selected.splices)'
            ],
            ready: function () {
                window.addEventListener('click', this.clickOutside.bind(this));
                // Dropzone
                this.addEventListener('dragover', this.dragOver.bind(this));
                this.addEventListener('dragleave', this.dragLeave.bind(this));
                this.addEventListener('drop', this.drop.bind(this));
                // Resizer
                /*this.resizerShouldNotify(this);
                 this.assignParentResizable(this);*/
                if(!this.hintTarget) {
                    this.async(function(){
                        this.hintFolderTarget = this.$$('designmap-fs-element[type="folder"]');
                        this.hintFileTarget = this.$$('designmap-fs-element[type="file"]');
                    },1000)
                }
            },

            _countElements: function (state) {
                const parent = this.currentFolderId || null;
                const folders = state.folders.filter(function (folder) {
                    return this.trashMode ? folder.removed : String(folder.parent) == String(parent) && !folder.removed;
                }.bind(this));
                const files = state.files.filter(function (file) {
                    return this.trashMode ? file.removed : String(file.folder) == String(parent) && !file.removed && !(state.user && (state.user._id !== file.owner && file.locked));
                }.bind(this));
                return folders.concat(files);
            },

            /**
             * Execute stagger animation
             */
            executeStaggerAnimation: function () {
                this.$.elementsRepeater.items.forEach(function (item, index) {
                    this.$$('#element-' + index).playStaggerAnimation();
                }, this);
            },
            /**
             * Click on body. Test whether should we
             */
            clickOutside: function (e) {
                if (!this.parents(e.target, 'element') && !this.parents(e.target, 'no-unselect')) this.cleanSelected();
            },
            /**
             * Sorts function
             */
            sorts: {
                name: function (a, b) {
                    var aName = a.type == 'folder' ? a.name : a.data.name.replace(a.folder + '-', '');
                    var bName = b.type == 'folder' ? b.name : b.data.name.replace(b.folder + '-', '');
                    if (aName < bName) return -1;
                    if (aName > bName) return 1;
                    return 0;
                },
                modified: function (a, b) {
                    if (a.modified < b.modified) return -1;
                    if (a.modified > b.modified) return 1;
                    return 0;
                }
            },
            /**
             * Array sorting
             */
            elementsSort: function (sortWay) {
                return this.sorts[sortWay];
            },
            /**
             * Select element
             */
            selectElement: function (event) {
                const e = event.detail.e;
                const item = event.detail.item;
                e.stopPropagation();
                const key = e.keyCode || e.charCode || 0;
                const multiMode = !!(e.ctrlKey || e.metaKey);
                if (!multiMode && this.selected.length) this.cleanSelected();
                document.querySelector('designmap-app').$.info.data = item;
                this.push('selected', item);
            },
            /**
             * Clean all of selected elements
             * Folder and files
             */
            cleanSelected: function () {
                this.selected = [];
            },
            /**
             * Manage elements classes manually
             * because of repeater stamps
             */
            selectedChanged: function () {
                const repeater = this.$$('#elementsRepeater');
                if (repeater) [].forEach.call(repeater.items, function (element) {
                    var node = this.$$('*[data-element-id="' + element._id + '"]');
                    if (node) node.classList.remove('selected');
                }, this);

                this.selected.forEach(function (element) {
                    var node = this.$$('*[data-element-id="' + element._id + '"]');
                    if (node) node.classList.add('selected');
                }, this);

                // Setup new information
                if (document.querySelector('designmap-info')) {
                    document.querySelector('designmap-info').data = this.selected.length ? this.selected[this.selected.length - 1] : null;
                }
            },
            /**
             * Define whether the drop zone element is alone
             * @param length
             * @returns {string}
             */
            computeAlone: function (length) {
                return !length ? 'alone' : '';
            },
            /**
             * Apply action regarding current element
             * folder - go down
             * file - open gallery
             */
            applyAction: function (e) {
                var element = e.model&&e.model.item ? e.model.item : this.currentElement;
                if (this.trashMode) return this.openRestoreDialog(element);
                if(e.detail && e.detail.item) element = e.detail.item;
                var actionName = 'execute' + element.type.capitalize() + 'Action';
                if (this[actionName] && typeof this[actionName] === 'function') this[actionName](element);
            },
            /**
             * Go down folder
             * @param element
             */
            executeFolderAction: function (folder) {
                this.$$('#contextMenu').close();
                page.redirect('/'+this.projectId+this.getFullPath(folder));
            },
            /**
             * Open the gallery
             * @param element
             */
            executeFileAction: function (file) {
                const tutorial = document.querySelector('designmap-app').$.fsTutorial;
                // Hint
                if(tutorial && tutorial.isRunning=='openFile') {
                    tutorial.close();
                    this.async(function(){
                        document.querySelector('designmap-app').$.galleryView.$.gallery.showHint = true;
                        tutorial.thumbUp();
                    },500);
                }
                // Git
                page.redirect('/gallery/'+file._id);
            },
            /**
             * Get files only
             * @param elements
             */
            getFiles: function (elements) {
                return elements.filter(function (element) {
                    return element.type === 'file';
                });
            },
            /**
             * Whether hidden panel should be opened
             */
            computeHiddenPanelState: function (length) {
                return length > 1;
            },
            /**
             * Remove selected elements
             */
            removeSelectedElements: function () {
                if (this.trashMode) return this.$.removingSelectedConfirm.open();
                this.selected.forEach(function (element) {
                    this.fire('remove-' + element.type, {element: element, skip: true});
                }, this);
                this.showMessage('Selected elements was removed successfully');
                this.cleanSelected();
            },
            /**
             * Remove selected elements irretrievably
             */
            removeSelectedElementsIrretrievably: function () {
                this.$.removingSelectedConfirm.close();
                this.selected.forEach(function (element) {
                    this.fire('remove-' + element.type + '-irretrievably', {element: element, skip: true});
                }, this);
                this.showMessage('Selected entities was removed from trash');
                this.cleanSelected();
            },
            /**
             * Restore selected elements
             */
            restoreSelectedElements: function () {
                this.selected.forEach(function (element) {
                    this.fire('restore-' + element.type, {element: element, skip: true});
                }, this);
                this.showMessage('Selected objects were restored.');
            },
            /**
             * Close dialogs
             */
            suspendRemoving: function () {
                this.$.removingSelectedConfirm.close();
            },
            /**
             * Prevent context menu
             * @param e
             */
            preventContext: function (e) {
                e.preventDefault();
            },
            /**
             * Drop file inside workarea
             */
            drop: function (e) {
                e.stopPropagation();
                e.preventDefault();
                // Do not allow to upload files
                let files = [];
                [].forEach.call(e.dataTransfer.files,function(file){
                    var splitter = file.name.split('.');
                    var ext = '.'+splitter[splitter.length-1];
                    if(this.allowedExtensions && this.allowedExtensions.length && this.allowedExtensions.indexOf(ext.toLowerCase())==-1) {
                        return this.showErrorMessage('Cannot upload file with #EXT# extension',{'#EXT#':ext});
                    }
                    files.push(file);
                }.bind(this));

                if(!files.length) return this.classList.remove('dragged');

                this.$.uploader.buttonFiles = [].slice.call(files, 0);
                this.$.uploader.openForm();
                this.classList.remove('dragged');
            },
            /**
             * On drag over
             * @param e
             */
            dragOver: function (e) {
                e.stopPropagation();
                e.preventDefault();
                this.classList.add('dragged');
                e.dataTransfer.dropEffect = 'copy';
            },
            /**
             * On drag leave
             * @param e
             */
            dragLeave: function (e) {
                this.classList.remove('dragged');
            },
            /**
             * Open context menu here
             * @param e
             */
            openContextMenu: function (e) {
                this.fire('open-context-menu', e);
            },
            /**
             * Compute icon depending on trash mode
             * @param trashMode
             * @returns {string}
             */
            computeWhiteSpaceIcon: function (trashMode) {
                return !trashMode ? 'designmap-workspace-stub:empty-project' : 'designmap-workspace-stub:empty-bin'
            },
            /**
             * ACL Accesses
             * @returns {*|boolean}
             */
            doesUserHaveEditAccess: function () {
                return this.can('update', 'project');
            },
            /**
             * Open context menu
             */
            openElementContextMenu: function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.currentElement = e.detail.item;
                this.$$('#contextMenu').toggle(e.detail.e);
            },
            _canRemove: function(role,trashMode) {
                return trashMode ? this.topAccess(role) : true;
            },
            download: function(e){
                this.$$('#contextMenu').close();
                window.open(this.currentElement.data.url.replace("#SERVER#", Designmap.config.apiURL));
            },
            /**
             * Cut/Paste
             */
            cutElement: function(){
                this.fire('set-cutted',this.currentElement);
                const element = Object.assign({},this.currentElement);
                element.cutted = true;
                const searchCriteria = this.currentElement.type==='file'?this.currentElement._id:this.getFullPath(this.currentElement);
                this.dispatch('_update'+this.capitalizeFirstLetter(this.currentElement.type),searchCriteria,element);
                this.$$('#contextMenu').close();
            },
            _computeElementClass: function(cutted) {
                return cutted?'cutted':'';
            },
            openRestoreDialog: function(element){
                this.currentElement = element;
                this.$.restoreConfirm.open();
            },
            closeRestoreConfirm: function(){
                this.$.restoreConfirm.close();
            }
        });
    </script>
</dom-module>
