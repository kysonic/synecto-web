<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../designmap-ui/designmap-confirm.html">
<link rel="import" href="../designmap-tutorial/designmap-hint.html">
<link rel="import" href="../designmap-buttons/designmap-circle-button.html">
<link rel="import" href="../designmap-buttons/designmap-round-button.html">
<link rel="import" href="./designmap-fs-service.html">

<link rel="import" href="../../../styles/context-menu-shared-styles.html">

<dom-module is="designmap-fs-panel">
    <template>
        <style include="tooltip-shared-style"></style>
        <style include="context-menu-shared-styles">
            :host {
                display: flex;
                position: relative;
                height: var(--panel-height);

                --designmap-circle-button-circle-mixin: {
                    stroke-width: 2px !important;
                    stroke: var(--blue-darky-color);
                };

                --designmap-circle-button-content-icon-mixin: {
                    padding: 0;
                    width: 100%;
                    height: 100%;
                };

            }

            *[hidden] {
                display: none !important;
            }

            /** BUTTONS PANEL **/
            .buttons-panel {
                display: flex;
                flex: 1;
                position: relative;
            }

            .buttons-panel designmap-circle-button {
                position: relative;
                width: 50px;
                height: 50px;
            }

            .left {
                display: flex;
                justify-content: flex-start;
                margin-left: 5px;
                margin-top: 2px;
            }

            .left designmap-circle-button {
                margin-left: 15px;
            }

            .right {
                display: flex;
                justify-content: flex-end;
                flex: 1;
                margin-right: 20px;
                margin-left: 5px;
                margin-top: 5px;
            }

            .set {
                display: flex;
                justify-content: flex-end;
            }

            .trash-length {
                font-size: 10px;
                font-weight: bold;
                color: var(--primary-color);
                position: absolute;
                left: 50%;
                top: 50%;
                margin-left: -3px;
                margin-top: -6px;
            }
            .mobile-menu {
                display: none;
            }

            @media (min-width: 320px) and (max-width: 768px) {
                #createFolderButton ,#uploadFileButton, #sortButton, #infoButton, #restoreButton,#removeButton {
                    display: none;
                }
                .mobile-menu {
                    display: block;
                    position: relative;
                    left: 10px;
                    width: 50px;
                    height: 50px;
                    --iron-icon-components-mixin: {
                        stroke: var(--gray-darkend-color);
                        stroke-width: 1px;
                    };
                }
            }

        </style>
        <!-- Confirms -->
        <designmap-confirm id="removeAllConfirm" message="AreYouSureThatYouWannaDeleteAllObjects"
                           on-continue="removeAllElements" on-suspend="suspendRemoving"></designmap-confirm>
        <!-- Panel -->
        <div class="buttons-panel">
            <div class="left">
                <designmap-circle-button id="createFolderButton"
                                         plastic-tooltip$="[[translate('Add folder',language,i18Loaded)]]" data-cls="blue"
                                         hidden$="[[trashMode]]" id="addFolderButton"
                                         on-click="openAddFolderContext">
                    <iron-icon icon="designmap-workspace:folder"></iron-icon>
                </designmap-circle-button>
                <!-- Hint -->
                <designmap-hint id="createFolderHint" previous name="createFolder" vertical-offset="50"
                                horizontal-offset="-107">
                    <div class="title">
                        <i18-n msgid="Creating sub-folder">Creating sub-folder</i18-n>
                    </div>
                    <div class="desc">
                        <i18-n msgid="creatingSubFolderMsg">creatingSubFolderMsg</i18-n>
                    </div>
                </designmap-hint>
                <paper-tooltip for="createFolderButton"><i18-n msgid="Add folder">Add folder</i18-n></paper-tooltip>
                <!-- Add folder -->
                <designmap-context-menu id="addFolderContext" previous>
                    <div class="context-content">
                        <iron-a11y-keys id="a11yAddFolder" keys="ctrl+enter meta+enter" on-keys-pressed="addFolder"></iron-a11y-keys>
                        <paper-input label="[[translate('Folder Name',language,i18Loaded)]]" auto-validate
                                     pattern="[\w\dа-яА-ЯёЁ -]+"
                                     error-message="[[translate('FolderNameError',language,i18Loaded)]]"
                                     id="addFolder"></paper-input>
                        <div class="button-container">
                            <button is="designmap-round-button" on-click="addFolder">
                                <iron-icon icon="icons:arrow-forward"></iron-icon>
                            </button>
                        </div>
                    </div>
                </designmap-context-menu>
                <!-- Upload file -->
                <designmap-circle-button id="uploadFileButton"
                                         plastic-tooltip$="[[translate('Upload file',language,i18Loaded)]]" data-cls="blue"
                                         hidden$="[[trashMode]]" on-click="openFileUploader" data-hint="add-file">
                    <iron-icon icon="designmap-workspace:file"></iron-icon>
                </designmap-circle-button>
                <!-- Hint -->
                <designmap-hint id="uploadFileHint" previous name="addFile" vertical-offset="50"
                                horizontal-offset="-107">
                    <div class="title">
                        <i18-n msgid="Add file hint">Add file hint</i18-n>
                    </div>
                    <div class="desc">
                        <i18-n msgid="addFileMsg">addFileMsg</i18-n>
                    </div>
                </designmap-hint>
                <paper-tooltip for="uploadFileButton"><i18-n msgid="Upload file">Upload file</i18-n></paper-tooltip>
                <!-- Trash mode -->
                <designmap-circle-button id="restoreButton" plastic-tooltip$="[[translate('Restore all',language,i18Loaded)]]" data-cls="blue"
                                         hidden$="[[!trashMode]]" class="trash" on-click="restoreAll">
                    <iron-icon icon="designmap-workspace:restore"></iron-icon>
                </designmap-circle-button>
                <paper-tooltip for="restoreButton"><i18-n msgid="Restore all">Restore all</i18-n></paper-tooltip>
                <designmap-circle-button id="removeButton" plastic-tooltip$="[[translate('Remove all',language,i18Loaded)]]" data-cls="blue"
                                         hidden$="[[!_canRemoveAll(user.role,trashMode)]]" class="trash" on-click="removeAll">
                    <iron-icon icon="designmap-workspace:remove"></iron-icon>
                </designmap-circle-button>
                <paper-tooltip for="removeButton"><i18-n msgid="Remove all">Remove all</i18-n></paper-tooltip>
            </div>
            <div class="right">
                <designmap-circle-button id="sortButton" data-cls="blue"
                                         on-click="openMoreContext">
                    <iron-icon icon="designmap-workspace:sort"></iron-icon>
                </designmap-circle-button>
                <paper-tooltip for="sortButton"><i18-n msgid="Sort">Sort</i18-n></paper-tooltip>
                <designmap-context-menu id="moreContext" previous>
                    <ul class="menu">
                        <li class="sort-button" on-click="changeSort" data-sort="name">
                            <i18-n msgid="Sort by name">Sort by name</i18-n>
                        </li>
                        <li class="sort-button" on-click="changeSort" data-sort="modified">
                            <i18-n msgid="Sort by date">Sort by date</i18-n>
                        </li>
                    </ul>
                </designmap-context-menu>
                <designmap-circle-button id="infoButton" data-cls="blue"
                                         hidden$="[[infoOpened]]" on-click="openInfo" class="no-unselect">
                    <iron-icon icon="designmap-workspace:info"></iron-icon>
                </designmap-circle-button>
                <paper-tooltip for="infoButton"><i18-n msgid="Info">Info</i18-n></paper-tooltip>
                <!--Mobile menu -->
                <iron-icon class="mobile-menu" icon="designmap-workspace:more" on-click="openMobileMenu"></iron-icon>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-fs-panel',
            behaviors: [
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapFsService,
                ReduxBehavior
            ],
            properties: {
                currentFolderId: {
                    type: String
                },
                /**
                 * Language
                 */
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: String,
                    statePath: 'i18Loaded'
                },
                /**
                 * Sort way
                 */
                sortWay: {
                    type: String,
                    value: 'modified',
                    notify: true
                },
                /**
                 * Whether information panel is opened
                 */
                infoOpened: {
                    type: Boolean,
                    value: false
                },
                /**
                 * User's role
                 */
                role: {
                    type: String,
                    statePath: 'role'
                },
                /**
                 * ACL representation
                 */
                acl: {
                    type: Array,
                    statePath: 'acl'
                },
                trashMode: {
                    type: Boolean
                },
                thisNode: {
                    type: Object,
                    value: function(){
                        return this;
                    }
                }
            },
            attached: function () {
                this.tutorial = document.querySelector('designmap-app').$.fsTutorial;
            },
            /**
             * Open add folder context
             * @param e
             */
            openAddFolderContext: function (e) {
                this.$.addFolderContext.toggle(e);
                this.async(function () {
                    this.$.addFolder.focus();
                }, 150);
            },
            /**
             * Add folder
             * @returns {*}
             */
            addFolder: function () {
                //Validate
                if (!this.nameChildUniqueValidation(this.$.addFolder.value, this.currentFolderId)) return this.showErrorMessage('Name of the folder must be unique');
                if (!this.$.addFolder.value) return this.showErrorMessage('Name can\'t be empty.');
                if (!this.$.addFolder.validate()) return false;
                // Close
                this.$.addFolderContext.close();
                // Build data
                var folder = {
                    _id: this.generateUid(),
                    name: this.$.addFolder.value,
                    type: 'folder',
                    path: this.getFullPath(this.findFolderById(this.currentFolderId)),
                    parent: this.currentFolderId,
                    color: '#82a5c4'
                };
                this.$.addFolder.value = '';
                // Fire event
                this.fire('add-folder', folder);
            },
            /**
             * Open file uploader
             */
            openFileUploader: function () {
                this.fire('open-file-uploader', {id: this.currentFolderId});
            },
            /**
             * Open information panel
             */
            openInfo: function () {
                this.fire('open-info');
            },
            /**
             * Restore all elements
             */
            restoreAll: function () {
                this.fire('restore-all');
            },
            /**
             * Remove all elements
             */
            removeAllElements: function () {
                this.$.removeAllConfirm.close();
                this.fire('remove-all');
            },
            /**
             * Remove all elements
             */
            removeAll: function () {
                this.$.removeAllConfirm.open();
            },
            /**
             * Close confirm dialog
             */
            suspendRemoving: function () {
                this.$.removeAllConfirm.close();
            },
            /**
             * Change sort
             * @param e - event
             */
            changeSort: function (e) {
                var target = this.parents(e.target, 'sort-button');
                this.sortWay = target.dataset.sort;
                this.$.moreContext.close();
            },
            /**
             * Open "more" context menu
             */
            openMoreContext: function (e) {
                this.$.moreContext.toggle(e);
            },
            /**
             * Could user remove all ?
             * @returns {boolean|*}
             */
            _canRemoveAll: function (role,trashMode) {
                return this.topAccess(role) && trashMode;
            },

            openMobileMenu: function(e){
               this.fire('open-context-menu',e);
            }
        })
    </script>
</dom-module>
