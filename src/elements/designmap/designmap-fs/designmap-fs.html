<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- Styles -->
<link rel="import" href="../../../styles/context-menu-shared-styles.html">
<!-- Icons -->
<link rel="import" href="../designmap-icons/designmap-workspace-icons.html">
<!-- Components -->
<link rel="import" href="../designmap-ui/designmap-stub.html">
<link rel="import" href="../designmap-ui/designmap-context-menu.html">
<link rel="import" href="./designmap-fs-breadcrumbs.html">
<link rel="import" href="./designmap-fs-panel.html">
<link rel="import" href="./designmap-fs-elements.html">
<!-- Services -->
<link rel="import" href="./designmap-fs-service.html">
<link rel="import" href="./designmap-fs-socket-service.html">
<!-- Redux -->
<link rel="import" href="../../../redux/actions/project-actions.html">
<link rel="import" href="../../../redux/actions/folders-actions.html">

<dom-module id="designmap-fs">
    <template>
        <style include="context-menu-shared-styles">
            :host {
                display: block;
                height: 100%;
            }

            /** BASE **/
            .dashboard {
                width: 100%;
                height: var(--panel-height);
                display: flex;
                align-items: center;
                background: var(--white-color);
                position: relative;
            }

            .workarea {
                flex: 1;
                width: 100%;
                height: calc(100vh - 120px);
            }

            .pre-button {
                margin-left: 27px;
                width: 40px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: left;
                position: relative;
                top: 4px;
                cursor: pointer;
            }

            #projectContextMenu {
                --designmap-dropdown-triangle-mixin: {
                    left: 0;
                    margin-left: 12px;
                }
            }

            .pre-button iron-icon {
                stroke: var(--blue-darker-color) !important;
                fill: var(--blue-darker-color) !important;
            }

            #breadcrumbs {
                flex: 1;
            }

            #panel {
                flex: 20;
            }

            .context-content {
                background: var(--blue-darker-color);
            }

            .arrow-back {
                border-radius: 50%;
                margin-left: 9px;
                cursor: pointer;
                transition: background .2s ease-in;
            }

            .arrow-back:hover {
                background: var(--gray-lightern-color);
                transition: background .2s ease-in;
            }

            .arrow-back iron-icon {
                width: 50px;
                height: 50px;
                transform: rotate(223deg);
                --iron-icon-components-mixin: {
                    stroke: var(--blue-color) !important;
                    stroke-width: 2px !important;
                }
            }

            .empty-message, .error-message, .loading-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--gray-darky-color);
                font-weight: 100;
            }

            .error-message {
                color: #ff4f0d;
            }

            designmap-context-menu {
                position: absolute;
            }

        </style>
        <div class="dashboard" hidden="[[!selectedProjectID]]">
            <div class="arrow-back" hidden$="[[!trashMode]]" on-click="goBack">
                <iron-icon icon="designmap-workspace:open"></iron-icon>
            </div>
            <!-- Crumbs -->
            <designmap-fs-breadcrumbs id="breadcrumbs" trash-mode="[[trashMode]]" project-name="[[project.name]]"
                                      current-folder-id="{{currentFolderId}}"></designmap-fs-breadcrumbs>
            <!-- Button panel -->
            <designmap-fs-panel id="panel" acl="[[acl]]" role="[[user.role]]" sort-way="{{sortWay}}"
                                trash-mode="[[trashMode]]" current-folder-id="[[currentFolderId]]"></designmap-fs-panel>
        </div>
        <div class="workarea" on-contextmenu="openContextMenu">
            <template is="dom-if" if="[[shouldWeShowElements(project)]]">
                <designmap-fs-elements id="elements" acl="[[acl]]" role="[[role]]" id="elements" sort-way="[[sortWay]]"
                                       trash-mode="[[trashMode]]"
                                       current-folder-id="{{currentFolderId}}"></designmap-fs-elements>
                <!-- Context menu -->
                <designmap-context-menu id="contextMenu" parent>
                    <ul class="menu">
                        <li on-click="openAddFolderContext" hidden$="[[!doesUserHaveEditAccess(role,acl,trashMode)]]">
                            <i18-n msgid="Add folder">Add folder</i18-n>
                        </li>
                        <!-- Add folder context -->
                        <designmap-context-menu id="addFolderContext" previous>
                            <div class="context-content">
                                <iron-a11y-keys id="a11yAddFolder" keys="enter"
                                                on-keys-pressed="addFolderManually"></iron-a11y-keys>
                                <paper-input label="[[translate('Folder Name',language,i18Loaded)]]" auto-validate
                                             pattern="[\w\dа-яА-ЯёЁ -]+"
                                             error-message="[[translate('FolderNameError',language)]]"
                                             id="addFolder"></paper-input>
                                <div class="button-container">
                                    <button is="designmap-round-button" on-click="addFolderManually">
                                        <iron-icon icon="icons:arrow-forward"></iron-icon>
                                    </button>
                                </div>
                            </div>
                        </designmap-context-menu>
                        <li on-click="openFileUploaderManually"
                            hidden$="[[!doesUserHaveEditAccess(role,acl,trashMode)]]">
                            <i18-n msgid="Upload file">Upload file</i18-n>
                        </li>
                        <li class="sort-button" on-click="changeSort" data-sort="name">
                            <i18-n msgid="Sort by name">Sort by name</i18-n>
                        </li>
                        <li class="sort-button" on-click="changeSort" data-sort="modified">
                            <i18-n msgid="Sort by date">Sort by date</i18-n>
                        </li>
                    </ul>
                </designmap-context-menu>
            </template>
            <template is="dom-if" if="[[shouldWeShowLoading(project)]]">
                <div class="loading-wrapper">
                    <img src="/images/svg/three-dots-gray.svg" alt="Loading">
                </div>
            </template>
            <template is="dom-if" if="[[shouldWeShowError(project)]]">
                <designmap-stub image="designmap-workspace-stub:error" message="[[project.error]]"
                                error></designmap-stub>
            </template>
            <template is="dom-if" if="[[shouldWeShowEmptyMessage(project)]]">
                <designmap-stub value="{{projectName}}" on-action="onCreateProject"
                                image="designmap-workspace-stub:project"
                                message="There is no selected project yet..." input-text="Create project"
                                input-error="ProjectNameError"></designmap-stub>
            </template>
        </div>
    </template>
    <script>
        const PROJECT_NAME_REGEXP = /[\w\dа-яА-ЯёЁ -]+/;
        Polymer({
            is: 'designmap-fs',
            behaviors: [
                // Useful behaviors
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                // Services
                Polymer.DesignMapFsService,
                Polymer.DesignMapFsSocketService,
                // Redux
                ReduxBehavior,
                Polymer.CombineActions(Polymer.UserActions, Polymer.ProjectActions, Polymer.FoldersActions, Polymer.FilesActions)
            ],
            properties: {
                user: {
                    type: Object,
                    statePath: 'user'
                },
                isAuth: {
                    type: Boolean,
                    computed: '_computedAuth(user)',
                    observer: '_isAuthChanged'
                },
                /**
                 * Uniq session id to provide socket updating
                 */
                uid: String,
                language: {
                    type: String,
                    computed: '_computeLanguage(user.language)'
                },
                i18Loaded: {
                    type: String,
                    statePath: 'i18Loaded'
                },
                acl: {
                    type: Array,
                    statePath: 'acl'
                },
                /**
                 * Data from router. Including
                 * page - page name
                 * prefix - /pagename
                 * path - subroute
                 */
                routerData: {
                    type: Object,
                    statePath: 'routerData'
                },
                page: {
                    type: String,
                    computed: '_computePage(routerData.page)',
                    observer: '_pageChanged'
                },
                path: {
                    type: String,
                    computed: '_computePath(routerData.path)',
                    observer: '_pathChanged'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projects: {
                    type: Array,
                    statePath: 'projects'
                },
                currentFolderId: {
                    type: String,
                    value: undefined
                },
                /**
                 * If trash mode is on -
                 * we will show all removed elements
                 */
                trashMode: {
                    type: Boolean,
                    value: false,
                    observer: 'trashModeChanged'
                },
                sortWay: {
                    type: String,
                    value: 'modified'
                }
            },
            listeners: {
                'add-folder': 'addFolder',
                'update-folder': 'updateFolder',
                'remove-folder': 'removeFolder',
                'remove-folder-irretrievably': 'removeFolderIrretrievably',
                'remove-file': 'removeFile',
                'remove-file-irretrievably': 'removeFileIrretrievably',
                'restore-folder': 'restoreFolder',
                'restore-file': 'restoreFile',
                'restore-all': 'restoreAll',
                'remove-all': 'removeAll',
                'open-file-uploader': 'openFileUploader',
                'open-context-menu': 'openContextMenuEvent',
                'apply-route': 'applyRouteManually'
            },
            ready: function () {
                this.uid = Designmap.uid = this.generateUid();
            },
            doesUserHaveEditAccess: function () {
                return true
            },
            /**
             * Open file uploader
             */
            openFileUploader: function (e) {
                this.$$('#elements').$.uploader._id = e.detail.id;
                this.$$('#elements').$.uploader.openForm();
            },
            /**
             * Open context menu
             */
            openContextMenu: function (e) {
                e.preventDefault();
                if (!this.project._id) return;
                this.$$('#contextMenu').toggle(e);
            },
            /**
             * Open context menu
             */
            openContextMenuEvent: function (e) {
                this.$$('#contextMenu').toggle(e.detail);
            },
            /**
             * Open add folder context menu menu
             */
            openAddFolderContext: function (e) {
                this.$$('#addFolderContext').toggle(e);
                this.async(function () {
                    this.$$('#addFolder').focus();
                }, 150);
            },
            /**
             * Go on project page
             */
            goBack: function () {
                document.querySelector('designmap-app').set('subroute.path', '/');
            },
            /**
             * Change sort
             * @param e - event
             */
            changeSort: function (e) {
                const target = this.parents(e.target, 'sort-button');
                this.sortWay = target.dataset.sort;
                this.$$('#contextMenu').close();
            },
            /**
             * Open file upload
             */
            openFileUploaderManually: function (e) {
                this.$$('#elements').$.uploader._id = this.currentFolderId;
                this.$$('#elements').$.uploader.openForm();
            },
            /**
             * If trash mode has been changed
             * we have to update view
             */
            trashModeChanged: function () {
                //if(this.$$('#elements')) this.$$('#elements').updateView();
            },
            /**
             * Create project
             */
            onCreateProject: function () {
                this.dispatch('updateProjectState',{loading:true});
                if (!this.projectName) return;
                if (!PROJECT_NAME_REGEXP.test(this.projectName)) return this.showErrorMessage('Project name is not correct');
                this.createProject(this.projectName);
            },
            _computedAuth: function(user) {
              return !!user;
            },
            /**
             * If user would be changed we would have to request
             * projects data for current user.
             */
            _isAuthChanged: function (isAuth) {
                if (!isAuth) return this.cleanUp();
                // Get user's projects
                this.dispatch('getProjects').then(function (response) {
                    if (!response.success) return;
                    // Find project
                    // 1. id from url
                    // 2. first project
                    // 3. There is no project
                    if (this.routerData.page) return false;
                    const projectID = response.projects[0] && response.projects[0]._id || null;
                    if (!projectID) return false;
                    // Get current project data | Read project
                    //document.querySelector('designmap-app').set('route.path', '/' + projectID);
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
            },
            _computePage: function (page) {
                return page;
            },
            _computePath: function (path) {
                return path;
            },
            /**
             * When selected project ID is changed
             * we have to update project data and etc
             */
            _pageChanged: function (page) {
                console.log(page);
                this.cleanProjectData();
                if (!page) return;
                // Get project data
                this.dispatch('getProject', page).then(function (response) {
                    if (!response.success) throw response.errors;
                    this.updateProject(response.project);
                }.bind(this)).catch(function (err) {
                    const errorMessage = err.message || err + (err.stack ? err.stack : '');
                    this.dispatch('updateProjectState', {error: errorMessage, loading: false});
                }.bind(this));
            },
            /**
             * Observe router changes and
             * react on it
             * @param path
             * @returns {null}
             */
            _pathChanged: function (path) {
                if (!path) return this.currentFolderId = null;
                const pathArray = path.split('/').clean();
                if (pathArray.length && pathArray[0] === 'trash') return this.trashMode = true;
                this.trashMode = false;
                const folder = this.findFolderByPath(pathArray.join('/'));
                this.currentFolderId = folder ? folder._id : null;
            },
            /**
             * Update project
             */
            updateProject: function (project) {
                if (!project) return;
                this.setupSocket(project._id);
                this.getProjectData();
            },
            /**
             * Get all project data
             */
            getProjectData: function () {
                this.dispatch('getFolders', {scope: this.project._id}).then(function (response) {
                    this._pathChanged(this.routerData.path);
                    this.$$('#elements').update();
                }.bind(this));
                this.dispatch('getFiles', {project: this.project._id});
                /*this.dispatch('getStickers', {project: this.project._id});
                 this.dispatch('getShare');*/
            },
            /**
             * Remove all data associated
             * with current user
             */
            cleanUp: function () {
                this.dispatch('cleanProjects');
                this.dispatch('cleanUser');
                this.dispatch('cleanUsers');
                /*this.dispatch('cleanShared');
                 this.dispatch('cleanNotifications');
                 this.dispatch('cleanStores');
                 this.dispatch('updateSelectedProjectID', null);*/
            },
            /**
             * Remove all data from redux store
             * associated with current project
             */
            cleanProjectData: function () {
                this.dispatch('cleanProjectState');
                this.dispatch('cleanFolders');
                this.dispatch('cleanFiles');
                /*this.dispatch('cleanStickers');
                 this.dispatch('cleanStores');
                 this.dispatch('cleanShare');*/
            },
            /**
             * Screen state depends on a few things:
             * Is project loading?
             * Does project have error?
             * Is there project at all?
             */
            shouldWeShowElements: function (project) {
                return project && project._id && !project.error && !project.loading;
            },
            shouldWeShowEmptyMessage: function (project) {
                return !project || (!project._id && !project.error && !project.loading);
            },
            shouldWeShowLoading: function (project) {
                return project && project.loading;
            },
            shouldWeShowError: function (project) {
                return project && project.error && !project.loading;
            }
        });
    </script>
</dom-module>
