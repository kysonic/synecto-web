<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- Styles -->
<link rel="import" href="../../../styles/context-menu-shared-styles.html">
<link rel="import" href="../../../styles/loading-shared-styles.html">
<!-- Icons -->
<link rel="import" href="../designmap-icons/designmap-workspace-icons.html">
<!-- Components -->
<link rel="import" href="../designmap-ui/designmap-stub.html">
<link rel="import" href="../designmap-ui/designmap-context-menu.html">
<link rel="import" href="./designmap-fs-breadcrumbs.html">
<link rel="import" href="./designmap-fs-panel.html">
<link rel="import" href="./designmap-fs-elements.html">
<!-- Services -->
<link rel="import" href="./designmap-fs-service.html">
<link rel="import" href="../../../behaviors/designmap-socket-behavior.html">
<!-- Redux -->
<link rel="import" href="../../../redux/actions/project-actions.html">
<link rel="import" href="../../../redux/actions/folders-actions.html">
<link rel="import" href="../../../redux/actions/tasks-actions.html">
<link rel="import" href="../../../redux/actions/files-actions.html">
<link rel="import" href="../../../redux/actions/stickers-actions.html">
<link rel="import" href="../../../redux/actions/comments-action.html">

<dom-module id="designmap-fs">
    <template>
        <style include="loading-shared-styles"></style>
        <style include="context-menu-shared-styles">
            :host {
                display: block;
                height: 100%;
            }

            *[hidden] {
                display: none !important;
            }

            /** BASE **/
            .dashboard {
                width: 100%;
                height: var(--panel-height);
                display: flex;
                align-items: center;
                background: var(--white-color);
                position: relative;
            }

            .workarea {
                flex: 1;
                width: 100%;
                height: calc(100vh - 120px);
            }

            .pre-button {
                margin-left: 27px;
                width: 40px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: left;
                position: relative;
                top: 4px;
                cursor: pointer;
            }

            #projectContextMenu {
                --designmap-dropdown-triangle-mixin: {
                    left: 0;
                    margin-left: 12px;
                }
            }

            .pre-button iron-icon {
                stroke: var(--blue-darker-color) !important;
                fill: var(--blue-darker-color) !important;
            }

            #breadcrumbs {
                flex: 1;
            }

            #panel {
                flex: 20;
            }

            .context-content {
                background: var(--blue-darker-color);
            }

            .arrow-back {
                border-radius: 50%;
                margin-left: 9px;
                cursor: pointer;
                transition: background .2s ease-in;
            }

            .arrow-back:hover {
                background: var(--gray-lightern-color);
                transition: background .2s ease-in;
            }

            .arrow-back iron-icon {
                width: 50px;
                height: 50px;
                transform: rotate(223deg);
                --iron-icon-components-mixin: {
                    stroke: var(--blue-color) !important;
                    stroke-width: 2px !important;
                }
            }

            .empty-message, .error-message, .loading-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--gray-darky-color);
                font-weight: 100;
            }

            .error-message {
                color: #ff4f0d;
            }

            designmap-context-menu {
                position: absolute;
            }

        </style>
        <div class="dashboard" hidden$="[[_computePanelState(projectId, project.error)]]">
            <div class="arrow-back" hidden$="[[!trashMode]]" on-click="goBack">
                <iron-icon icon="designmap-workspace:open"></iron-icon>
            </div>
            <!-- Crumbs -->
            <designmap-fs-breadcrumbs id="breadcrumbs" trash-mode="[[trashMode]]" project-name="[[project.name]]"
                                      current-folder-id="{{currentFolderId}}"></designmap-fs-breadcrumbs>
            <!-- Button panel -->
            <designmap-fs-panel hidden$="[[!project]]" id="panel" sort-way="{{sortWay}}"
                                trash-mode="[[trashMode]]" current-folder-id="[[currentFolderId]]"></designmap-fs-panel>
        </div>
        <div class="workarea" on-contextmenu="openContextMenu">
            <template is="dom-if" if="[[shouldWeShowElements(project)]]">
                <designmap-fs-elements id="elements" acl="[[acl]]" role="[[role]]" id="elements" sort-way="[[sortWay]]"
                                       trash-mode="[[trashMode]]"
                                       current-folder-id="{{currentFolderId}}"></designmap-fs-elements>
                <!-- Context menu -->
                <designmap-context-menu id="contextMenu" parent>
                    <ul class="menu">
                        <li on-click="openAddFolderContext" hidden$="[[!doesUserHaveEditAccess(role,acl,trashMode)]]">
                            <i18-n msgid="Add folder">Add folder</i18-n>
                        </li>
                        <!-- Add folder context -->
                        <designmap-context-menu id="addFolderContext" previous>
                            <div class="context-content">
                                <iron-a11y-keys id="a11yAddFolder" keys="enter"
                                                on-keys-pressed="addFolderManually"></iron-a11y-keys>
                                <paper-input label="[[translate('Folder Name',language,i18Loaded)]]" auto-validate
                                             pattern="[\w\dа-яА-ЯёЁ -]+"
                                             error-message="[[translate('FolderNameError',language)]]"
                                             id="addFolder"></paper-input>
                                <div class="button-container">
                                    <button is="designmap-round-button" on-click="addFolderManually">
                                        <iron-icon icon="icons:arrow-forward"></iron-icon>
                                    </button>
                                </div>
                            </div>
                        </designmap-context-menu>
                        <li on-click="openFileUploaderManually"
                            hidden$="[[!doesUserHaveEditAccess(role,acl,trashMode)]]">
                            <i18-n msgid="Upload file">Upload file</i18-n>
                        </li>
                        <li class="sort-button" on-click="changeSort" data-sort="name">
                            <i18-n msgid="Sort by name">Sort by name</i18-n>
                        </li>
                        <li class="sort-button" on-click="changeSort" data-sort="modified">
                            <i18-n msgid="Sort by date">Sort by date</i18-n>
                        </li>
                        <template is="dom-if" if="[[cutted]]">
                            <li class="sort-button" on-click="pasteElement">
                                <i18-n msgid="Paste">Paste</i18-n>
                            </li>
                        </template>
                    </ul>
                </designmap-context-menu>
            </template>
            <template is="dom-if" if="[[shouldWeShowLoading(project)]]">
                <div class="loading-wrapper">
                    <img src="/images/svg/three-dots-gray.svg" alt="Loading">
                </div>
            </template>
            <template is="dom-if" if="[[shouldWeShowEmptyMessage(project)]]">
                <designmap-stub value="{{projectName}}" on-action="onCreateProject"
                                image="designmap-workspace-stub:project"
                                message="There is no selected project yet..." input-text="Create project"
                                input-error="ProjectNameError"></designmap-stub>
            </template>
        </div>
        <div id="projectLoading" hidden$=[[!loading]] class="loading-overlay"><div class="uil-reload-css"><div></div></div></div>
    </template>
    <script>
        const PROJECT_NAME_REGEXP = /[\w\dа-яА-ЯёЁ -]+/;
        Polymer({
            is: 'designmap-fs',
            behaviors: [
                // Useful behaviors
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                // Services
                Polymer.DesignMapFsService,
                Polymer.DesignmapSocketBehavior,
                // Redux
                ReduxBehavior,
                Polymer.CombineActions(
                    Polymer.UserActions,
                    Polymer.ProjectActions,
                    Polymer.FoldersActions,
                    Polymer.FilesActions,
                    Polymer.StickersActions,
                    Polymer.TasksActions,
                    Polymer.CommentsActions)
            ],
            properties: {
                user: {
                    type: Object,
                    statePath: 'user'
                },
                isAuth: {
                    type: Boolean,
                    computed: '_computedAuth(user)',
                    observer: '_isAuthChanged'
                },
                /**
                 * Uniq session id to provide socket updating
                 */
                uid: String,
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: String,
                    statePath: 'i18Loaded'
                },
                projectId: {
                    type: String,
                    statePath: 'projectId',
                    observer: '_projectIdChanged'
                },
                path: {
                    type: String,
                    statePath: 'path',
                    observer: '_pathChanged'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projects: {
                    type: Array,
                    statePath: 'projects'
                },
                currentFolderId: {
                    type: String,
                    value: undefined,
                    observer: '_currentFolderIdChanged'
                },
                /**
                 * If trash mode is on -
                 * we will show all removed elements
                 */
                trashMode: {
                    type: Boolean,
                    statePath: 'trashMode'
                },
                sortWay: {
                    type: String,
                    value: 'name'
                },
                loading: {
                    type: Boolean,
                    value:true
                },
                /**
                 * Cut\paste element
                 */
                cutted: {
                    type: Object,
                    value: null
                }
            },
            listeners: {
                'add-folder': 'addFolder',
                'update-folder': 'updateFolder',
                'remove-folder': 'removeFolder',
                'remove-folder-irretrievably': 'removeFolderIrretrievably',
                'remove-file': 'removeFile',
                'remove-file-irretrievably': 'removeFileIrretrievably',
                'restore-folder': 'restoreFolder',
                'restore-file': 'restoreFile',
                'restore-all': 'restoreAll',
                'remove-all': 'removeAll',
                'open-file-uploader': 'openFileUploader',
                'open-context-menu': 'openContextMenuEvent',
                'apply-route': 'applyRouteManually',
                'set-cutted': 'setCuttedElement'
            },
            doesUserHaveEditAccess: function () {
                return true
            },
            /**
             * Open file uploader
             */
            openFileUploader: function (e) {
                this.$$('#elements').$.uploader._id = e.detail.id;
                this.$$('#elements').$.uploader.openForm();
            },
            /**
             * Open context menu
             */
            openContextMenu: function (e) {
                e.preventDefault();
                if (!this.project._id) return;
                this.$$('#contextMenu').toggle(e);
            },
            /**
             * Open context menu
             */
            openContextMenuEvent: function (e) {
                this.$$('#contextMenu').toggle(e.detail);
            },
            /**
             * Open add folder context menu menu
             */
            openAddFolderContext: function (e) {
                this.$$('#addFolderContext').toggle(e);
                this.async(function () {
                    this.$$('#addFolder').focus();
                }, 150);
            },
            /**
             * Go on project page
             */
            goBack: function () {
                page.redirect('/'+this.projectId);
            },
            /**
             * Change sort
             * @param e - event
             */
            changeSort: function (e) {
                const target = this.parents(e.target, 'sort-button');
                this.sortWay = target.dataset.sort;
                this.$$('#contextMenu').close();
            },
            /**
             * Open file upload
             */
            openFileUploaderManually: function (e) {
                this.$$('#elements').$.uploader._id = this.currentFolderId;
                this.$$('#elements').$.uploader.openForm();
            },
            /**
             * Change folder id
             */
            _currentFolderIdChanged: function(id){
                this.dispatch('updateFolderId',id);
            },
            /**
             * Create project
             */
            onCreateProject: function () {
                if (!this.projectName) return;
                if (!PROJECT_NAME_REGEXP.test(this.projectName)) return this.showErrorMessage('Project name is not correct');
                this.dispatch('updateProjectState',{loading:true});
                this.createProject(this.projectName);
            },
            _computedAuth: function(user) {
              return !!user;
            },
            /**
             * If user would be changed we would have to request
             * projects data for current user.
             */
            _isAuthChanged: function (isAuth) {
                if (!isAuth) return this.cleanUp();
                // Start tutorial
                if(!this.user.system.firstVisitIsDone) {
                    const system = this.user.system;
                    system.firstVisitIsDone = true;
                    this.dispatch('userUpdate',{system:system});
                    const tutorial = document.querySelector('designmap-app').$.tutorial;
                    this.async(function(){
                        tutorial.start();
                    },2000);
                }
                // Get user's projects
                this.dispatch('getProjects').then(function (response) {
                    if (!response.success) return;
                    // Find project
                    // 1. id from url
                    // 2. first project
                    // 3. There is no project
                    if (this.projectId) return false;
                    const projectId = response.projects[0] && response.projects[0]._id || null;
                    if (!projectId) return false;
                    // Redirect to open new project
                    page.redirect('/'+projectId);
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
            },
            /**
             * When selected project ID is changed
             * we have to update project data and etc
             */
            _projectIdChanged: function (projectId) {
                this.cleanProjectData();
                if (!projectId) return ;
                if(this.project) return this.getProjectData();
                // Get project data
                this.loading = true;
                this.dispatch('getProject', projectId).then(function (response) {
                    if (!response.success) throw response.errors;
                    this.updateProject(response.project);
                }.bind(this)).catch(function (err) {
                    const errorMessage = err.message || err + (err.stack ? err.stack : '');
                    this.dispatch('updateProjectState', {error: errorMessage, loading: false});
                    this.loading = false;
                }.bind(this));
            },
            /**
             * Observe router changes and
             * react on it
             * @param path
             * @returns {null}
             */
            _pathChanged: function (path) {
                if (!path) return this.currentFolderId = null;
                const folder = this.findFolderByPath(path);
                this.currentFolderId = folder ? folder._id : null;
            },
            /**
             * Update project
             */
            updateProject: function (project) {
                if (!project) return;
                this.setupSocket(project._id,'project');
                this.getProjectData();
            },
            /**
             * Get all project data
             */
            getProjectData: function () {
                this.dispatch('getFolders', {scope: this.project._id}).then(function (response) {
                    this.async(function(){this._pathChanged(this.path);});
                    this.async(function(){this.loading = false;},0);
                }.bind(this));
                this.dispatch('getFiles', {project: this.project._id});
                this.dispatch('getStickers', {project: this.project._id});
                this.dispatch('getComments', {project: this.project._id});
            },
            /**
             * Remove all data associated
             * with current user
             */
            cleanUp: function () {
                this.dispatch('cleanProjects');
                this.dispatch('cleanUser');
                this.dispatch('cleanUsers');
                this.dispatch('updateProjectId',null);
            },
            /**
             * Remove all data from redux store
             * associated with current project
             */
            cleanProjectData: function () {
                this.dispatch('cleanProjectState');
                this.dispatch('cleanFolders');
                this.dispatch('cleanFiles');
                this.dispatch('cleanStickers');
                this.dispatch('cleanComments');
            },
            /**
             * Screen state depends on a few things:
             * Is project loading?
             * Does project have error?
             * Is there project at all?
             */
            shouldWeShowElements: function (project) {
                return project && project._id && !project.error && !project.loading;
            },
            shouldWeShowEmptyMessage: function (project) {
                return !project || (!project._id && !project.error && !project.loading);
            },
            shouldWeShowLoading: function (project) {
                return project && project.loading;
            },
            shouldWeShowError: function (project) {
                return project && project.error && !project.loading;
            },
            _computePanelState: function(id,error){
                return !id || error;
            },
            setCuttedElement: function(e){
                if(this.cutted) {
                    this.cutted.cutted = false;
                    const searchCriteria = this.cutted.type==='file'?this.cutted._id:this.getFullPath(this.cutted);
                    this.dispatch('_update'+this.capitalizeFirstLetter(this.cutted.type),searchCriteria,this.cutted);
                }
                this.cutted = e.detail;
            },
            pasteElement: function(){
                this['paste'+this.capitalizeFirstLetter(this.cutted.type)]();
                this.cutted = null;
                this.$$('#contextMenu').close();
            },
            pasteFile: function(){
                this.dispatch('$updateFile',this.cutted._id,{folder:this.currentFolderId,cutted:false});
            },
            pasteFolder: function(){
                const parentFolder = this.findFolderById(this.currentFolderId);
                const folder = Object.assign({},this.cutted);
                folder.parent = this.currentFolderId;
                folder.path = this.getFullPath(parentFolder);
                folder.cutted = false;
                this.dispatch('$updateFolder',this.getFullPath(this.cutted),folder);
            }
        });
    </script>
</dom-module>
