<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../styles/context-menu-shared-styles.html">
<link rel="import" href="../../../styles/lock-shared-styles.html">
<link rel="import" href="../designmap-fs/designmap-fs-service.html">
<link rel="import" href="../designmap-accesses/designmap-accesses.html">
<!-- Redux -->
<link rel="import" href="../../../redux/actions/combine-actions.html">
<link rel="import" href="../../../redux/actions/user-actions.html">
<link rel="import" href="../../../redux/actions/project-actions.html">

<link rel="import" href="./designmap-projects-list.html">

<!-- icons:lock-outline -->
<dom-module is="designmap-advanced-menu">
    <style include="lock-shared-styles"></style>
    <style include="context-menu-shared-styles">
        :host {

            --designmap-circle-button-content-icon-mixin: {
                padding: 0;
                width: 100%;
                height: 100%;
            };
            --designmap-circle-button-circle-mixin: {
                stroke: var(--advanced-menu-main-color) !important;
                stroke-width: 1px;
            };
            --designmap-dropdown-iron-dropdown-mixin: {
                left: 50px !important;
                top: 77px !important;
            };

            --advanced-menu-main-color: var(--gray-saturated-color);
            --designmap-advanced-menu-hoverd: var(--gray-lightern-color);
        }

        *[hidden] {
            display: none !important;
        }

        designmap-circle-button {
            width: 50px;
            height: 50px;
        }
        ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        ul li {
            position: relative;
            display: flex;
            align-items: center;
            white-space: nowrap;
            cursor: pointer;
            transition: background .2s ease-in;
        }

        ul li:hover .text{
            color: var(--gray-super-dark) !important;
            transition: color .2s ease-in;
        }

        ul li[disabled] {
            opacity: 0.6;
        }
        ul li .marker {
            display: none;
            opacity: 0.4;
            position: relative;
            top: 1px;
        }
        ul li.selected .marker{
            display: inline-block;
        }

        ul li designmap-circle-button, ul li .text, ul li designmap-paper-arrow-input {
            display: inline-block;
            vertical-align: middle;
        }

        ul li .text {
            color: var(--advanced-menu-main-color);
            font-size: 16px;
            font-weight: 100;
            vertical-align: middle;
            margin-left: 5px;
        }

        paper-dialog {
            min-width: 300px;
        }

        .trash-count {
            font-size: 14px;
            position: absolute;
            left: 21px;
            top: 16px;
            color: var(--advanced-menu-main-color);
        }

        .empty {
            width: 50px;
            height: 50px;
        }

        ul.indented {
            margin-left: 15px;
        }

        .icon-wrapper {
            display: flex;
            flex: 3;
            height: 100%;
            align-items: center;
            justify-content: flex-end;
        }

        .project-menu {
            width: 30px;
            height: 30px;
            transition: background .2s;
        }

        .project-menu:hover {
            border-radius: 50%;
            background: var(--gray-lightenest-color);
            transition: background .2s;
        }

        .menu li {
            justify-content: center;
        }

        .dot, .chat.marker {
            width: 6px;
            height: 6px;
            margin-left: 10px;
            border-radius: 50%;
            background: var(--gray-super-dark);
        }
        #taskManagerShowCaseDialog {
            padding: 35px !important;
        }

        iron-icon.dialog-close {
            position: absolute;
            top: -15px;
            left: 100%;
            cursor: pointer;
            margin-left: -51px;
            --iron-icon-stroke-color: var(--gray-darkend-color);
            --iron-icon-fill-color: var(--gray-darkend-color);
        }
        .dialog-close.access {
            margin-left: -51px;
            top: -15px;
        }
        .mobile-project-menu {
            display: none;
        }
        .chat-ico {
            width: 28px !important;
            height: 28px !important;
            padding: 12px !important;
        }
        .text.chat-text {
            margin-left: 5px;
        }
        .project-name {
            height: 50px;
            position: relative;
            display: flex;
            align-items: center;
        }
        .project-name .name {
            margin-left: 10px;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--gray-darkend-color);
            font-size: 19px;
        }
        .project-name .icon-wrapper {
            position: absolute;
            left: 100%;
            top: 0;
            margin-left: -30px;
            cursor: pointer;
        }
        .chat.marker:not(.unread) {
            display: none !important;
        }
        .chat.marker.unread {
            display: block;
            background: var(--orange-darky-color);
            position: absolute;
            top: 24px;
            left: 100%;
            margin-left: -38px;
        }
        .upgrade-set {
            display: block;
            margin-top: 10px;
        }
        .upgrade {
            display: inline-block;
            color: var(--white-color);
            background: var(--blue-darkest-color);
            text-align: center;
            text-decoration: none;
            padding: 10px 15px;
            transition: .2s background;
            margin-left: 10px;
        }
        .upgrade:hover {
            background: var(--blue-color);
            transition: .2s background;
        }
        @media (min-width: 320px) and (max-width: 768px) {
            .mobile-project-menu {
                display: block;
                margin-top: 20px;
                border-top: 1px dashed var(--gray-color);
            }
            .mobile-project-menu li:first-child {
                margin-top: 10px;
            }
            .mobile-project-menu li {
                padding: 5px 30px;
                color: var(--gray-darkend-color);
            }
        }

    </style>
    <template>

        <designmap-projects-list menu-mode hidden$="[[project._id]]"></designmap-projects-list>

        <div class="project-name" hidden$="[[!project._id]]">
            <div class="name">[[project.name]]</div>
            <div hidden$="[[!topAccess(user.role)]]" class="icon-wrapper">
                <iron-icon class="project-menu" icon="designmap-workspace:more" on-click="openContext"></iron-icon>
                <!-- Context -->
                <designmap-context-menu id="projectContextMenu" previous>
                    <ul class="menu">
                        <li on-click="openRenameProjectContext">
                            <i18-n msgid="Rename">Rename</i18-n>
                        </li>
                        <!-- Rename project -->
                        <designmap-context-menu darker id="renameProjectContext" previous >
                            <div class="context-content">
                                <iron-a11y-keys id="a11yAddFolder" keys="enter" on-keys-pressed="renameIt"></iron-a11y-keys>
                                <paper-input label$="[[translate('Project Name',language,i18Loaded)]]"
                                             value="{{project.name}}" auto-validate pattern="[\w\dа-яА-ЯёЁ -]+"
                                             error-message="[[translate('ProjectNameError',language,i18Loaded)]]"
                                             id="renameProject"></paper-input>
                                <div class="button-container">
                                    <button is="designmap-round-button" on-click="renameIt">
                                        <iron-icon icon="icons:arrow-forward"></iron-icon>
                                    </button>
                                </div>
                            </div>
                        </designmap-context-menu>
                        <li on-click="openRemoveProjectConfirm" on-touchend="_closeMenu">
                            <i18-n msgid="Remove">Remove</i18-n>
                        </li>
                    </ul>
                </designmap-context-menu>
                <!-- Context -->
            </div>
        </div>

        <ul class="indented" hidden$="[[!project._id]]">
            <!-- Context menu -->
            <li on-click="goToTheProject"   on-mouseover="_mouseOver" on-touchend="_closeMenu" class$="[[_computeSelectedItem(page,trashMode,'fs')]]" on-mouseleave="_mouseLeave"
                data-hint="task-manager-button">
                <designmap-circle-button on-touchend="_closeMenu">
                    <iron-icon icon="designmap-workspace:project"></iron-icon>
                </designmap-circle-button>
                <div class="text" on-touchend="_closeMenu">
                    <i18-n msgid="Files">Files</i18-n>
                </div>
                <div class="marker dot"></div>
            </li>

            <li id="taskManagerItem" on-click="goToTaskManager" on-touchend="_closeMenu"  class$="[[_computeSelectedItem(page,trashMode,'task-manager')]]" on-mouseover="_mouseOver" on-mouseleave="_mouseLeave">
                <designmap-circle-button>
                    <iron-icon icon="designmap-workspace:taskmanager"></iron-icon>
                </designmap-circle-button>
                <!--<iron-icon hidden$="[[user.isPremium]]" class="locked-icon" icon="icons:lock-outline"></iron-icon>-->
                <div class="text">
                    <i18-n msgid="Task manager">Task manager</i18-n>
                </div>
                <div class="marker dot"></div>
            </li>

            <li id="chatItem" on-click="openChat" on-touchend="_closeMenu"  class$="[[_computeSelectedItem(page,trashMode,'chat')]]" on-mouseover="_mouseOver" on-mouseleave="_mouseLeave">
                <designmap-circle-button>
                    <iron-icon class="chat-ico" icon="designmap-user-menu:chat"></iron-icon>
                </designmap-circle-button>
                <!--<iron-icon hidden$="[[user.isPremium]]" class="locked-icon" icon="icons:lock-outline"></iron-icon>-->
                <div class="text chat-text">
                    <i18-n msgid="Project chat">Project chat</i18-n>
                </div>
                <div class="marker dot"></div>
                <div id="chatMarker" class="chat marker"></div>
            </li>

            <li id="accessesItem" on-touchend="_closeMenu" on-click="openSharingDialog" on-mouseover="_mouseOver" on-mouseleave="_mouseLeave">
                <designmap-circle-button>
                    <iron-icon icon="designmap-workspace:link"></iron-icon>
                </designmap-circle-button>
                <!--<iron-icon hidden$="[[user.isPremium]]" class="locked-icon" icon="icons:lock-outline"></iron-icon>-->
                <div class="text">
                    <i18-n msgid="Team">Team</i18-n>
                </div>
            </li>

            <li id="protocolItem" on-click="goToProtocol" on-touchend="_closeMenu"  on-mouseover="_mouseOver" on-mouseleave="_mouseLeave" class="locked">
                <designmap-circle-button>
                    <iron-icon icon="designmap-workspace:protocol"></iron-icon>
                </designmap-circle-button>
                <iron-icon class="locked-icon" icon="icons:update"></iron-icon>
                <div class="text">
                    <i18-n msgid="Protocol">Protocol</i18-n>
                </div>
            </li>

            <li id="trashItem" on-click="goToTrashBox" on-touchend="_closeMenu" on-mouseover="_mouseOver" on-mouseleave="_mouseLeave" class$="[[_computeSelectedItem(page,trashMode,'trash')]]">
                <designmap-circle-button>
                    <iron-icon icon="designmap-workspace:bin"></iron-icon>
                    <div class="trash-count">[[trashLength]]</div>
                </designmap-circle-button>
                <div class="text">
                    <i18-n msgid="Trash">Trash</i18-n>
                </div>
                <div class="marker dot"></div>
            </li>
        </ul>

        <ul class="mobile-project-menu">
            <li on-click="openCreateProjectDialog"><i18-n msgid="Create Project">Create Project</i18-n></li>
            <li on-click="openSelectProjectDialog"><i18-n msgid="Open Project">Open Project</i18-n></li>
        </ul>

        <!--<div class="upgrade-set">
            <a href="/activate" class="upgrade">
                <i18-n msgid="Upgrade">Upgrade</i18-n>
            </a>
        </div>-->

        <!-- Showcase dialog -->
        <!--<paper-dialog no-cancel-on-outside-click id="taskManagerShowCaseDialog" entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-showcase name="task_manager" items="[[taskManagerShowCaseItems]]"></designmap-showcase>
            &lt;!&ndash;<iron-icon dialog-dismiss class="dialog-close" icon="icons:close"></iron-icon>&ndash;&gt;
        </paper-dialog>-->

    </template>
    <script>
        Polymer({
            is: 'designmap-advanced-menu',
            behaviors: [
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapFsService,
                ReduxBehavior,
                Polymer.CombineActions(Polymer.ProjectActions, Polymer.UserActions)
            ],
            properties: {
                i18Loaded: {
                    type: String,
                    statePath: 'i18Loaded'
                },
                user: {
                    type: String,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                project: {
                    type: Object,
                    statePath: 'project'
                },
                projects: {
                    type: Array,
                    statePath: 'projects'
                },
                projectId: {
                    type: String,
                    statePath: 'projectId'
                },
                page: {
                    type: String,
                    value: null
                },
                trashMode: {
                    type: String,
                    statePath: 'trashMode'
                },
                trashLength: {
                    type: Number,
                    statePath: function (state) {
                        const parent = this.currentFolderId || null;
                        const folders = state.folders.filter(function (folder) {
                            return folder.removed;
                        }.bind(this));
                        const files = state.files.filter(function (file) {
                            return file.removed;
                        }.bind(this));
                        return folders.concat(files).length;
                    }
                },
                MQ: {
                    type: String,
                    statePath: 'MQ'
                }
            },
            listeners: {
                'close-share-dialog':'closeShareDialog',
                'on-resize':'_recalculateSharingPopup'
            },
            openProjectList: function (e) {
                this.$.projectList.toggle(e);
            },
            goToTheProject: function (e) {
                page.redirect('/'+(this.projectId||''));
            },
            goToTaskManager: function (e) {
                //if(!this.user.isPremium) return this.$.taskManagerShowCaseDialog.open();
                page.redirect('/'+(this.projectId||'')+'/task-manager/');
            },
            goToProtocol: function(){
               this.fire('open-protocol-showcase')
            },
            goToTrashBox: function (e) {
                if (e.currentTarget.getAttribute('disabled') != undefined) return this.showErrorMessage('You do not have access to make it');
                page.redirect('/'+this.projectId+'/trash');
            },
            openSharingDialog: function (e) {
                if(this.MQ=='sm') return page.redirect('/'+this.projectId+'/accesses');
                this.fire('open-sharing');
            },
            openChat: function(){
                if(this.MQ=='sm') {
                    localStorage.setItem('designmap:lco',new Date());
                    this.async(function(){
                        document.querySelector('designmap-app')._setUnreadMark({detail:false});
                    },300);
                    return page.redirect('/'+this.projectId+'/chat');
                }
                this.fire('open-chat');
            },
            closeShareDialog: function(){
                this.$.sharingDialog.close();
            },
            openRenameMenu: function (e) {
                if (e.currentTarget.getAttribute('disabled') != undefined) return this.showErrorMessage('You do not have access to make it');
                this.$.renameProjectContext.open(e);
                this.async(function () {
                    this.$.renameProject.focus();
                }, 150);
            },
            renameIt: function (e) {
                // Validation
                if (!this.project.name) return this.showErrorMessage('Name can\'t be empty.');
                // Close
                this.$.renameProjectContext.close();
                this.async(function(){this.$.projectContextMenu.close();},100);
                // Fire event
                this.renameProject(this.project._id, this.project.name);
            },
            openRemoveConfirm: function (e) {
                if (e.currentTarget.getAttribute('disabled') != undefined) return this.showErrorMessage('You do not have access to make it');
                this.$.removeProjectConfirm.open();
            },


            _computeProjectName: function(name){
                return name || '';
            },
            /**
             * Open context for
             * current selected project
             */
            openContext: function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.$.projectContextMenu.toggle(e);
            },
            openRenameProjectContext: function (e) {
                this.$.renameProjectContext.toggle(e);
                this.async(function () {
                    this.$.renameProject.focus()
                }, 150);
            },
            openRemoveProjectConfirm: function (e) {
                this.fire('open-project-remove');
            },
            _computeSelectedItem: function (page,trashMode,name) {
                if(trashMode && page!='task-manager') page = 'trash';
                return page==name?'selected':'';
            },
            _mouseOver: function(e){
                const target = e.currentTarget;
                target.querySelector('designmap-circle-button').classList.add('hovered');
            },
            _mouseLeave: function(e){
                const target = e.currentTarget;
                target.querySelector('designmap-circle-button').classList.remove('hovered');
            },
            _closeMenu: function(){
                if(!this.isMobile() || this.MQ!='sm') return;
                this.fire('close-menu');
            },
            openCreateProjectDialog: function(){
                this.fire('close-menu');
                this.fire('open-create-project-dialog');
            },
            openSelectProjectDialog: function(){
                this.fire('close-menu');
                this.fire('open-select-project-dialog');
            }
        });
    </script>
</dom-module>
