<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">
<link rel="import" href="/bower_components/iron-resizable/iron-resizable-behavior.html">
<link rel="import" href="/bower_components/iron-icons/social-icons.html">
<link rel="import" href="/bower_components/cbn-copy-clipboard/cbn-copy-clipboard.html">
<link rel="import" href="../designmap-buttons/designmap-gallery-button.html?20170615">
<link rel="import" href="../designmap-tutorial/designmap-hint.html?20170615">
<link rel="import" href="../designmap-ui/designmap-hidden-panel.html?20170615">
<link rel="import" href="../designmap-ui/designmap-dropdown.html?20170615">
<link rel="import" href="../designmap-ui/designmap-showcase.html?20170615">
<link rel="import" href="../designmap-ui/designmap-stub.html?20170615">
<link rel="import" href="./designmap-stickers.html?20170615">
<link rel="import" href="../designmap-icons/designmap-logo-icons.html?20170615">
<link rel="import" href="./designmap-gallery-user-list.html?20170615">
<!-- Redux -->
<link rel="import" href="../../../redux/actions/user-actions.html?20170615">
<link rel="import" href="../../../redux/actions/files-actions.html?20170615">
<link rel="import" href="../../../redux/actions/stickers-actions.html?20170615">
<link rel="import" href="../../../redux/actions/comments-action.html?20170615">
<!-- Styles -->
<link rel="import" href="../../../styles/context-menu-shared-styles.html?20170615">

<dom-module id="designmap-gallery">
    <template>
        <style include="context-menu-shared-styles">
            :host {
                width: 100%;
                height: 100vh;
                display: flex !important;
                flex-direction: column;

                --designmap-gallery-panel-height: var(--header-height);
                --designmap-gallery-color: var(--gray-lightern-color);
                --designmap-gallery-line-color: var(--white-color);

                /**repeating-linear-gradient(-45deg, var(--designmap-gallery-color), var(--designmap-gallery-line-color) 5px, rgba(256, 256, 256, 0.3) 5px, rgba(256, 256, 256, 0.3) 6px);**/
                --designmap-gallery-striped-background: repeating-linear-gradient(-45deg, var(--designmap-gallery-color), var(--designmap-gallery-line-color) 5px, var(--white-color) 5px, var(--white-color) 6px);

                --designmap-dropdown-triangle-mixin: {
                    margin-left: -18px;
                    border-color: transparent transparent var(--white-color) transparent !important;
                };
                --designmap-dropdown-triangle-border-mixin: {
                    margin-left: -20px;
                    margin-top: -2px;
                    border-color: transparent transparent var(--gray-color) transparent !important;
                };
                --designmap-dropdown-mixin: {
                    border: 1px solid var(--gray-color);
                    background: var(--white-color) !important;
                    box-shadow: 0 6px 15px -5px rgba(0, 0, 0, 1);
                };
            }

            *[hidden] {
                display: none !important;
            }

            .panel {
                background: transparent;
            }

            /** top-panel **/
            .top-panel, .bottom-panel {
                width: 100%;
                flex-basis: calc(var(--designmap-gallery-panel-height) + 15px);
                display: flex;
                align-items: center;
            }

            .top-panel {
                background: var(--gray-lightern-color);
            }

            .top-panel .left, .top-panel .right, .bottom-panel .left, .bottom-panel .right {
                display: flex;
                flex-basis: var(--designmap-gallery-panel-height);
                align-items: center;
            }

            .breadcrumbs {
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                right: 20px;
                top: 2px;
                color: var(--gray-darkend-color);
            }

            .top-panel .center, .bottom-panel .center {
                flex-grow: 11;
                justify-content: space-between;
            }

            .top-panel .center .left {

            }

            .top-panel .right, .bottom-panel .right {
                display: flex;
                justify-content: flex-end;
            }

            .top-panel-button {
                margin-right: 10px;
            }

            /** CONTENT **/
            .content {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                background: var(--designmap-gallery-striped-background);
                flex: 2;
            }

            .content .item {
                cursor: crosshair;
                height: 100%;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .content .item.zoomed {
                cursor: move;
            }

            /** IMAGES **/
            .content iron-image {

                /*height: calc(100vh - 150px);
                width: calc(100% - 200px);*/
                --iron-image-mixin: {
                    /*max-width: 100%;
                    max-height: 100%;
                    min-width: 120px;
                    min-height: 200px;*/
                    /*object-fit: contain;*/
                    max-height: calc(100vh - 150px);
                    max-width: calc(100vw - 200px);
                    background: url('/assets/images/svg/three-dots-gray.svg') no-repeat center;
                    -khtml-user-select: none;
                    -o-user-select: none;
                    -moz-user-select: none;
                    -webkit-user-select: none;
                    user-select: none;
                };
            }

            .content .item.no-transitions {
                transition: none;
                cursor: move !important;
            }

            .content iron-image.cancel-loading {
                background: transparent;
            }

            .content iron-image.zoomed:active {
                cursor: move;
            }

            .content #stickers {
                /*position: relative;*/
            }

            /** LEFT RIGHT **/
            .previous, .next {
                position: absolute;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100px;
                height: 100%;
                background: rgba(0, 0, 0, 0.02);
                transition: .2s background;
                cursor: pointer;
            }

            .previous:hover, .next:hover {
                background: rgba(0, 0, 0, 0.1);
                transition: .2s background;
            }

            .previous iron-icon, .next iron-icon {
                --iron-icon-stroke-color: var(--gray-super-dark);
                --iron-icon-fill-color: var(--gray-super-dark);
                --iron-icon-width: 50px;
                --iron-icon-height: 50px;
            }

            .previous {
                left: 0;
            }

            .next {
                left: 100%;
                margin-left: -100px;
            }

            /** EXTENSION **/
            .extension {
                width: 25vw;
                height: 25vw;
                color: var(--gray-darky-hovered-color);
                border: 1px solid var(--gray-darky-hovered-color);
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .extension .data {
                width: 80%;
                height: 80%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-around;
            }

            .extension .data .ext-icon {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .extension .data .ext-icon iron-icon {
                --iron-icon-width: 80%;
                --iron-icon-height: 80%;
                --iron-icon-components-mixin: {
                    stroke-width: 0.3;
                };
            }

            .extension .data .ext-icon span {
                position: absolute;
                text-transform: uppercase;
                font-size: 5vh;
            }

            .extension .data a {
                color: var(--blue-darkest-color);
            }

            .error {
                width: 25vw;
                height: 25vw;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /** bottom-panel **/
            .bottom-panel {
                width: 100%;
                flex-basis: var(--designmap-gallery-panel-height);
                background: var(--gray-lightern-color);
            }

            .bottom-panel .center {
                display: flex;
                align-items: center;
                justify-content: space-between !important;
                flex-grow: 1;
            }
            .bottom-panel .left, .bottom-panel .right {
                flex-grow: 20;
            }

            .bottom-panel button {
                width: 38px;
                height: 38px;
            }

            .bottom-panel-button {
                margin-right: 5px;
                width: 28px;
                height: 28px;
                --iron-icon-components-mixin: {
                    stroke-width: 2px;
                };
            }

            .designmap-logo {
                cursor: pointer;
                margin-left: 30px;
                width: 200px;
                height: 70px;
            }

            .right-button {
                margin-right: 30px;
            }

            .more-icon {
                width: 50px !important;
                height: 50px !important;
                --iron-icon-components-mixin: {
                    stroke: var(--white-color) !important;
                    fill: var(--white-color) !important;
                };
            }

            .chat-icon {
                width: 30px !important;
                height: 30px !important;
                --iron-icon-components-mixin: {
                    stroke-width: 2px;
                };
            }

            .share-icon {
                width: 30px !important;
                height: 30px !important;
                --iron-icon-stroke-color: var(--white-color);
                --iron-icon-fill-color: var(--white-color);
                --iron-icon-components-mixin: {
                    stroke-width: 0.1px;
                };
            }

            .phone-icon {
                width: 45px !important;
                height: 45px !important;
                --iron-icon-components-mixin: {
                    stroke-width: 1px;
                };
            }

            .resize-icon, .plus-icon, .minus-icon {
                width: 30px !important;
                height: 30px !important;
                --iron-icon-components-mixin: {
                    stroke-width: 2px;
                };
            }

            .close-icon {
                --iron-icon-components-mixin: {
                    stroke-width: 3px;
                };
            }

            .bottom-panel .center {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            designmap-gallery-user-list {
                margin-left: 30px;
            }

            .title {
                text-align: center;
            }

            .plus-button {
                margin-left: 10px;
            }

            .minus-button {
                margin-right: 10px;
            }

            .link  {
                padding: 10px 5px;
                border: 1px dashed var(--gray-color);
                color: var(--gray-darkend-color);
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .copy-button {
                width: 100%;
                font-size: 15px;
            }

            .hint {
                position: absolute;
                background: rgba(0,0,0,0.4);
                border-radius: 10px;
                padding: 10px 5px;
                color: var(--white-color);
                font-size: 14px;
            }

            paper-dialog {
                padding: 35px !important;
            }

            designmap-dropdown .title {
                text-align: center;
                padding-bottom: 5px;
                color: var(--gray-darky-hovered-color)
            }

            .showcase-dialog {
                z-index: 8888;
            }

            .borders {
                width: 300px;
                height: 300px;
                border: 1px solid var(--gray-color);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size:50px;
                text-transform: uppercase;
                font-weight: 700;
                color: var(--gray-darky-hovered-color);
                background: var(--white-color);
            }

        </style>
        <div class="top-panel panel">
            <div class="left">
                <iron-icon class="designmap-logo" on-click="close" icon="designmap-logo:logo-gray"></iron-icon>
            </div>
            <div class="center" data-hint="file-top-panel">
                <div class="left" hidden$="[[!file]]">
                    <div class="breadcrumbs">
                        <iron-icon class="bread-separator" icon="icons:chevron-left"></iron-icon>
                        <span>[[cutFileName(file)]]</span>
                    </div>
                </div>
                <div class="right">

                </div>
            </div>
            <div class="right">
                <button hidden$="[[!file]]" id="callButton" class="top-panel-button" is="designmap-gallery-button" on-click="call">
                    <iron-icon class="phone-icon" icon="designmap:phone"></iron-icon>
                </button>
                <paper-tooltip for="callButton"><i18-n msgid="Call">Call</i18-n></paper-tooltip>
                <!--<button hidden$="[[!file]]" id="chatButton" class="top-panel-button" is="designmap-gallery-button" on-click="chat">
                    <iron-icon class="chat-icon" icon="designmap:chat"></iron-icon>
                </button>-->
                <paper-tooltip for="chatButton"><i18-n msgid="Chat">Chat</i18-n></paper-tooltip>
                <button hidden$="[[!file]]" id="shareButton" class="top-panel-button" is="designmap-gallery-button" on-click="share">
                    <iron-icon class="share-icon" icon="social:share"></iron-icon>
                </button>
                <designmap-dropdown previous id="shareDropdown" tri-border vertical-offset="60" horizontal-offset="-107">
                    <!--<div class="title">
                        <i18-n msgid="Share this file">Share this file</i18-n>
                    </div>-->
                    <div on-click="_selectAll" class="link">[[_buildLink(file.*)]]</div>
                    <cbn-copy-clipboard  value="[[_buildLink(file.*)]]">
                        <button class="copy-button" is="designmap-button" on-click="_copyToClipBoard" thin gray>
                            <i18-n msgid="Copy to clipboard">Copy to clipboard</i18-n>
                        </button>
                    </cbn-copy-clipboard>
                </designmap-dropdown>
                <paper-tooltip for="shareButton"><i18-n msgid="Share">Share</i18-n></paper-tooltip>
                <designmap-hint id="shareHint"
                                target="[[shareButton]]"
                                name="share"
                                vertical-offset="60"
                                horizontal-offset="-107">
                    <div class="title">
                        <i18-n msgid="Share file">Share file</i18-n>
                    </div>
                    <div class="desc">
                        <i18-n msgid="shareFileMsg">shareFileMsg</i18-n>
                    </div>
                </designmap-hint>
                <button hidden$="[[!file]]" id="moreButton" class="top-panel-button" is="designmap-gallery-button" on-click="openContext">
                    <iron-icon class="more-icon" icon="designmap-workspace:more"></iron-icon>
                </button>
                <paper-tooltip for="moreButton"><i18-n msgid="File menu">File menu</i18-n></paper-tooltip>
                <designmap-context-menu id="galleryContext" previous>
                    <ul class="menu">
                        <li on-click="downloadFile">
                            <i18-n msgid="Download file">Download file</i18-n>
                        </li>
                        <!--<li on-click="lockFile">
                            <i18-n msgid="[[_computeLockMessage(file.locked,i18Loaded)]]">Lock</i18-n>
                        </li>-->
                        <li hidden$="[[!lowAccess(user.fileRole)]]" on-click="removeFile">
                            <i18-n msgid="Remove file">Remove file</i18-n>
                        </li>
                    </ul>
                </designmap-context-menu>
                <button id="closeButton" class="right-button" is="designmap-gallery-button"
                        x-tooltip$="[[translate('Close gallery',language,i18Loaded)]]" on-click="close">
                    <iron-icon class="close-icon" style="transform: rotate(45deg)" icon="designmap:add"></iron-icon>
                </button>
                <paper-tooltip for="closeButton"><i18-n msgid="Close">Close</i18-n></paper-tooltip>
            </div>
        </div>
        <div class="content">
            <div class="previous" on-click="previous" hidden$="[[_computeButtons(files.*)]]">
                <iron-icon icon="icons:chevron-left"></iron-icon>
            </div>
            <template is="dom-if" if="[[!loading]]">
                <template is="dom-if" if="[[canBeDisplayed(file)]]" restamp="true">
                    <div id="item"
                         draggable="false"
                         class$="item {{zoomClasses(zoom)}}"
                         ondragstart="return false;"
                         on-mousewheel="imageMouseWheel"
                         on-wheel="imageMouseWheel"
                         on-mouseleave="mouseLeave"
                         on-mousedown="mouseDown"
                         on-mousemove="mouseMove"
                         on-mouseup="mouseUp">

                        <iron-image
                                id="image"
                                on-load="imageHasLoaded"
                                on-error="imageError"
                                src="{{computeFileSrc(file)}}"></iron-image>

                        <designmap-stickers class$="[[zoomClasses(zoom)]]" is-there-opened="{{isThereOpened}}" id="stickers" sticker-catch="{{stickerCatch}}" moved="[[moved]]" pressed="[[pressed]]" file="[[file]]" zoom="[[zoom]]"></designmap-stickers>
                    </div>
                    <div class="hint" hidden$="[[!showHint]]">
                        <i18-n msgid="Click on image to leave comment">Click on image to leave comment</i18-n>
                    </div>
                </template>
                <template is="dom-if" if="[[!canBeDisplayed(file)]]" restamp="true">
                    <div class="extension">
                        <div class="data">
                            <i18-n msgid="Preview is not available">Preview is not available</i18-n>
                            <div class="ext-icon">
                                <iron-icon icon="designmap-workspace:filer"></iron-icon>
                                <span class="ext">{{getExtensionWithoutDot(file.data.name)}}</span>
                            </div>
                            <a href="#" on-click="downloadFile">
                                <i18-n msgid="Download file">Download file</i18-n>
                            </a>
                        </div>
                    </div>
                </template>
                <template is="dom-if" if="[[error]]">
                    <div class="error">
                        <designmap-stub image="designmap-workspace-stub:error" message="[[error]]"
                                        error></designmap-stub>
                    </div>
                </template>
            </template>
            <template is="dom-if" if="[[_computeLoading(loading,error)]]">
                <img src="/assets/images/svg/three-dots-gray.svg" alt="Loading">
            </template>
            <template is="dom-if" if="[[error]]">
                <designmap-stub error
                                image="designmap-workspace-stub:error"
                                message="[[error]]"></designmap-stub>
            </template>
            <div class="next" on-click="next" hidden$="[[_computeButtons(files.*)]]">
                <iron-icon icon="icons:chevron-right"></iron-icon>
            </div>
        </div>
        <div class="bottom-panel panel">
            <div class="left">
                <!--<designmap-gallery-user-list></designmap-gallery-user-list>-->
            </div>
            <div class="center" hidden$="[[!canBeDisplayed(file)]]">
                <button class="minus-button" is="designmap-gallery-button" on-click="zoomOut">
                    <iron-icon class="minus-icon" icon="designmap:minus"></iron-icon>
                </button>
                <button class="resize-button" is="designmap-gallery-button" on-click="clearZoom">
                    <iron-icon class="resize-icon" icon="designmap:resize"></iron-icon>
                </button>
                <button class="plus-button" is="designmap-gallery-button" on-click="zoomIn">
                    <iron-icon class="plus-icon" icon="designmap:add"></iron-icon>
                </button>
            </div>
            <div class="right">
                <!--<button class="resize-button" is="designmap-gallery-button" on-click="clearZoom">
                    <iron-icon class="resize-icon" icon="designmap:resize"></iron-icon>
                </button>-->
            </div>
        </div>
        <!-- Showcase dialog -->
        <paper-dialog id="chatShowCaseDialog" class="showcase-dialog"  entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-showcase name="chat" faster items="[[chatShowCaseItems]]"></designmap-showcase>
        </paper-dialog>
        <!-- Showcase dialog -->
        <paper-dialog id="callShowCaseDialog" class="showcase-dialog" entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-showcase name="call" faster items="[[callShowCaseItems]]"></designmap-showcase>
        </paper-dialog>
        <!-- Showcase dialog -->
        <paper-dialog id="protocolShowCaseDialog" class="showcase-dialog" entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-showcase name="protocol" items="[[protocolShowCaseItems]]"></designmap-showcase>
        </paper-dialog>
    </template>
    <script>
        Polymer({
            is: 'designmap-gallery',
            behaviors: [
                Polymer.IronOverlayBehavior,
                Polymer.NeonAnimationRunnerBehavior,
                Polymer.IronResizableBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapWebAnimationBehavior,
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapFsService,
                ReduxBehavior,
                Polymer.CombineActions(Polymer.UserActions, Polymer.FilesActions, Polymer.StickersActions, Polymer.CommentsActions)
            ],
            // Zoom options
            step: 0.1,
            maxZoom: 3,
            minZoom: 1,
            // Move top\left options
            pressed: false,
            // State of page cords and top\left styles
            pageY: 0,
            pageX: 0,
            top: 0,
            left: 0,
            // Horizontal\vertical offset bounding image dragging.
            horizontalRestriction: 100,
            verticalRestriction: 100,
            // Files with same extension can be displayed
            canBeDisplayedExt: [".jpg", ".png", ".gif", ".ttf", ".rif", ".bmp", ".jpg", ".hdr", ".ppm", ".pbm",".ai",".psd",".eps"],
            objectIDRegexp: /^(?=[a-f\d]{24}$)(\d+[a-f]|[a-f]+\d)/i,
            properties: {
                projectId: {
                    type: String,
                    statePath: 'projectId'
                },
                fileId: {
                    type: String,
                    statePath: 'fileId',
                    observer: '_fileIdChanged'
                },
                path: {
                    type: String,
                    statePath: 'path'
                },
                folderId: {
                    type: String,
                    statePath: 'folderId'
                },
                files: {
                    type: Array,
                    statePath: function (state) {
                        return state.files.filter(function (file) {
                            return !file.removed && String(file.folder) == String(this.folderId);
                        }.bind(this));
                    }
                },
                file: {
                    type: Object,
                    value: null
                },
                /**
                 * Current zoom
                 */
                zoom: {
                    type: Number,
                    value: function () {
                        return this.minZoom
                    }
                },
                loading: {
                  type: Boolean,
                  value: false
                },
                stickers: {
                    type: Array,
                    statePath: 'stickers'
                },
                /**
                 * Role
                 */
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                showHint: {
                    type: Boolean,
                    value: false
                },
                shareButton: {
                    type: Object,
                    value: function(){
                        return this.$.shareButton
                    }
                },
                chatShowCaseItems: {
                    type: Array,
                    value: [
                        {icon:'designmap-showcase:chat',message:'chatShowCaseOneMsg'}
                    ]
                },
                callShowCaseItems: {
                    type: Array,
                    value: [
                        {icon:'designmap-showcase:call',message:'callShowCaseOneMsg'}
                    ]
                },
                protocolShowCaseItems: {
                    type: Array,
                    value: [
                        {icon:'designmap-showcase:protocol',message:'protocolShowCaseOneMsg'}
                    ]
                },
                error: {
                    type: String,
                    value: ''
                },
                isThereOpened: {
                    type: Boolean,
                    value: false
                }
            },
            observers: [
                '_entityIdChanged(entityId,entityType)'
            ],
            listeners: {
                'open-protocol-showcase': "openProtocolShowCase",
                'close-showcase-dialog': "closeShowCaseDialog",
                'iron-resize': '_onIronResize'
            },
            attached: function(){
              this.refitStickers();
              this.async(function(){
                  this.refitStickers();
              },1000)
            },
            /**
             * Whe file id changed
             */
            _fileIdChanged: function (fileId) {
                this.error = false;
                this.loading = true;
                // Work with file
                const file = this.findFileById(fileId);
                if (file) {
                    this.loading = false;
                    return this.file = file;
                }
                // Get data if there is no any file.
                this.dispatch('getStickers', {file: fileId});
                this.dispatch('getComments', {file: fileId});
                this.dispatch('getFile', fileId).then(function (response) {
                    if (!response.success) return this.error = response.errors.message;
                    this.loading = false;
                    this.file = response.file;
                }.bind(this)).catch(function(err){
                    this.loading = false;
                    this.manageErrorResponse(err);
                }.bind(this));
            },
            /**
             * Previous file
             */
            previous: function (e) {
                this.clearZoom();
                let previousIndex = this.files.indexOf(this.file) - 1;
                if (previousIndex < 0) previousIndex = this.files.length - 1;
                const previousFileId = this.files[previousIndex]._id;
                page.redirect('/gallery/' + previousFileId);
            },
            /**
             * Set zoom to zero
             */
            clearZoom: function () {
                var target = this.$$('#item');
                this.zoom = 1;
                if (!target) return;
                target.style.transform = 'scale(' + this.zoom + ')';
                target.style.top = '0px';
                target.style.left = '0px';
            },
            /**
             * Next file
             */
            next: function (e) {
                this.clearZoom();
                let nextIndex = this.files.indexOf(this.file) + 1;
                if (nextIndex >= this.files.length) nextIndex = 0;
                const nextFileId = this.files[nextIndex]._id;
                page.redirect('/gallery/' + nextFileId);
            },
            /**
             * Close gallery, but before we have to play exit animation
             */
            close: function () {
                if(this.user && this.user.fake) this.dispatch('cleanUser');
                page.redirect('/' + (this.projectId || '') + (this.path?this.path:''));
            },
            /**
             * Is Previous button disabled?
             * @param selected - current selected item
             * @param imageIsAnimating - Are images animating? Or not?
             * @returns {boolean}
             */
            disablePreviousButton: function (selected, imageIsAnimating) {
                return selected == 0 || imageIsAnimating;
            },
            /**
             * Is Next button disabled?
             * @param selected
             * @param allImagesHaveLoaded - state of images. If all images are loaded this variable is true
             * @returns {boolean}
             */
            disableNextButton: function (selected, imageIsAnimating) {
                return this.files ? selected == (this.files.length - 1) || imageIsAnimating : false;
            },
            /**
             * Generate file name for selected file.
             * @param selected
             * @returns {string}
             */
            renderFileName: function (selected, splices) {
                return this.files[selected] ? (selected + 1) + '/' + this.files.length + '  ' + this.getElementName(this.files[selected]) : null;
            },
            /**
             * Add some classes to image
             */
            zoomClasses: function (zoom, index) {
                return zoom!=1 ? 'zoomed' : '';
            },
            /**
             * When we scroll mouse wheel on images.
             * @param e
             */
            imageMouseWheel: function (e) {
                /*var stickers = Polymer.dom(this.$.pages).querySelector('*[file-id="' + e.model.file._id + '"]');
                 if (stickers.overArea) return;*/
                if(this.isThereOpened) return;

                var target = this.$$('#item');
                // Define mouse wheel event details
                var delta = e.deltaY || e.detail || e.wheelDelta;
                if (delta < 0) {
                    // Scroll mouse wheel up
                    this.zoom = this.zoom + this.step < this.maxZoom ? this.zoom + this.step : this.maxZoom;
                }
                else {
                    // Scroll mouse wheel down
                    this.zoom = this.zoom - this.step > this.minZoom ? this.zoom - this.step : this.minZoom;
                }
                // Get current position of image
                var top = parseInt(target.style.top);
                var left = parseInt(target.style.left);
                // If we scroll the mouse wheel down we have to return the image to start position
                // in this case that's mean image's styles have to be like
                // top: 0px left: 0px
                if ((top || left) && delta > 0) {
                    this.returnImageToZeroPosition(target, top, left);
                }
                target.style.transform = 'scale(' + this.zoom + ')';
                e.preventDefault();
                this.$$('#stickers').closeAllStickers();
            },
            /**
             * Return image position to default
             * @param image - image node
             * @param top - current "top" style
             * @param left - current "left" style
             */
            returnImageToZeroPosition: function (image, top, left) {
                // How many steps left to reach 0 ?
                var steps = (this.zoom - this.minZoom) / this.step;
                // Decrease distance to the zero point.
                image.style.top = (top - (Math.round(top / steps))) + 'px';
                image.style.left = (left - (Math.round(left / steps))) + 'px';
                // Refit image position if zoom equals to min zoom value.
                if (this.zoom == this.minZoom) {
                    image.style.top = '0px';
                    image.style.left = '0px';
                }
            },
            /**
             * When mouse was pressed while
             * cursor was located on image
             * @param e
             */
            mouseDown: function (e) {
                if(this.stickerCatch) return;
                var target = this.$$('#item');
                this.pressed = true;
                // Save page positions
                this.pageY = e.pageY;
                this.pageX = e.pageX;
                // Save top\left "cords"
                this.top = parseInt(target.style.top) || 0;
                this.left = parseInt(target.style.left) || 0;
                // Forbid transitions (using on mouse wheel down scrolling)
                if(this.zoom!=1) target.classList.add('no-transitions');
            },
            /**
             * Drag image after mouse moves.
             * @param e
             */
            mouseMove: function (e) {
                if (!this.pressed || this.zoom==1) return false;
                // Take target
                var target = this.$$('#item');
                // Horizontal
                var canMoveLeft = target.getBoundingClientRect().left < this.horizontalRestriction;
                var canMoveRight = target.getBoundingClientRect().right > window.innerWidth - this.horizontalRestriction;
                var deltaX = (e.pageX - this.pageX);
                if ((!canMoveLeft && deltaX > 0) || (!canMoveRight && deltaX < 0)) {
                    this.pageX = e.pageX;
                    this.left = parseInt(target.style.left) || 0;
                }
                // Define direction of restriction.
                var canMoveX = deltaX < 0 ? canMoveRight : canMoveLeft;
                // Vertical
                var canMoveTop = target.getBoundingClientRect().top < this.verticalRestriction;
                var canMoveBottom = target.getBoundingClientRect().bottom > window.innerHeight - this.verticalRestriction;
                var deltaY = (e.pageY - this.pageY);
                if ((!canMoveTop && deltaY > 0) || (!canMoveBottom && deltaY < 0)) {
                    this.pageY = e.pageY;
                    this.top = parseInt(target.style.top) || 0;
                }
                // Define direction of restriction.
                var canMoveY = deltaY < 0 ? canMoveBottom : canMoveTop;
                // Move
                if (canMoveY) target.style.top = this.top + deltaY + 'px';
                if (canMoveX) target.style.left = this.left + deltaX + 'px';
                if ((canMoveY && deltaY) || (canMoveX && deltaX)) this.moved = true;
            },
            /**
             * After mouse button had released change states
             * and decline transition hiding
             * @param e
             */
            mouseUp: function (e) {
                var target = this.$$('#item');
                target.classList.remove('no-transitions');
                this.pressed = false;
                this.async(function(){this.moved = false;},10);
            },
            /**
             * To prevent some negative effects of
             * unexpected mouse leaving - make following.
             * @param e
             */
            mouseLeave: function (e) {
                var target = this.$$('#item');
                this.pressed = false;
                target.classList.remove('no-transitions');
            },
            /**
             * When image has loaded we have to hide loading bar.
             * @param e
             */
            imageHasLoaded: function (e) {
                e.model.file.hadLoaded = true;
                e.target.classList.add('cancel-loading');
                this.refitStickers();
            },
            /**
             * Get extension of the file
             */
            getExtension: function (name) {
                if (!name) return null;
                var splitter = name.split('.');
                var ext = '.' + splitter[splitter.length - 1];
                return ext;
            },
            /**
             * Get extension of the file without dot
             */
            getExtensionWithoutDot: function (name) {
                if (!name) return null;
                var splitter = name.split('.');
                var ext = splitter[splitter.length - 1];
                return ext;
            },
            /**
             * We should define whether file could be displayed or not.
             * @param name
             */
            canBeDisplayed: function (file) {
                if(this.error) return false;
                if(!file) return false;
                if(!file.data) return false;
                var name = file.data.name;
                var ext = this.getExtension(name);
                return this.canBeDisplayedExt.indexOf(ext.toLowerCase()) != -1 || file.preview;
            },
            /**
             * Whether file locked?
             */
            whetherLocked: function (acl, lock) {
                return !(!this.isOwner() && lock);
            },
            /**
             * If image wasn't loaded
             * @param e
             */
            imageError: function (e) {
                this.refitStickers();
            },
            /**
             * Remove file.
             * Fire special event because it will be more
             * convenient to handle this operation out from here
             */
            removeFile: function () {
                var file = this.file;
                this.dispatch('updateFile', file._id, {removed: true}, file.project).then(function () {
                    this.showUndoMessage('File was removed successfuly.', {"#FILE#": file.data.name});
                    this.close();
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
            },
            /**
             * Lock\unlock file.
             * Fire event and handle it inside the gallery
             */
            lockFile: function () {
                var file = this.file;
                this.dispatch('updateFile', file._id, {locked: !file.locked}, file.project).then(function () {
                    this.showMessage('File was locked successfully.',{"#FILE#":file.data.name});
                }.bind(this)).catch(this.manageErrorResponse.bind(this));
            },
            /**
             * To prevent empty gallery screen!
             * We are watching current folder, because before removing is method
             * which subscribed on all of folders.
             */
            beforeRemoving: function (e) {
                // Define certain folder
                if (this.selected == (this.files.length - 1) && this.selected != 0) {
                    this.entryAnimation = '';
                    this.exitAnimation = '';
                    this.selected = this.selected - 1 >= 0 ? this.selected - 1 : this.selected;
                }
            },
            /**
             * Download file. Right from gallery.
             */
            downloadFile: function () {
                window.open(this.file.data.url.replace("#SERVER#", Designmap.config.apiURL));
            },
            /**
             * Can user lock file?
             * @param acl
             * @returns {boolean}
             */
            canUserLock: function (acl) {
                return this.isOwner();
            },
            /**
             * Compute file url
             * @param file
             * @returns {*}
             */
            computeFileSrc: function (file) {
                if(file.data.preview && file.data.preview.indexOf('#SERVER#')!==-1) return file.data.preview.replace('#SERVER#', Designmap.config.apiURL);
                return file.preview ? file.preview.url : file.data.url.replace('#SERVER#', Designmap.config.apiURL);
            },
            /**
             * Compute id of image
             * @param selected
             * @returns {string}
             */
            computeID: function (selected) {
                return 'item-' + selected;
            },
            /**
             * Zoom in on button
             * @returns {number}
             */
            zoomIn: function () {
                this.zoom += this.step;
                if (this.zoom > this.maxZoom) return this.zoom = this.maxZoom;
                var target = this.$$('#item');
                target.style.transform = 'scale(' + this.zoom + ')';
                this.$$('#stickers').closeAllStickers();
            },
            /**
             * Zoom out on button
             * @returns {number}
             */
            zoomOut: function () {
                this.zoom -= this.step;
                if (this.zoom < this.minZoom) return this.zoom = this.minZoom;
                var target = this.$$('#item');
                target.style.transform = 'scale(' + this.zoom + ')';
                // Get current position of image
                var top = parseInt(target.style.top);
                var left = parseInt(target.style.left);
                // Down to zero
                this.returnImageToZeroPosition(target, top, left);
            },
            _computeButtons: function (files) {
                return this.files.length <= 1;
            },
            _computeFileName: function (file, filesLength) {
                return (this.files.indexOf(file) + 1) + '/' + filesLength + ' ' + this.cutFileName(file)
            },
            _computeStickersClass: function (stickerMode) {
                return stickerMode ? 'hide' : '';
            },
            _computeLockMessage: function(locked){
                return locked?"Lock":"Unlock";
            },
            openContext: function(e){
                this.$.galleryContext.toggle(e);
            },
            _buildLink: function(){
                return location.href;
            },
            share: function(){
                this.$.shareDropdown.open();
                // Hints
                const tutorial = document.querySelector('designmap-app').$.tutorial;
                if(tutorial.isRunning=='share') {
                    tutorial.isRunning = '';
                    tutorial.close();
                    this.async(function(){tutorial.thumbUp();},100);
                }
            },
            _selectAll: function(e){
                this.selectText(e.target);
            },
            _copyToClipBoard: function(){
                this.showMessage('Link was copied to your clipboard.')
                this.$.shareDropdown.close();
            },
            chat: function(){
                this.$.chatShowCaseDialog.open();
            },
            call: function(){
                this.$.callShowCaseDialog.open();
            },
            openProtocolShowCase: function(){
                this.$.protocolShowCaseDialog.open();
            },
            closeShowCaseDialog: function(){
                this.$.chatShowCaseDialog.close();
                this.$.callShowCaseDialog.close();
                this.$.protocolShowCaseDialog.close();
            },

            _onIronResize: function(){
                this.refitStickers();
            },

            refitStickers: function(){
                var image = this.$$('#image');
                var img = image?image.$.img:null;
                if(img) {
                    var b = img.getBoundingClientRect();
                    this.$$('#stickers').style.height = b.height + 'px';
                    this.$$('#stickers').style.top = '50%';
                    this.$$('#stickers').style.marginTop = -(b.height/2) + 'px';
                }
            },

            _computeLoading: function(loading,error){
                return loading && !error;
            }
        });
    </script>
</dom-module>
