<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../designmap-buttons/designmap-button.html">
<link rel="import" href="../../../behaviors/designmap-messages-behavior.html">
<link rel="import" href="../../../behaviors/deisgnmap-utils-behavior.html">
<link rel="import" href="../designmap-ui/designmap-dashboard.html">
<link rel="import" href="../designmap-buttons/designmap-button.html">

<link rel="import" href="./designmap-pay.html">



<dom-module id="designmap-activate">
    <template>
        <style>
            :host {
                width: 100%;
            }
            *[hidden] {
                display: none !important;
            }
            .wrapper > .content {
                width: 85%;
                padding: 0px 40px 40px 40px;
                position: relative;
                bottom: 30px;
            }
            .message {
                position: relative;
                bottom: 20px;
                text-align: center;
                color: var(--gray-darky-color);
            }
            .wrapper {
                display: flex;
                justify-content: center;
                align-items: center;
                height: calc(100vh - 140px);
            }
            /** PLANS **/

            .plans {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .plan {
                flex: 1;
                height: auto;
                box-shadow: 0px 5px 4px 0px rgba(0, 0, 0, 0.2);
                color: var(--blue-darkest-color);
                margin-left: 20px;
                max-width: 380px;
            }
            .plan:first-child {
                margin-left: 0;
            }
            .plan .header {
                height: 80px;
                background: var(--gray-lightern-color);
                padding: 35px;
                font-weight: 500;
            }
            .plan .header > * {
                display: inline-block;
            }

            .plan .header .price {
                font-size: 55px;
            }
            .plan .header .dollar {
                font-size: 28px;
                position: relative;
                right: 3px;
            }

            .plan .header .name {
                font-size: 28px;
                margin-left: 10px;
            }

            .plan .content {
                height: auto;
                padding: 20px 40px;
                background: var(--white-color);
            }
            .content .feature {
                font-size: 18px;
                margin-top: 10px;
            }
            .content .feature:first-child {
                margin-top: 0;
            }

            .feature span {
                font-weight: 500;
            }

            .button-set {
                margin-top: 20px;
                text-align: center;
            }
            /** Card **/
            .card {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .card designmap-pay {
                max-width: 680px;
            }



        </style>
        <designmap-dashboard back back-url="[[_computeBackUrl(projectId)]]">
            <div class="title">
                <i18-n msgid="Activate premium"></i18-n>
            </div>
        </designmap-dashboard>
        <designmap-confirm id="downgradeConfirm" message="Are you sure that you want to downgrade to startup plan. It is free but you won't be able to manage projects exceed your plan possibilities.">

        </designmap-confirm>
        <div class="wrapper">
            <div class="content">
                <!--<iron-icon icon="designmap-showcase:premium"></iron-icon>
                <div class="message">
                    <i18-n msgid="We are working">We are working</i18-n>
                </div>
                <button hidden$="[[quicker]]" style="margin-top: 0" on-click="speedUp" is="designmap-button" blue thin>
                    <i18-n msgid="Speed up">Speed up</i18-n>
                </button>-->
                <!-- Plans -->
                <div class="plans" hidden$="[[cardMode]]">
                    <template is="dom-repeat" items="[[plans]]" as="plan">
                        <div class="plan">
                            <div class="header">
                                <div class="price">[[plan.price]]</div><span class="dollar">$/mo.</span>
                                <div class="name">[[plan.name]]</div>
                            </div>
                            <div class="content">
                                <div class="features">
                                    <div class="feature">
                                        <i18-n msgid="up to">up to</i18-n>
                                        <span>[[plan.teamMembers]]</span>
                                        <i18-n msgid="team members">team members</i18-n>
                                    </div>
                                    <div class="feature">
                                        <span>[[_countDataSpace(plan.storage)]]</span>
                                        <i18-n msgid="storage">storage</i18-n>
                                    </div>
                                    <template is="dom-repeat" items="[[plan.features]]" as="feature">
                                        <div class="feature">
                                            <i18-n msgid="[[feature]]">[[feature]]</i18-n>
                                        </div>
                                    </template>
                                </div>
                                <div class="button-set">
                                    <button on-click="selectPlan" disabled="[[_disableButton(user.plan,plan.name)]]" is="designmap-button" blue fit class="button">
                                        [[_buttonTitle(user.plan,plan.name,language,i18Loaded)]]
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                <!-- Card -->
                <div class="card" hidden$="[[!cardMode]]">
                    <designmap-pay plan="[[chosenPlan]]"></designmap-pay>

                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'designmap-activate',
            behaviors: [
                ReduxBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignMapUtilsBehavior
            ],
            properties: {
                quicker: {
                    type: Boolean,
                    value: false
                },
                projectId: {
                    type: String,
                    statePath: 'projectId'
                },
                user: {
                    type: Object,
                    statePath: 'user'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                i18Loaded: {
                    type: Boolean,
                    statePath: 'i18Loaded'
                },
                cardMode: {
                    type: Boolean,
                    value:false
                },
                chosenPlan: {
                    type: Object
                },
                plans: {
                    type: Array,
                    value: [
                        {
                            name:'startup',
                            teamMembers: 2,
                            storage: 500,
                            price: 0,
                            months: 3,
                            features: [
                                '3 projects',
                                'self support'
                            ]
                        },
                        {
                            name:'agency',
                            teamMembers: 5,
                            months: 3,
                            storage: 5000,
                            price: 15,
                            features: [
                                'unlimited projects',
                                'premium support'
                            ]
                        },
                        {
                            name:'enterprise',
                            teamMembers: 10,
                            storage: 10000,
                            price: 30,
                            months: 3,
                            features: [
                                'unlimited projects',
                                'premium support'
                            ]
                        }
                    ]
                }
            },
            listeners: {
                'back':'back'
            },
            ready: function(){
               //this.quicker = localStorage.getItem('designmap:quicker');
                TCO.loadPubKey('sandbox');
            },
            speedUp: function(){
                this.showMessage('Thank you! We will try to do it quicker!');
                //this.quicker = true;
                //localStorage.setItem('designmap:quicker',true);
                this.reachGoal('premium_speed_up','approve');
            },
            _computeBackUrl: function(projectId){
                return '/'+(projectId||'');
            },
            _countDataSpace: function(storage){
                return storage<1000 ? storage +' MB' : storage/1000+ ' GB';
            },
            _disableButton: function(plan,name){
                return plan.name==name && new Date(plan.expired)>new Date();
            },
            _getCodeName: function(plan,name){
                if(name=='startup' && plan.name!='startup') return 'Downgrade';
                if(plan.name==name) return 'Current';
                const currentDate = new Date();
                if(new Date(plan.expired)<currentDate.setDate(currentDate.getDate()+7)) return 'Update';
                return 'Upgrade now';
            },
            _buttonTitle: function(plan,name,lng,loaded){
               return this.translate(this._getCodeName(plan,name));
            },
            selectPlan: function(e){
                const currentDate = new Date();
                if(this.user.plan.name==e.model.plan.name && new Date(this.user.plan.expired)>currentDate.setDate(currentDate.getDate()+7)) return this.showMessage('You can update your plan not early than 7 days of its expiration.');
                if(e.model.plan=='startup') return this.openDowngradeConfirm();
                this.chosenPlan = e.model.plan;
                this.cardMode = true;
            },
            openDowngradeConfirm: function(){
                this.$.downgradeConfirm.open();
            },
            back: function(){
                this.cardMode = false;
            }
        })
    </script>
</dom-module>
