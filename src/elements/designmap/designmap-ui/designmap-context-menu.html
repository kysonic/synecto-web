<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-dropdown/iron-dropdown.html">

<dom-module id="designmap-context-menu">
    <template>
        <style>
            :host {
                --dropdown-color: var(--blue-darkest-color);
                --dropdown-line-color: var(--blue-darkester-color);
            }
            iron-dropdown {
                z-index: 10 !important;
            }
            /** IRON-DROPDOWN **/
            .dropdown-content {
                position: relative;
                background: var(--dropdown-color);
                @apply(--designmap-context-menu-content-mixin);
                overflow: visible !important;
            }
            /** LINE **/
            .line {
                height: 10px;
                width: 100%;
                background: var(--dropdown-line-color);
            }
            /** Paper-input **/
            --paper-input-container-input: {
                font-size: 14px !important;
            }
            --paper-input-container-label: {
                font-size: 14px !important;
            }
        </style>
        <iron-dropdown id="dd" position-target="[[target]]" close-animation-config="[[defaultCloseAnimation]]"
                       open-animation-config="[[defaultOpenAnimation]]">
            <div class="dropdown-content">
                <div class="line"></div>
                <div class="content">
                    <content></content>
                </div>
            </div>
        </iron-dropdown>
    </template>
    <script>
        Polymer({
            is: 'designmap-context-menu',
            behaviors: [
                Polymer.DesignmapAnimationSet
            ],
            properties: {
                /**
                 * Element which will be target to
                 * position context
                 */
                target: Object,
                /**
                 * If set true - get parent node like a target
                 */
                parent: {
                    type: Boolean,
                    value: false
                },
                previous: {
                    type: Boolean,
                    value: false
                },
                width: Number,
                animationOn: {
                    type: Boolean,
                    value: true
                },
                absolute: {
                    type: Boolean,
                    value: false
                }
            },
            listeners: {
                'iron-overlay-opened': 'afterOpened',
                'iron-overlay-closed': 'afterClosed'
            },
            attached: function () {
                if (this.parent) {
                    this.target = this.parentNode;
                }
                if (this.previous) {
                    this.target = this.previousElementSibling;
                }
            },
            /**
             * Open dropdown and create reposition of it.
             * @param e
             */
            toggle: function (e) {
                this.isAnimating = true;
                this.$.dd.toggle();
                if (this.$.dd.opened) this.stickToMouse(e);
            },
            /**
             * Open dropdown and create reposition of it.
             * @param e
             */
            open: function (e) {
                this.isAnimating = true;
                this.fire('open');
                this.$.dd.open();
                this.stickToMouse(e);
            },
            /**
             * Close dropdown
             */
            close: function () {
                this.isAnimating = true;
                this.fire('close');
                this.$.dd.close();
            },
            /**
             * Follow a mouse relative cords.
             * @param e
             */
            stickToMouse: function (e) {
                this.async(this.absolute ? this.absoluteStick.bind(this, e) : this.targetStick.bind(this, e));
            },
            /**
             * Stick mouse to target
             */
            targetStick: function (e) {
                var menuRect = this.$.dd.getBoundingClientRect();
                var menuWidth = this.width || menuRect.width;
                var cords = this.getCords(e);
                this.$.dd.horizontalOffset = menuWidth + e.pageX < window.innerWidth ? cords.x : cords.x - menuWidth;
                this.$.dd.verticalOffset = menuRect.height + e.pageY < window.innerHeight ? cords.y : cords.y - menuRect.height;
                this.$.dd.refit();
            },
            /**
             * Stick mouse to mouse absolutely
             */
            absoluteStick: function (e) {
                this.$.dd.horizontalOffset = e.layerX;
                this.$.dd.verticalOffset = e.layerY;
                this.$.dd.refit();
            },
            /**
             * Get relative to some object cords.
             * @param e
             * @returns {{x: number, y: number}}
             */
            getCords: function (e) {
                var rect = this.target.getBoundingClientRect();
                return {x: e.clientX - rect.left, y: e.clientY - rect.top};
            },
            /**
             * Drop is animation after opening
             */
            afterOpened: function () {
                this.isAnimating = false;
            },
            /**
             * Drop is animation after closing
             */
            afterClosed: function () {
                this.isAnimating = false;
            }
        })
    </script>
</dom-module>
