<script>
    /**
     * Helpers
     * @type {{parents: Function}}
     */
    Polymer.DesignMapUtilsBehavior = {
        cleanTextRegexp: /<\/?[^>]+(>|$)/g,
        UIDREGEXP: /[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}-/i,
        IMAGE_REGEXP: /images/,
        shareRegexp: /share/,
        /**
         * Find parent node
         * @param node - DOM node
         * @param acin - attribute,class,id or tagName
         */
        parents: function(node,acin) {
            if (!node) return false;
            var found = null;
            while(node && node.tagName && node.tagName.toLowerCase() !== 'body') {
                if (node.getAttribute(acin) || node.classList.contains(acin) || node.id == acin || node.tagName == acin) found = node;
                node = node.parentNode;
            }
            return found;
        },
        /**
         * Capitalize first letter of string.
         * @param string - String
         * @returns {string}
         */
        capitalizeFirstLetter: function (string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        },
        /**
         * Additional function allowing to
         * create unique id for
         * @param len - length
         * @returns {string}
         */
        generateUid: function (len) {
            len = len || 7;
            return Math.random().toString(35).substr(2, len).replace(/\d+/, '');
        },
        /**
         * Extra function allowing parse query.
         * @returns {{}}
         */
        parseQuery: function () {
            if (!/\?/.test(window.location.href)) return {};
            var query = window.location.href.split('?')[1].split('&');
            var o = {};
            query.forEach(function (e) {
                var s = e.split('=');
                o[s[0]] = s[1];
            }, this);
            return o;
        },
        /**
         * Work with special expressions into links
         * @param str - string
         * @param replacement - object containing expressions for replacement
         * @returns {*}
         */
        replacer: function (str, replacement) {
            for (var expression in replacement) {
                var value = replacement[expression];
                str = str.replace(expression, value);
            }
            return str;
        },
        /**
         * Object to query string
         * @param o
         * @returns {string}
         */
        objectToQueryString: function (o) {
            var qs = '?';
            for (var p in o) {
                qs += p + '=' + o[p] + '&';
            }
            return qs.substr(0, qs.length - 1);
        },
        /**
         * Select text
         * @param element
         */
        selectText: function (element) {
            var doc = document
                , text = element
                , range, selection
                ;
            if (doc.body.createTextRange) {
                range = document.body.createTextRange();
                range.moveToElementText(text);
                range.select();
            } else if (window.getSelection) {
                selection = window.getSelection();
                range = document.createRange();
                range.selectNodeContents(text);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        },
        /**
         * Compute sticker owner's name.
         */
        computeOwnerName: function(owner){
            if(!owner) return 'xxx';
            return owner.name&&owner.lastName?owner.name+ ' '+ owner.lastName:owner.name?owner.name: owner.login? owner.login : owner.local&&owner.local.email?owner.local.email: 'xxx';
        },
        /**
         * Remove folder name from appearance of file.
         */
        cutFileName: function(file){
            if(!file.data.name || (!file.folder && !file.task)) return;
            return file.data.name.replace((file.folder||file.task)+'-','');
        },
        /**
         * Compute user name
         */
        computeUserName: function(user){
            if(typeof user == 'string' || !user) return '...';
            return user?user.name&&user.lastName?user.name[0]+user.lastName[0]:user.local?user.local.email[0]:'XX':'XX';
        },
        /**
         * Compute avatar possible path
         * If it is from server - go there
         * Otherwise just go to local url
         */
        computeAvatarPath: function(path){
            if(!path) return '';
            if(this.IMAGE_REGEXP.test(path)) return path+'?v='+this.generateUid();
            return Designmap.config.apiURL+path+'?v='+this.generateUid();
        },
        /**
         * Upload file
         * @param url
         */
        quickUpload: function(url){
            window.open(url,'Download');
        },
        /**
         * Find user by id
         */
        findUserById: function(id){
            return new Promise(function(resolve,reject){
                if(!this.users) return false;
                var found = null;
                this.users.forEach(function(user){
                    if(user._id==id) found = user;
                });
                if(!found) return this.dispatch('getUsers',id).then(function(response){
                    resolve(response.users[0]);
                })
                return resolve(found);
            }.bind(this));
        },
        /**
         * Format date via moment.js
         * @param date
         * @returns {*}
         */
        formatDate: function(date) {
            return moment(date).format('YYYY/MM/DD');
        },
        /**
         * Strip tags from string
         * @param text
         * @returns {Context|*|string|XML|void}
         */
        stripTags: function(text) {
            return text.replace(this.cleanTextRegexp,'');
        },
        /**
         * Language hook
         */
        lng: function(){
            var lng = this.language;
            this.language = 'x';
            this.language = lng;
        },
        /**
         * Compute state of animation
         */
        computeAnimationState: function(animationName,animationOn){
            return animationOn?animationName:'none';
        },
        /**
         * Redirect on element using projects or share id
         */
        redirect: function(where){
            var tree = ReduxStore.getState();
            if(!tree.selectedProjectID && !tree.shareID) return page.redirect('/');
            page.redirect((tree.shareID?'/share/':'/')+(tree.selectedProjectID||'')+where);
            if(where=='/') page.redirect('#/');
        },
        /**
         * Get url of the app
         * @returns {string}
         */
        getAppUrl: function(){
            return location.protocol+'//'+location.host+'/';
        },
        /**
         * Get element name
         */
        getElementName: function(element){
            if(!Object.keys(element).length) return '';
            return  element.name || element.data.name.replace(element.folder+'-','').replace(this.UIDREGEXP,'');
        }
    }
</script>
