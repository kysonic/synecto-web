<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- APP -->
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<!-- Iron -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<!-- Components -->
<link rel="import" href="../bower_components/i18-n/i18-n-domain.html">
<link rel="import" href="elements/designmap/designmap-login/designmap-user-menu.html">
<link rel="import" href="elements/designmap/designmap-icons/designmap-logo-icons.html">
<!-- Configs -->
<link rel="import" href="config/designmap-app-config.html">
<!-- Styles -->
<link rel="import" href="styles/app-theme.html">
<link rel="import" href="styles/shared-styles.html">
<!-- Redux -->
<link rel="import" href="redux/redux-store.html">
<link rel="import" href="redux/actions/combine-actions.html">
<link rel="import" href="redux/actions/user-actions.html">
<link rel="import" href="redux/actions/router-data-actions.html">
<!-- Behaviors -->
<link rel="import" href="behaviors/designmap-messages-behavior.html">

<dom-module id="designmap-app">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            app-header {
                color: #fff;
                background-color: var(--gray-lightern-color);
                height: var(--header-height);
            }

            app-header[hidden] {
                display: none !important;
            }

            app-drawer {
                border-right: 1px solid var(--gray-color);
                --app-drawer-width: var(--sidebar-width);
            }

            app-drawer app-toolbar {
                background-color: var(--blue-lighty-color);
                height: var(--header-height);
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            app-drawer app-toolbar a {
                display: inherit;
                width: 100%;
            }
        </style>

        <!-- Router -->
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
        <!-- Router -->

        <!-- i18-n -->
        <i18-n-domain id="i18nDomain" locale="[[language]]" messages-url="/locales"></i18-n-domain>
        <!-- i18-n -->

        <app-drawer-layout fullbleed>
            <!-- Drawer content -->
            <app-drawer id="drawer">
                <app-toolbar>
                    <a href="/">
                        <iron-icon class="designmap-logo" icon="designmap-logo:logo"></iron-icon>
                    </a>
                </app-toolbar>
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">

                </iron-selector>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header id="header" condenses reveals effects="waterfall">
                    <app-toolbar>
                        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
                        <designmap-user-menu></designmap-user-menu>
                    </app-toolbar>
                </app-header>

                <iron-pages
                        selected="[[page]]"
                        attr-for-selected="name"
                        fallback-selection="designmap-404"
                        role="main">
                    <designmap-fs-view name="fs"></designmap-fs-view>
                    <designmap-settings-view name="settings"></designmap-settings-view>
                    <designmap-gallery-view name="gallery"></designmap-gallery-view>
                    <designmap-login-view name="login"></designmap-login-view>
                    <designmap-404 name="404"></designmap-404>
                </iron-pages>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        // Defaults
        const HOME_VIEW = 'fs';
        const LOGIN_VIEW = 'login';
        // Routes
        const SHOULD_AUTH_ROUTES = ['fs', 'settings'];
        Polymer({
            is: 'designmap-app',
            behaviors: [
                ReduxBehavior,
                Polymer.CombineActions(Polymer.RouterDataActions, Polymer.UserActions),
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapMessagesBehavior
            ],
            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged',
                },
                user: {
                    type: Object,
                    statePath: 'user',
                    observer: '_userChanged'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.language)'
                }
            },

            observers: [
                '_routePageChanged(routeData.page)',
            ],

            ready: function () {
                // Get possible current user
                this.dispatch('getCurrentUser')
                // Update languages
                this.$.i18nDomain.addEventListener('i18-n-locale-ready', function () {
                    ReduxStore.dispatch({type: "UPDATE_I18_LOADED", i18Loaded: true});
                });
            },

            _routePageChanged: function (page) {
                // Set router data
                this.dispatch('setRouterData',Object.assign(this.routeData,this.subroute));
                // Back url
                this.backURL = this.backURL || page;
                // Change page
                var currentPage = page || HOME_VIEW;
                if (this.isObjectID(page)) currentPage = 'fs';
                // Check authorization
                if (!this.user && this._shodBeAuth(currentPage))  return this.page = LOGIN_VIEW;
                // Setup page
                this.page = currentPage;
                // Close drawer if so
                if (!this.$.drawer.persistent) {
                    this.$.drawer.close();
                }
            },

            _shodBeAuth: function (page) {
                return SHOULD_AUTH_ROUTES.indexOf(page) !== -1 || this.isObjectID(page);
            },

            _pageChanged: function (page) {
                // If page param is ObjectID then it is project id
                this._setLayoutState(page === LOGIN_VIEW);
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('designmap-' + page + '-view.html');
                this.importHref(resolvedPageUrl, null, this._showPage404, true);
            },

            _userChanged: function (user) {
                this._routePageChanged(this.backURL);
            },

            _showPage404: function () {
                this._setLayoutState(true);
                this.page = '404';
            },
            /**
             * Login page should be without drawer
             * and header.
             * @private
             */
            _setLayoutState: function (nude) {
                this.$.drawer.hidden = nude;
                this.$.header.hidden = nude;
                window.dispatchEvent(new Event('resize'));
            }
        });
    </script>
</dom-module>
