<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- APP -->
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<!-- Iron -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">

<!-- Components -->
<link rel="import" href="../bower_components/i18-n/i18-n-domain.html">
<link rel="import" href="../bower_components/i18-n/i18-n.html">
<link rel="import" href="elements/designmap/designmap-login/designmap-user-menu.html?20170615">
<link rel="import" href="elements/designmap/designmap-icons/designmap-logo-icons.html?20170615">
<link rel="import" href="elements/designmap/designmap-icons/designmap-workspace-icons.html?20170615">
<link rel="import" href="elements/designmap/designmap-workspace/designmap-advanced-menu.html?20170615">
<link rel="import" href="elements/designmap/designmap-workspace/designmap-header.html?20170615">
<link rel="import" href="elements/designmap/designmap-workspace/designmap-info.html?20170615">
<link rel="import" href="elements/designmap/designmap-buttons/designmap-circle-button.html?20170615">
<link rel="import" href="elements/designmap/designmap-notifications/designmap-notifier.html?20170615">
<link rel="import" href="elements/designmap/designmap-tutorial/designmap-tutorial.html?20170615">
<link rel="import" href="elements/plastic/plastic-media-query.html?20170615">
<!-- Configs -->
<link rel="import" href="config/designmap-app-config.html?20170615">
<!-- Styles -->
<link rel="import" href="styles/app-theme.html?20170615">
<link rel="import" href="styles/shared-styles.html?20170615">
<!-- Redux -->
<link rel="import" href="redux/redux-store.html?20170615">
<link rel="import" href="redux/actions/combine-actions.html?20170615">
<link rel="import" href="redux/actions/user-actions.html?20170615">
<link rel="import" href="redux/actions/project-actions.html?20170615">
<!-- Behaviors -->
<link rel="import" href="behaviors/designmap-messages-behavior.html?20170615">
<link rel="import" href="deisgnmap-routing.html?20170615">

<dom-module id="designmap-app">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            *[hidden] {
                display: none !important;
            }

            app-header {
                color: #fff;
                background-color: var(--gray-lightern-color);
                height: var(--header-height);
            }

            app-header[hidden] {
                display: none !important;
            }

            app-drawer {
                border-right: 1px solid var(--gray-color);
                --app-drawer-width: var(--sidebar-width);
            }

            app-drawer#right {
                --app-drawer-scrim-background: rgba(256, 256, 256, 0.5);
                --app-drawer-content-container: {
                    border-left: 1px solid var(--gray-color);
                }
            }

            app-drawer app-toolbar {
                background-color: var(--blue-lighty-color);
                height: var(--header-height);
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            app-drawer app-toolbar a {
                display: inherit;
                width: 100%;
            }

            designmap-info {
                height: calc(100vh - var(--header-height));
                margin-top: var(--header-height);
            }

            .loading-overlay {
                position: absolute;
                background: var(--white-color);
                width: 100%;
                height: 100%;
            }

            .beta {
                position: absolute;
                color: var(--white-color);
                font-size: 10px;
                left: 100%;
                margin-left: -46px;
            }



        </style>
        <!-- Keys -->
        <iron-a11y-keys id="a11yUndo" keys="(ctrl||cmd)+z" target="[[keysTarget]]" on-keys-pressed="undo"></iron-a11y-keys>
        <iron-a11y-keys id="a11yRedo" keys="(ctrl||cmd)+shift+z" target="[[keysTarget]]" on-keys-pressed="redo"></iron-a11y-keys>
        <!-- Query -->
        <plastic-media-query on-query-changed="_queryChanged"></plastic-media-query>
        <!-- Notifier -->
        <designmap-notifier id="notifier"></designmap-notifier>
        <!-- i18-n -->
        <i18-n-domain id="i18nDomain" locale="[[language]]" messages-url="/assets/locales"></i18-n-domain>
        <!-- Titorial -->
        <designmap-tutorial id="tutorial"></designmap-tutorial>
        <!-- Sharing dialog -->
        <paper-dialog id="sharingDialog" cancel-auto-refit entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <designmap-accesses id="accesses"></designmap-accesses>
            <!--<iron-icon dialog-dismiss class="dialog-close access" icon="icons:close"></iron-icon>-->
        </paper-dialog>
        <!-- Confirms -->
        <designmap-confirm id="removeProjectConfirm" message="AreYouSureThatYouWannaRemoveProject"
                           on-continue="removeIt" on-suspend="suspendRemoving"></designmap-confirm>

        <app-drawer-layout fullbleed responsive-width="770px">
            <!-- Drawer content -->
            <app-drawer id="drawer">
                <app-toolbar>
                    <a style="text-decoration: none" tabindex="-1" on-click="goToHome">
                        <iron-icon class="designmap-logo" tabindex="-1" icon="designmap-logo:logo"></iron-icon>
                        <span class="beta">beta v3.0</span>
                    </a>
                </app-toolbar>
                <designmap-advanced-menu id="advancedMenu" path="[[path]]" page="[[page]]"></designmap-advanced-menu>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header id="header" condenses reveals effects="waterfall">
                    <app-toolbar>
                        <designmap-header id="dmHeader"></designmap-header>
                    </app-toolbar>
                </app-header>

                <iron-pages
                        selected="[[page]]"
                        attr-for-selected="name"
                        fallback-selection="designmap-404"
                        role="main">
                    <designmap-fs-view id="fsView" name="fs"></designmap-fs-view>
                    <designmap-accesses-view id="accessesView" name="accesses"></designmap-accesses-view>
                    <designmap-task-manager-view id="taskManagerView" name="task-manager"></designmap-task-manager-view>
                    <designmap-settings-view name="settings"></designmap-settings-view>
                    <designmap-gallery-view id="galleryView" name="gallery"></designmap-gallery-view>
                    <designmap-support-view name="support"></designmap-support-view>
                    <designmap-docs-view name="docs"></designmap-docs-view>
                    <designmap-notifications-view name="notifications"></designmap-notifications-view>
                    <designmap-activate-view name="activate"></designmap-activate-view>
                    <designmap-login-view name="login"></designmap-login-view>
                    <designmap-404 name="404"></designmap-404>
                </iron-pages>
                <!-- Info -->
                <app-drawer id="right" align="end">
                    <designmap-info id="info"></designmap-info>
                </app-drawer>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        const NO_HEADER_PAGES = ['login','404','gallery'];
        Polymer({
            is: 'designmap-app',
            behaviors: [
                ReduxBehavior,
                Polymer.CombineActions(Polymer.UserActions, Polymer.ProjectActions),
                Polymer.DesignMapUtilsBehavior,
                Polymer.DesignMapMessagesBehavior,
                Polymer.DesignmapRouting
            ],
            properties: {
                loading: {
                    type: Boolean,
                    value: true
                },
                page: {
                    type: String,
                    observer: '_pageChanged'
                },
                projectId: {
                    type: String,
                    observer: '_projectIdChanged'
                },
                fileId: {
                    type: String,
                    observer: '_fileIdChanged'
                },
                path: {
                    type: String,
                    observer: '_pathChanged'
                },
                user: {
                    type: Object,
                    statePath: 'user',
                    value: undefined,
                    observer: '_userChanged'
                },
                isAuth: {
                    type: Boolean,
                    computed: '_computeIsAuth(user)',
                    observer: '_isAuthChanged'
                },
                trashMode: {
                    type: Boolean,
                    observer: '_trashModeChanged'
                },
                language: {
                    type: String,
                    computed: '_computeLanguage(user.system.language)'
                },
                keysTarget: {
                    type: Object,
                    value: function(){
                        return document.body
                    }
                }
            },

            listeners: {
                'open-info': 'openInfo',
                'close-share-dialog': 'closeShareDialog',
                'open-menu': 'openMenu',
                'open-create-project-dialog': 'openCreateProjectDialog',
                'open-select-project-dialog': 'openSelectProjectDialog',
                'close-menu': 'closeMenu',
                'open-sharing':'_openSharing',
                'open-project-remove':'_openProjectRemoveConfirm'
            },


            ready: function () {
                this.uid = Designmap.uid = this.generateUid();
                // Get possible current user
                this.dispatch('getCurrentUser').then(function(){
                    document.getElementById('appLoading').style.display = 'none';
                }.bind(this));
                // Update languages
                this.$.i18nDomain.addEventListener('i18-n-locale-ready', function () {
                    ReduxStore.dispatch({type: "UPDATE_I18_LOADED", i18Loaded: true});
                });
            },

            _pageChanged: function (page) {
                this._setLayoutState(NO_HEADER_PAGES.indexOf(page)!==-1);
                // Load page import on demand. Show 404 page if fails
                const resolvedPageUrl = this.resolveUrl('./views/designmap-' + page + '-view.html');
                document.getElementById('appLoading').style.display = 'flex';
                this.importHref(resolvedPageUrl, function(){
                    document.getElementById('appLoading').style.display = 'none';
                }, this._showPage404, true);
            },

            _projectIdChanged: function (projectId) {
                if(!projectId) return;
                this.dispatch('updateProjectId', projectId);
            },

            _pathChanged: function (path) {
                this.dispatch('updatePath', path);
            },

            _fileIdChanged: function (fileId) {
                this.dispatch('updateFileId', fileId);
            },

            _trashModeChanged: function (trashMode) {
                this.dispatch('updateTrashMode', trashMode);
            },

            _queryChanged: function(e){
                this.dispatch('updateMQ', e.detail);
            },

            _userChanged: function (user) {
                page.redirect(this.previousPath);
            },

            _isAuthChanged: function(isAuth){
                if(isAuth) this.dispatch('getProjects');
            },

            _showPage404: function () {
                this.page = '404';
            },
            /**
             * Login page should be without drawer
             * and header.
             * @private
             */
            _setLayoutState: function (nude) {
                this.$.drawer.hidden = nude;
                this.$.header.hidden = nude;
                window.dispatchEvent(new Event('resize'));
            },

            _computeIsAuth: function(user){
                 return user && user._id;
            },

            openInfo: function () {
                this.$.right.open();
            },

            openMenu: function () {
                this.$.drawer.open();
            },

            closeMenu: function () {
                this.$.drawer.close();
            },

            goToHome: function(){
                page.redirect('/'+(this.projectId?this.projectId:''))
            },

            undo: function(){
                Designmap.undoManager.undo();
            },

            redo: function(){
                Designmap.undoManager.redo();
            },

            _openProjectRemoveConfirm: function(){
                this.$.removeProjectConfirm.open();
            },

            /**
             * Cancel project removing
             */
            suspendRemoving: function () {
                this.$.removeProjectConfirm.close();
            },

            closeShareDialog: function(){
                this.$.sharingDialog.close();
            },

            _openSharing: function(){
                this.$.sharingDialog.open();
                this.async(function(){
                    this.$.sharingDialog.refit();
                },50);
            },

            openCreateProjectDialog: function(){
                if(this.$.dmHeader) this.$.dmHeader.openProjectMenu();
            },

            openSelectProjectDialog: function(){
                if(this.$.dmHeader) this.$.dmHeader.openProjectList();
            }
        });
    </script>
</dom-module>
