<script>
    Polymer.ProjectActions = {
        actions: {
            getProject: function (id) {
                return function (dispatch) {
                    const promise = xhr.get(Designmap.config.apiURL + 'project/' + id);
                    promise.then(function (response) {
                        if (!response.success) return;
                        dispatch({type: 'SET_PROJECT_STATE', project: response.project});
                    });
                    return promise;
                }
            },
            getProjects: function () {
                return function (dispatch) {
                    const promise = xhr.get(Designmap.config.apiURL + 'project/?list=true');
                    promise.then(function (response) {
                        if (!response.success) return;
                        dispatch({type: 'SET_PROJECTS', projects: response.projects});
                        //dispatch({type: 'SET_SHARED_PROJECTS', sharedProjects: response.shared});
                    });
                    return promise;
                }
            },
            cleanProjects: function () {
                return {
                    type: 'CLEAN_PROJECTS'
                }
            },
            cleanSharedProjects: function(){
                return {
                    type: 'CLEAN_SHARED_PROJECTS'
                }
            },
            createProject: function (data) {
                return function (dispatch) {
                    const promise = xhr.post(Designmap.config.apiURL + 'project', data);
                    promise.then(function (response) {
                        if (!response.success) return;
                        dispatch({type: 'ADD_PROJECT', data: response.project});
                        const app = document.querySelector('designmap-app');
                        app.set('route.path','/'+response.project._id)
                    });
                    return promise;
                }
            },
            removeProject: function (id) {
                return function (dispatch) {
                    const promise = xhr.delete(Designmap.config.apiURL + 'project/' + id);
                    promise.then(function (response) {
                        if (!response.success) return;
                        dispatch({type: 'REMOVE_PROJECT', index: this.findProjectIndexByID(id)});
                        this.dispatch('userUpdate', {lastOpenedProject: null});
                    }.bind(this));
                    return promise;
                }.bind(this)
            },
            updateProject: function (id, data) {
                return function (dispatch) {
                    const promise = xhr.put(Designmap.config.apiURL + 'project/' + id, data);
                    promise.then(function (response) {
                        if (!response.success) return;
                        dispatch({type: 'UPDATE_PROJECT', index: this.findProjectIndexByID(id), data: response.project});
                        if(this.project && this.project._id==id) dispatch({type:'UPDATE_PROJECT_STATE',data:data})
                    }.bind(this));
                    return promise;
                }.bind(this)
            },
            setProjectState: function (project) {
                return {
                    type: 'SET_PROJECT_STATE',
                    project: project
                }
            },
            cleanProjectState: function () {
                return {
                    type: 'SET_PROJECT_STATE',
                    project: null
                }
            },
            updateProjectState: function (data) {
                return {
                    type: 'UPDATE_PROJECT_STATE',
                    data: data
                }
            }
        }
    }
</script>
