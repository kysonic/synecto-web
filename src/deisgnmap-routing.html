
<script>
    /**
     * Route like a boss
     */
    Polymer.DesignmapRouting = {
        ready: function(){
            page('*', function(ctx, next) {
                this.firstHash = this.firstHash || ctx.hash;
                this.hash = ctx.hash;
                this.previousPath = ctx.path;
                // Common for all routes
                next();
            }.bind(this));

            page('/', this._isAuth.bind(this), function(ctx,next){
                this.projectId = null;
                this.path = '/';
                this.trashMode = false;
                this.page = 'fs';
            }.bind(this));

            page('/gallery/:id', function(ctx,next){
                this.page = 'gallery';
                this.fileId = ctx.params.id;
            }.bind(this));

            page('/settings', this._isAuth.bind(this), function(ctx,next){
                this.page = 'settings';
                this.path = 'profile';
            }.bind(this));

            page('/notifications', this._isAuth.bind(this), function(ctx,next){
                this.page = 'notifications';
            }.bind(this));

            page('/support', this._isAuth.bind(this), function(ctx,next){
                this.page = 'support';
            }.bind(this));

            page('/activate', this._isAuth.bind(this), function(ctx,next){
                this.page = 'activate';
            }.bind(this));

            page('/support/docs', this._isAuth.bind(this), function(ctx,next){
                this.page = 'docs';
            }.bind(this));

            page('/support/form', this._isAuth.bind(this), function(ctx,next){
                this.page = 'support-form';
            }.bind(this));

            page('/settings/profile', this._isAuth.bind(this), function(ctx,next){
                this.page = 'settings';
                this.path = 'profile';
            }.bind(this));

            page('/settings/account', this._isAuth.bind(this), function(ctx,next){
                this.page = 'settings';
                this.path = 'account';
            }.bind(this));

            page('/settings/config', this._isAuth.bind(this), function(ctx,next){
                this.page = 'settings';
                this.path = 'config';
            }.bind(this));

            page('/:id', this._isAuth.bind(this), function(ctx,next){
                if(!this.isObjectID(ctx.params.id)) return next();
                this.projectId = ctx.params.id;
                this.path = '/';
                this.trashMode = false;
                this.page = 'fs';
            }.bind(this));

            page('/:id/trash', this._isAuth.bind(this), function(ctx,next){
                if(!this.isObjectID(ctx.params.id)) return next();
                this.projectId = ctx.params.id;
                this.path = '/';
                this.trashMode = true;
                this.page = 'fs';
            }.bind(this));

            page('/:id/task-manager', this._isAuth.bind(this), function(ctx,next){
                if(!this.isObjectID(ctx.params.id)) return next();
                this.projectId = ctx.params.id;
                this.page = 'task-manager';
                this.path = '/';
            }.bind(this));

            page('/:id/accesses', this._isAuth.bind(this), function(ctx,next){
                if(!this.isObjectID(ctx.params.id)) return next();
                this.projectId = ctx.params.id;
                this.page = 'accesses';
                this.path = '/';
            }.bind(this));

            page('/:id/chat', this._isAuth.bind(this), function(ctx,next){
                if(!this.isObjectID(ctx.params.id)) return next();
                this.projectId = ctx.params.id;
                this.page = 'chat';
                this.path = '/';
            }.bind(this));

            page(/^\/(.*?)\/task-manager\/(.*)/, this._isAuth.bind(this), function(ctx,next){
                const id = ctx.params[0];
                if(!this.isObjectID(id)) return next();
                this.projectId = id;
                this.page = 'task-manager';
                this.path = '/'+ctx.params[1];
            }.bind(this));

            page(/^\/(.*?)\/(.*)/, this._isAuth.bind(this), function(ctx,next){
                const id = ctx.params[0];
                if(!this.isObjectID(id)) return next();
                this.projectId = id;
                this.path = '/'+ctx.params[1];
                this.trashMode = false;
                this.page = 'fs';
            }.bind(this));

            // 404
            page('*', function() {
                this.page = '404';
            }.bind(this));

            // add #! before urls
            page({
                hashbang: false
            });
        },
        _isAuth(ctx,next){
            if(!this.user) return this.page = 'login';
            next();
        }
    }
</script>
